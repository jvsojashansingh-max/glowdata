<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Book - Complete Accounting</title>

    <!-- Premium Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK -->
    <script>
        (function () {
            function safeDefine(name, fn) {
                if (typeof window[name] !== 'function') {
                    window[name] = fn;
                }
            }
            safeDefine('switchMainTab', function (tabId, btn) {
                try {
                    document.querySelectorAll('.tab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(tabId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('.sidebar .menu-item').forEach(function (mi) { mi.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activeMainTab', tabId); } catch (e) { }

                    // Trigger render functions for specific tabs
                    if (tabId === 'production-entry' && typeof renderProductionEntryTab === 'function') {
                        renderProductionEntryTab();
                    } else if (tabId === 'packing' && typeof renderPackingTab === 'function') {
                        renderPackingTab();
                    } else if (tabId === 'inventory' && typeof renderInventoryTab === 'function') {
                        renderInventoryTab();
                    } else if (tabId === 'size-control' && typeof renderSizeControlTab === 'function') {
                        renderSizeControlTab();
                    }
                } catch (e) { alert('Error: ' + e); }
            });
            safeDefine('switchSalesSubtab', function (subId, btn) {
                try {
                    document.querySelectorAll('#sales .subtab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(subId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('#sales .subtab-btn').forEach(function (b) { b.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activeSalesSubtab', subId); } catch (e) { }
                } catch (e) { alert('Error: ' + e); }
            });
            safeDefine('switchPurchaseSubtab', function (subId, btn) {
                try {
                    document.querySelectorAll('#purchase .subtab-content').forEach(function (el) { el.classList.remove('active'); });
                    var el = document.getElementById(subId);
                    if (el) el.classList.add('active');
                    document.querySelectorAll('#purchase .subtab-btn').forEach(function (b) { b.classList.remove('active'); });
                    if (btn && btn.classList) btn.classList.add('active');
                    try { localStorage.setItem('activePurchaseSubtab', subId); } catch (e) { }
                } catch (e) { alert('Error: ' + e); }
            });
        })();
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === PREMIUM CORE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #d4af37 0%, #f4e5a1 50%, #d4af37 100%);
            --secondary-gradient: linear-gradient(135deg, #8b0000 0%, #dc143c 50%, #ff4500 100%);
            --accent-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #2d2d2d 100%);
            --dark-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            --gold-gradient: linear-gradient(135deg, #c9a227 0%, #ffd700 25%, #ffed4e 50%, #ffd700 75%, #c9a227 100%);
            --crimson-gradient: linear-gradient(135deg, #660000 0%, #b22222 50%, #dc143c 100%);
            --platinum-gradient: linear-gradient(135deg, #e5e4e2 0%, #ffffff 50%, #e5e4e2 100%);
            --surface-white: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.95);
            --surface-dark: #0f0f0f;
            --text-primary: #0a0a0a;
            --text-secondary: #4a4a4a;
            --text-light: #8a8a8a;
            --text-gold: #d4af37;
            --text-crimson: #dc143c;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.25);
            --shadow-gold: 0 8px 32px rgba(212, 175, 55, 0.4);
            --shadow-crimson: 0 8px 32px rgba(220, 20, 60, 0.4);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: var(--text-primary);
            line-height: 1.7;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(220, 20, 60, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(212, 175, 55, 0.03) 2px, rgba(212, 175, 55, 0.03) 4px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Premium Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-gradient);
            color: #ffffff;
            padding: 32px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl), inset 0 0 80px rgba(212, 175, 55, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            border-right: 3px solid rgba(212, 175, 55, 0.3);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(180deg, rgba(212, 175, 55, 0.15) 0%, transparent 50%),
                linear-gradient(0deg, rgba(220, 20, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .sidebar h1 {
            font-size: 26px;
            margin-bottom: 40px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding-bottom: 16px;
            letter-spacing: 1.5px;
            font-weight: 900;
            position: relative;
            z-index: 1;
            border-bottom: 3px solid;
            border-image: var(--gold-gradient) 1;
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            animation: shimmerGold 3s infinite;
        }

        @keyframes shimmerGold {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3);
            }
        }

        .sidebar button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 16px 20px;
            margin: 6px 0;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid transparent;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .sidebar button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.2) 0%, rgba(255, 215, 0, 0.3) 100%);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .sidebar button:hover {
            color: #ffd700;
            transform: translateX(8px);
            border-color: rgba(212, 175, 55, 0.5);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .sidebar button:hover::before {
            width: 100%;
        }

        .sidebar button.active {
            background: var(--gold-gradient);
            color: #000000;
            font-weight: 900;
            box-shadow: var(--shadow-gold);
            border-color: rgba(212, 175, 55, 0.6);
            transform: translateX(4px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sidebar button.active::before {
            width: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(212, 175, 55, 0.2) 100%);
        }

        /* Premium Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 245, 245, 0.98) 100%);
            position: relative;
            box-shadow: inset 0 0 100px rgba(212, 175, 55, 0.08);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Premium Typography */
        h2 {
            font-size: 36px;
            margin-bottom: 32px;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            letter-spacing: 1px;
            position: relative;
            display: inline-block;
            text-transform: uppercase;
            text-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            animation: shimmerGold 3s infinite;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 80px;
            height: 5px;
            background: var(--gold-gradient);
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
        }

        h3 {
            font-size: 22px;
            margin: 32px 0 16px 0;
            background: var(--crimson-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            padding-left: 16px;
            border-left: 5px solid;
            border-image: var(--crimson-gradient) 1;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Premium Form Elements */
        input,
        select,
        textarea {
            padding: 14px 16px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: var(--border-radius-md);
            font-size: 15px;
            margin: 6px 0;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--surface-white);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: var(--shadow-sm), inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #d4af37;
            outline: none;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2), var(--shadow-gold);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--text-light);
            font-weight: 500;
            font-style: italic;
        }

        /* Premium Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        button {
            padding: 16px 32px;
            background: var(--gold-gradient);
            color: #000000;
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 15px;
            font-weight: 900;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-gold);
            position: relative;
            overflow: hidden;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            transition: left 0.6s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.6);
            border-color: rgba(255, 215, 0, 0.8);
        }

        button:active {
            transform: translateY(-1px) scale(1);
            box-shadow: var(--shadow-gold);
        }

        button.danger {
            background: var(--crimson-gradient);
            color: white;
            border-color: rgba(220, 20, 60, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button.danger:hover {
            box-shadow: var(--shadow-crimson);
            border-color: rgba(220, 20, 60, 0.8);
        }

        button.success {
            background: linear-gradient(135deg, #0f7c0f 0%, #15a515 50%, #0f7c0f 100%);
            color: white;
            border-color: rgba(21, 165, 21, 0.4);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button.success:hover {
            box-shadow: 0 12px 40px rgba(21, 165, 21, 0.5);
            border-color: rgba(21, 165, 21, 0.8);
        }

        /* Premium Subtabs */
        .subtabs {
            display: flex;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border-radius: var(--border-radius-lg);
            padding: 10px;
            margin-bottom: 32px;
            gap: 10px;
            box-shadow: var(--shadow-xl);
            border: 3px solid rgba(212, 175, 55, 0.4);
        }

        .subtab-btn {
            padding: 14px 28px;
            background: transparent;
            border: 2px solid rgba(212, 175, 55, 0.2);
            cursor: pointer;
            color: rgba(212, 175, 55, 0.7);
            font-weight: 800;
            border-radius: var(--border-radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            position: relative;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        .subtab-btn:hover {
            color: #ffd700;
            background: rgba(212, 175, 55, 0.15);
            transform: translateY(-2px);
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .subtab-btn.active {
            background: var(--gold-gradient);
            color: #000000;
            box-shadow: var(--shadow-gold);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        .subtab-content {
            display: none;
            padding-top: 24px;
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .subtab-content.active {
            display: block;
        }

        /* Premium Tables & Grids */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 24px 0;
            background: var(--surface-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 3px solid rgba(212, 175, 55, 0.3);
        }

        table th {
            background: var(--dark-gradient);
            color: #ffd700;
            padding: 20px 24px;
            text-align: left;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 4px solid;
            border-image: var(--gold-gradient) 1;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }

        table td {
            padding: 18px 24px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.15);
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .line-items-table {
            overflow: visible;
            /* Allow size dropdowns to render outside the table */
            position: relative;
            z-index: 2;
            /* Keep dropdowns above nearby buttons */
        }

        .line-items-table tbody,
        .line-items-table tr {
            overflow: visible;
            position: relative;
        }

        .line-items-table .autocomplete-dropdown {
            z-index: 10000;
            /* Layer above table backgrounds and action buttons */
            pointer-events: auto;
        }

        .line-items-table td {
            position: relative;
            /* Ensure positioned stacking roots for dropdown */
            overflow: visible;
        }

        .line-items-table .autocomplete-wrapper {
            position: relative;
            z-index: 5;
        }

        table tr:last-child td {
            border-bottom: none;
        }

        table tr:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.08) 0%, rgba(220, 20, 60, 0.05) 100%);
            transform: scale(1.005);
            box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.1);
        }

        table tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
        }

        table tbody tr:hover {
            border-left-color: rgba(212, 175, 55, 0.5);
        }

        /* Premium Utility Layout */
        .form-row {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 220px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }

        .totals-box {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            padding: 40px;
            border-radius: var(--border-radius-lg);
            margin: 32px 0;
            display: flex;
            justify-content: flex-end;
            gap: 60px;
            box-shadow: var(--shadow-xl), inset 0 0 100px rgba(212, 175, 55, 0.15);
            border: 4px solid;
            border-image: var(--gold-gradient) 1;
            position: relative;
            overflow: hidden;
        }

        .totals-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 8px;
            height: 100%;
            background: var(--crimson-gradient);
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.6);
        }

        .total-item {
            text-align: right;
            padding: 16px 20px;
            border-radius: var(--border-radius-md);
            transition: all 0.3s ease;
            border: 2px solid rgba(212, 175, 55, 0.2);
        }

        .total-item:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-4px) scale(1.05);
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .total-item label {
            font-size: 11px;
            color: rgba(212, 175, 55, 0.8);
            text-transform: uppercase;
            display: block;
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .total-item .amount {
            font-size: 32px;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
            animation: shimmerGold 3s infinite;
        }

        /* Premium Autocomplete */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-white);
            border: 3px solid #d4af37;
            border-top: none;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-gold);
            display: none;
            margin-top: -2px;
        }

        .autocomplete-dropdown.active {
            display: block;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 2px solid rgba(212, 175, 55, 0.15);
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-primary);
        }

        .autocomplete-item:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, rgba(220, 20, 60, 0.08) 100%);
            color: #d4af37;
            padding-left: 24px;
            border-left: 4px solid #d4af37;
            font-weight: 700;
        }

        /* Premium Login Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(212, 175, 55, 0.05);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
        }

        .login-card h2 {
            font-size: 28px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #d4af37 0%, #f4e5a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .login-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form-group label {
            display: block;
            color: #d4af37;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .login-form-group input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .login-form-group input:focus {
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
            background: rgba(0, 0, 0, 0.5);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #d4af37 0%, #c5a028 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }

        .login-error {
            color: #ff4444;
            font-size: 13px;
            margin-top: 15px;
            min-height: 20px;
            font-weight: 500;
        }

        /* Visibility States */
        body.logged-out .container {
            display: none !important;
        }

        body.logged-out #loginOverlay {
            display: flex !important;
        }

        body.logged-in .container {
            display: flex !important;
        }

        body.logged-in #loginOverlay {
            display: none !important;
        }

        /* === PREMIUM DASHBOARD & REPORT STYLES === */
        .godfather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .godfather-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(250, 250, 250, 0.98) 100%);
            padding: 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 3px solid rgba(212, 175, 55, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .godfather-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(220, 20, 60, 0.08) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .godfather-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: var(--shadow-gold);
            border-color: #ffd700;
        }

        .godfather-card:hover::before {
            opacity: 1;
        }

        .godfather-card h4 {
            margin: 0 0 20px 0;
            color: rgba(212, 175, 55, 0.9);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 3px rgba(212, 175, 55, 0.2);
        }

        .godfather-card .metric {
            font-size: 42px;
            font-weight: 900;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            letter-spacing: -1.5px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
            animation: shimmerGold 3s infinite;
        }

        .godfather-card .sub-metric {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 700;
            position: relative;
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .godfather-card.critical {
            border-left: 8px solid #dc143c;
            box-shadow: var(--shadow-crimson);
        }

        .godfather-card.critical .metric {
            background: var(--crimson-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .godfather-card.warning {
            border-left: 8px solid #ff8c00;
            box-shadow: 0 8px 32px rgba(255, 140, 0, 0.4);
        }

        .godfather-card.warning .metric {
            background: linear-gradient(135deg, #ff8c00 0%, #ffa500 50%, #ff8c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .godfather-card.success {
            border-left: 8px solid #228b22;
            box-shadow: 0 8px 32px rgba(34, 139, 34, 0.4);
        }

        .godfather-card.success .metric {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 50%, #228b22 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .action-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .action-badge:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .badge-critical {
            background: var(--crimson-gradient);
            color: white;
            border: 2px solid rgba(220, 20, 60, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .badge-warning {
            background: linear-gradient(135deg, #ff8c00 0%, #ffa500 100%);
            color: white;
            border: 2px solid rgba(255, 140, 0, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .badge-ok {
            background: linear-gradient(135deg, #228b22 0%, #32cd32 100%);
            color: white;
            border: 2px solid rgba(34, 139, 34, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .chart-container {
            background: var(--surface-white);
            padding: 36px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            margin-bottom: 32px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gold-gradient);
        }

        .chart-container:hover {
            box-shadow: var(--shadow-gold);
            transform: translateY(-6px);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .insight-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .insight-grid {
                grid-template-columns: 1fr;
            }
        }

        .list-widget {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-widget li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
        }

        .list-widget li:hover {
            padding-left: 12px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, transparent 100%);
        }

        .list-widget .label {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 15px;
        }

        .list-widget .value {
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
        }

        /* Highlight classes for search results (kept from original app) */
        .highlight-row {
            background-color: #fff8c6;
        }

        .highlight-cell {
            background-color: #fff8c6;
        }

        /* Premium Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-white);
            margin: auto;
            padding: 40px;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            float: right;
            font-size: 32px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
            line-height: 1;
            font-weight: 300;
        }

        .modal-close:hover {
            color: #ef4444;
            transform: rotate(90deg);
        }

        /* Premium Connection Status */
        .connection-status {
            position: fixed;
            top: 24px;
            right: 32px;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 900;
            z-index: 2000;
            color: #000000;
            box-shadow: var(--shadow-gold);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(212, 175, 55, 0.6);
            letter-spacing: 1.5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .connection-status:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.8);
        }

        .connection-status.connected {
            background: var(--gold-gradient);
            animation: pulseGold 2s infinite;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .connection-status.disconnected {
            background: var(--crimson-gradient);
            color: white;
            border-color: rgba(220, 20, 60, 0.6);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pending-badge {
            position: fixed;
            top: 76px;
            right: 32px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.95);
            color: #0f172a;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.06);
            z-index: 2000;
            display: none;
        }

        .perf-toggle {
            position: fixed;
            top: 120px;
            right: 32px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 800;
            background: rgba(0, 0, 0, 0.75);
            color: #f6f6f6;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow-md);
            z-index: 2000;
            letter-spacing: 0.5px;
        }

        body.performance-mode,
        body.performance-mode * {
            animation: none !important;
            transition: none !important;
        }

        body.performance-mode::before,
        body.performance-mode::after {
            display: none;
        }

        body.performance-mode .sidebar h1,
        body.performance-mode h2,
        body.performance-mode h3 {
            text-shadow: none !important;
        }

        body.performance-mode .sidebar,
        body.performance-mode .main-content,
        body.performance-mode table,
        body.performance-mode button,
        body.performance-mode .card,
        body.performance-mode .insight-card {
            box-shadow: none !important;
        }

        body.performance-mode .subtab-btn,
        body.performance-mode .tab-button,
        body.performance-mode .prod-action-btn {
            transform: none !important;
        }

        /* Toast Notifications */
        #toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            min-width: 260px;
            max-width: 420px;
            background: var(--surface-white);
            color: #111827;
            padding: 14px 16px;
            border-radius: 14px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.06);
            z-index: 2400;
            display: none;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            transform: translateY(12px);
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        #toast.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #toast.success {
            border-color: rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02));
        }

        #toast.error {
            border-color: rgba(239, 68, 68, 0.25);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.03));
        }

        #toast.warning {
            border-color: rgba(234, 179, 8, 0.25);
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.03));
        }

        #toast.info {
            border-color: rgba(59, 130, 246, 0.25);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.02));
        }

        @keyframes pulseGold {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            }

            50% {
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.9);
            }
        }

        /* Premium Scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold-gradient);
            border-radius: 10px;
            border: 2px solid #0a0a0a;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ffd700 0%, #c9a227 50%, #ffd700 100%);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
        }

        /* Section Titles */
        .section-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid;
            border-image: var(--primary-gradient) 1;
            letter-spacing: 0.3px;
        }

        /* Premium Report Filters */
        .report-filters {
            background: var(--surface-white);
            padding: 24px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
            border: 2px solid #f3f4f6;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: var(--surface-white);
            padding: 28px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 2px solid #f3f4f6;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: #667eea;
        }

        .dashboard-card h4 {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 12px 0;
            letter-spacing: -1px;
        }

        /* Currency Formatting */
        .currency {
            font-variant-numeric: tabular-nums;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: var(--surface-white);
            padding: 16px 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid #f3f4f6;
        }

        .bulk-actions label {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* Invoice Search */
        .invoice-search {
            margin-bottom: 20px;
        }

        .invoice-search input {
            box-shadow: var(--shadow-md);
        }

        /* Premium Checkbox & Radio */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* Loading Animation */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .loading {
            animation: shimmer 2s infinite;
            background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-size: 1000px 100%;
        }

        /* Tooltip Enhancement */
        [title] {
            position: relative;
            cursor: help;
        }

        /* Focus Visible for Accessibility */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Line Items Table Enhancement */
        .line-items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: var(--surface-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: visible;
            /* Keep dropdowns visible */
            border: 2px solid #f3f4f6;
            position: relative;
            z-index: 2;
        }

        .line-items-table th {
            background: var(--dark-gradient);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .line-items-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .line-items-table input,
        .line-items-table select {
            margin: 0;
            font-size: 14px;
        }

        .line-items-table tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        }

        /* Enhanced Category Filter */
        #categoryTotalsSummary {
            background: var(--surface-white);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            border: 2px solid #f3f4f6;
            font-weight: 600;
        }

        /* Premium floating effect */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Glassmorphism effect for special cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Print */
        @media print {

            .sidebar,
            .no-print,
            .report-filters,
            .connection-status {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            body::before {
                display: none;
            }
        }

        /* ============================================
   MOBILE RESPONSIVE DESIGN - FULLY OPTIMIZED
   ============================================ */

        /* Hamburger Menu Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--gold-gradient);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: var(--shadow-gold);
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            backdrop-filter: blur(4px);
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Tablet Responsive - 1024px and below */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                padding: 20px;
            }

            .main-content {
                margin-left: 0;
                padding: 30px;
            }

            .godfather-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 14px;
            }
        }

        /* Mobile Responsive - 768px and below */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .container {
                flex-direction: row;
            }

            .mobile-menu-toggle.open {
                left: calc(280px + 25px);
            }

            /* Sidebar Mobile Styles */
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                width: 280px;
                height: 100vh;
                overflow-y: auto;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
                padding: 80px 20px 20px 20px;
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar h1 {
                font-size: 24px;
                margin-bottom: 30px;
                text-align: center;
            }

            .sidebar button {
                font-size: 15px;
                padding: 14px 20px;
                margin-bottom: 12px;
            }

            /* Main Content Mobile */
            .main-content {
                margin-left: 0;
                padding: 80px 15px 20px 15px;
                width: 100%;
            }

            /* Typography Mobile */
            h2 {
                font-size: 22px;
                margin-bottom: 20px;
            }

            h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            /* Dashboard Grid Mobile */
            .godfather-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .godfather-card {
                padding: 20px;
            }

            .metric-label {
                font-size: 11px;
                letter-spacing: 1.5px;
            }

            .metric-value {
                font-size: 28px;
                margin: 10px 0;
            }

            .metric-change {
                font-size: 12px;
            }

            /* Forms Mobile */
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            input,
            select,
            textarea,
            .autocomplete-input {
                font-size: 16px !important;
                /* Prevents zoom on iOS */
                padding: 14px;
                border-radius: 10px;
            }

            .packing-layout {
                grid-template-columns: 1fr;
            }

            label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            /* Buttons Mobile */
            .btn,
            button {
                font-size: 14px;
                padding: 14px 24px;
                border-radius: 10px;
                letter-spacing: 1px;
                width: 100%;
                margin-bottom: 10px;
            }

            .btn-small {
                padding: 8px 14px;
                font-size: 11px;
                width: auto;
                display: inline-block;
                margin: 2px;
            }

            /* Action Buttons Group */
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }

            /* Tables Mobile - Card Style */
            table {
                display: block;
            }

            /* Machine Grid Styles */
            .machine-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .machine-card {
                background: var(--surface-white);
                border: 1px solid rgba(212, 175, 55, 0.3);
                border-radius: var(--border-radius-lg);
                padding: 16px;
                transition: all 0.3s ease;
                box-shadow: var(--shadow-sm);
            }

            .machine-card:hover {
                box-shadow: var(--shadow-gold);
                transform: translateY(-2px);
                border-color: rgba(212, 175, 55, 0.6);
            }

            .machine-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                padding-bottom: 8px;
            }

            .machine-name {
                font-size: 16px;
                font-weight: 800;
                color: var(--text-primary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .machine-status {
                display: flex;
                gap: 12px;
                margin-bottom: 16px;
                background: rgba(0, 0, 0, 0.02);
                padding: 8px;
                border-radius: var(--border-radius-sm);
            }

            .status-radio {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
            }

            .status-radio input[type="radio"] {
                margin: 0;
                cursor: pointer;
                width: 16px;
                height: 16px;
            }

            .status-radio.running {
                color: #228b22;
            }

            .status-radio.idle {
                color: #ff8c00;
            }

            .status-radio.maintenance {
                color: #dc143c;
            }

            .size-selector {
                margin-bottom: 16px;
            }

            .size-selector label {
                display: block;
                font-size: 12px;
                font-weight: 700;
                margin-bottom: 4px;
                color: var(--text-secondary);
                text-transform: uppercase;
            }

            .production-input {
                display: flex;
                gap: 8px;
                align-items: flex-end;
            }

            .production-input input {
                flex: 1;
            }

            .reset-btn {
                background: var(--crimson-gradient);
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: var(--border-radius-sm);
                cursor: pointer;
                font-size: 12px;
                white-space: nowrap;
                font-weight: 700;
                text-transform: uppercase;
            }

            .reset-btn:hover {
                box-shadow: var(--shadow-crimson);
            }

            table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 13px;
                border-radius: 12px;
            }

            table thead {
                display: none;
                /* Hide headers on mobile */
            }

            table tbody {
                display: block;
            }

            table tr {
                display: block;
                margin-bottom: 15px;
                background: var(--surface-white);
                border: 2px solid rgba(212, 175, 55, 0.3);
                border-radius: 12px;
                padding: 15px;
                box-shadow: var(--shadow-md);
            }

            table td {
                display: block;
                text-align: right;
                padding: 8px 0;
                border: none;
                position: relative;
                padding-left: 50%;
            }

            table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                padding-left: 10px;
                font-weight: 700;
                text-align: left;
                color: var(--text-secondary);
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            table td:last-child {
                border-bottom: none;
                padding-top: 15px;
                text-align: center;
                padding-left: 0;
            }

            table td:last-child::before {
                display: none;
            }

            /* Totals Box Mobile */
            .totals-box {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .totals-box .total-item {
                padding: 12px 0;
            }

            .totals-box .total-label {
                font-size: 13px;
            }

            .totals-box .total-value {
                font-size: 20px;
            }

            /* Modal Mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                padding: 25px;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 16px;
            }

            .modal h3 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            /* Invoice Items Mobile */
            #invoiceItems {
                display: block;
                overflow-x: auto;
            }

            .invoice-item-row {
                display: block;
                margin-bottom: 20px;
                padding: 15px;
                background: #f9fafb;
                border-radius: 12px;
                border: 2px solid rgba(212, 175, 55, 0.2);
            }

            .invoice-item-row input,
            .invoice-item-row select {
                margin-bottom: 10px;
                width: 100%;
            }

            /* Chart Container Mobile */
            .chart-container {
                padding: 20px;
                margin-bottom: 20px;
            }

            .chart-container h3 {
                font-size: 16px;
            }

            /* Report Filters Mobile */
            .report-filters {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }

            .report-filters input,
            .report-filters select,
            .report-filters button {
                width: 100%;
            }

            /* Tab Content Mobile */
            .sub-tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 20px;
            }

            .sub-tab-button {
                flex: 1 1 calc(50% - 8px);
                min-width: 140px;
                padding: 12px 16px;
                font-size: 13px;
            }

            /* Autocomplete Dropdown Mobile */
            .autocomplete-dropdown {
                max-height: 200px;
                font-size: 14px;
            }

            .autocomplete-item {
                padding: 12px;
            }

            /* Connection Status Mobile */
            .connection-status {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 6px 12px;
                border-radius: 20px;
            }

            /* Toast Notifications Mobile */
            #toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                text-align: center;
                font-size: 13px;
                padding: 15px;
                border-radius: 10px;
            }

            /* List Widget Mobile */
            .list-widget li {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px 0;
            }

            .list-widget .label {
                font-size: 14px;
            }

            .list-widget .value {
                font-size: 18px;
                align-self: flex-end;
            }

            /* Insight Grid Mobile */
            .insight-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Scroll Hint for Tables */
            table::-webkit-scrollbar {
                height: 8px;
            }

            table::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            table::-webkit-scrollbar-thumb {
                background: var(--gold-gradient);
                border-radius: 10px;
            }
        }

        /* Extra Small Mobile - 480px and below */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 10px 15px 10px;
            }

            h2 {
                font-size: 20px;
            }

            .godfather-card {
                padding: 15px;
            }

            .metric-value {
                font-size: 24px;
            }

            input,
            select,
            textarea {
                font-size: 16px;
                padding: 12px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 13px;
            }

            .modal-content {
                padding: 20px;
            }

            .sidebar {
                width: 260px;
            }

            .sub-tab-button {
                flex: 1 1 100%;
                min-width: 100%;
            }

            table {
                font-size: 12px;
            }

            table td {
                padding: 6px 0;
                font-size: 13px;
            }
        }

        /* Landscape Mobile Optimization */
        @media (max-width: 900px) and (orientation: landscape) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                padding: 60px 20px 20px 20px;
            }

            .godfather-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                max-height: 80vh;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {

            /* Increase touch targets */
            button,
            .btn,
            .tab-button,
            .sub-tab-button {
                min-height: 44px;
                min-width: 44px;
            }

            .autocomplete-item {
                min-height: 44px;
                padding: 12px 16px;
            }

            /* Remove hover effects on touch devices */
            *:hover {
                transition: none !important;
            }

            /* Prevent text selection on buttons */
            button,
            .btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }

        .dark-surface {
            background: radial-gradient(circle at top, rgba(12, 28, 63, 0.85), rgba(5, 11, 24, 0.95));
            border-radius: 28px;
            padding: 32px;
            color: #f5f8ff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .dark-surface h1,
        .dark-surface h2 {
            color: #f6fbff;
            -webkit-text-fill-color: #f6fbff;
            text-shadow: 0 4px 18px rgba(0, 0, 0, 0.5);
            margin-bottom: 8px;
        }

        .dark-surface h3,
        .dark-surface h4 {
            color: #f6fbff;
        }

        .dark-surface p {
            color: rgba(245, 248, 255, 0.75);
        }

        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
        }

        .packing-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .machine-card {
            background: rgba(8, 18, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 18px;
            color: #f0f4ff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
        }

        .machine-card .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .machine-card .machine-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .machine-status-badge {
            background: rgba(79, 209, 197, 0.15);
            color: #4fd1c5;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
        }

        .machine-card select,
        .machine-card input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f0f4ff;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 10px;
        }

        .machine-status {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .machine-status label {
            flex: 1;
            border-radius: 10px;
            padding: 6px 0;
            text-align: center;
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }

        .group-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .group-btn {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.04);
            color: #dce5ff;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .group-btn.active,
        .group-btn:hover {
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #021026;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        .inventory-stage-card {
            background: rgba(8, 18, 42, 0.92);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inventory-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-stage-title {
            font-size: 1.05rem;
            letter-spacing: 0.5px;
            color: #f6fbff;
            margin-bottom: 4px;
        }

        .inventory-stage-meta {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .inventory-size-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 260px;
            overflow-y: auto;
        }

        .inventory-size-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .inventory-size-row--empty {
            justify-content: center;
            font-style: italic;
            color: rgba(255, 255, 255, 0.5);
        }

        .inventory-size-name {
            font-weight: 600;
            color: #f8f9ff;
        }

        .inventory-size-count {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .inventory-qty-actions {
            display: flex;
            gap: 6px;
        }

        .inventory-qty-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
            padding: 0;
        }

        .inventory-qty-btn--add {
            background: #2ecc71;
        }

        .inventory-qty-btn--remove {
            background: #e74c3c;
        }

        .inventory-stage-add h4 {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .inventory-stage-add-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .inventory-stage-add select,
        .inventory-stage-add input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #f5f8ff;
            padding: 8px 10px;
        }

        .inventory-stage-add button {
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #031224;
            border: none;
            border-radius: 10px;
            padding: 9px 16px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(79, 209, 197, 0.35);
        }

        @media (max-width: 768px) {
            .dark-surface {
                padding: 20px;
            }

            .machine-grid,
            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .inventory-stage-add-form {
                flex-direction: column;
                align-items: stretch;
            }

            .inventory-stage-add button {
                width: 100%;
            }
        }

        .inventory-toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }

        .inventory-search {
            position: relative;
            width: min(320px, 100%);
        }

        .inventory-search input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #f6fbff;
        }

        .inventory-search input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .inventory-search button {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 16px;
        }

        .inventory-search-info {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(79, 209, 197, 0.1);
            color: #9fe5f1;
            display: none;
        }

        .prod-action-btn {
            border: none;
            border-radius: 12px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #4fd1c5, #5a8dee);
            color: #011022;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(79, 209, 197, 0.25);
            margin-top: 18px;
        }

        .prod-action-btn.secondary {
            background: rgba(255, 255, 255, 0.08);
            color: #f6fbff;
            box-shadow: none;
        }

        .prod-action-btn.ghost {
            background: rgba(255, 255, 255, 0.04);
            color: #f6fbff;
            box-shadow: none;
        }

        /* =========================
   MINIMAL MODE + MOBILE OVERRIDES
   (App-wide visual + responsive refresh)
   ========================= */

        :root {
            /* Neutral base */
            --surface-white: #ffffff;
            --surface-glass: #ffffff;
            --surface-dark: #111827;

            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-light: #9ca3af;
            --text-gold: #b45309;
            --text-crimson: #b91c1c;

            /* Softer gradients */
            --gold-gradient: linear-gradient(135deg, #fbbf24, #f59e0b);
            --primary-gradient: linear-gradient(135deg, #3b82f6, #2563eb);
            --crimson-gradient: linear-gradient(135deg, #dc2626, #b91c1c);

            /* Softer shadows */
            --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.10);
            --shadow-lg: 0 10px 15px rgba(15, 23, 42, 0.15);
            --shadow-xl: 0 18px 28px rgba(15, 23, 42, 0.18);
            --shadow-gold: var(--shadow-lg);
            --shadow-crimson: var(--shadow-lg);
        }

        /* Page background */
        body {
            background: #f3f4f6;
            color: var(--text-primary);
        }

        /* Kill shimmer & heavy text effects */
        @keyframes shimmerGold {
            from {
                filter: none;
            }

            to {
                filter: none;
            }
        }

        h2,
        .sidebar h1,
        .metric-value,
        .total-item .amount {
            animation: none !important;
            text-shadow: none !important;
        }

        /* Sidebar: flatter */
        .sidebar {
            background: #111827;
            border-right: 1px solid #1f2933;
            box-shadow: var(--shadow-lg);
        }

        /* Sidebar title */
        .sidebar h1 {
            font-size: 20px;
            text-transform: none;
            border-bottom: none;
            text-shadow: none;
            animation: none;
        }

        /* Sidebar menu buttons */
        .sidebar button {
            background: transparent;
            border-radius: 10px;
            border: 1px solid transparent;
            color: rgba(249, 250, 251, 0.8);
            font-weight: 500;
            transform: none;
            text-shadow: none;
        }

        .sidebar button::before {
            display: none;
        }

        .sidebar button:hover {
            background: rgba(55, 65, 81, 0.9);
            border-color: rgba(75, 85, 99, 0.8);
            color: #f9fafb;
            transform: none;
            box-shadow: none;
        }

        .sidebar button.active {
            background: #fbbf24;
            color: #111827;
            font-weight: 600;
            box-shadow: none;
            border-color: transparent;
        }

        /* Top-level tab buttons (e.g. Dashboard, Sales, Purchase, Reports) */
        .tab-button {
            background: #e5e7eb;
            color: #111827;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            box-shadow: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            text-transform: none;
        }

        .tab-button:hover {
            background: #d1d5db;
            transform: none;
        }

        .tab-button[data-tab-id].active,
        .sidebar .tab-button.active {
            background: #111827;
            color: #f9fafb;
            border-color: #111827;
        }

        /* Tab content animation off for calm feel */
        .tab-content {
            animation: none !important;
        }

        /* Titles & section headings */
        h2 {
            font-size: 22px;
            margin-bottom: 20px;
            background: none;
            -webkit-text-fill-color: inherit;
            color: #111827;
            font-weight: 600;
            letter-spacing: 0;
            text-shadow: none;
        }

        h3 {
            font-size: 16px;
            margin: 20px 0 10px;
            background: none;
            color: #111827;
            border-left: 3px solid #e5e7eb;
            padding-left: 10px;
            text-transform: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: .05em;
        }

        /* Form layout */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 12px;
        }

        .form-group {
            flex: 1 1 220px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 4px;
        }

        /* Inputs, selects, textareas */
        input,
        select,
        textarea {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: none;
            font-size: 14px;
            font-weight: 400;
            background: #ffffff;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #2563eb33;
            transform: none;
            background: #ffffff;
        }

        input::placeholder,
        textarea::placeholder {
            color: #9ca3af;
            font-style: normal;
            font-weight: 400;
        }

        /* Error state */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef444422;
        }

        /* Autocomplete dropdown */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-md);
        }

        .autocomplete-item {
            padding: 8px 10px;
            font-size: 14px;
        }

        .autocomplete-item:hover {
            background: #f9fafb;
            color: #111827;
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
        }

        /* Base button */
        button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #111827;
            color: #f9fafb;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0;
            text-transform: none;
            box-shadow: none;
            transform: none;
            text-shadow: none;
        }

        button::before {
            display: none;
        }

        button:hover {
            background: #1f2937;
            border-color: #111827;
        }

        /* Button variants */
        button.success {
            background: #16a34a;
            border-color: #16a34a;
            color: #f9fafb;
        }

        button.success:hover {
            background: #15803d;
        }

        button.danger {
            background: #dc2626;
            border-color: #dc2626;
            color: #f9fafb;
        }

        button.danger:hover {
            background: #b91c1c;
        }

        /* Optional secondary-style buttons (when HTML uses class="secondary") */
        button.secondary {
            background: #e5e7eb;
            color: #111827;
            border-color: #d1d5db;
        }

        button.secondary:hover {
            background: #d1d5db;
        }

        /* Subtabs (Create/View Invoice/Quote, etc.) */
        .subtabs {
            background: #f3f4f6;
            border-radius: 999px;
            padding: 4px;
            border: 1px solid #e5e7eb;
            gap: 4px;
        }

        .subtab-btn {
            border-radius: 999px;
            border: none;
            background: transparent;
            color: #4b5563;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 12px;
            text-transform: none;
            letter-spacing: 0;
        }

        .subtab-btn:hover {
            background: #e5e7eb;
            color: #111827;
            transform: none;
            box-shadow: none;
        }

        .subtab-btn.active {
            background: #111827;
            color: #f9fafb;
            box-shadow: none;
        }

        /* Tables */
        table {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            border: 1px solid #e5e7eb;
            border-spacing: 0;
            width: 100%;
        }

        table th {
            background: #111827;
            color: #f9fafb;
            padding: 10px 12px;
            font-size: 11px;
            letter-spacing: .05em;
            text-transform: uppercase;
            border-bottom: 1px solid #1f2937;
            text-shadow: none;
        }

        table td {
            padding: 8px 12px;
            font-size: 13px;
            border-bottom: 1px solid #e5e7eb;
        }

        table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        table tbody tr:hover {
            background: #eef2ff;
            transform: none;
            box-shadow: none;
            border-left: 3px solid #3b82f6;
        }

        /* Line items table specific */
        .line-items-table {
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e5e7eb;
        }

        /* Cards & dashboards */
        .godfather-card,
        .dashboard-card,
        .chart-container,
        .report-filters,
        .bulk-actions {
            border-radius: 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-md);
        }

        .godfather-card::before,
        .chart-container::before {
            display: none;
        }

        .godfather-card .metric,
        .metric-value {
            font-size: 24px;
            background: none;
            color: #111827;
            text-shadow: none;
            animation: none;
        }

        /* Totals box */
        .totals-box {
            background: #111827;
            border-radius: 12px;
            padding: 16px;
            border: none;
            box-shadow: var(--shadow-md);
        }

        .totals-box::before {
            display: none;
        }

        .total-item {
            border: none;
            background: transparent;
        }

        .total-item label {
            color: #e5e7eb;
        }

        .total-item .amount {
            background: none;
            -webkit-text-fill-color: #fbbf24;
            color: #fbbf24;
            text-shadow: none;
            font-size: 22px;
        }

        /* Modals & overlays */
        .modal {
            background: rgba(15, 23, 42, 0.6);
        }

        .modal-content {
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            border: 1px solid #e5e7eb;
            animation: none;
        }

        .modal-close {
            font-size: 24px;
            color: #9ca3af;
        }

        .modal-close:hover {
            color: #ef4444;
            transform: none;
        }

        /* Connection status pill */
        .connection-status {
            border-radius: 999px;
            font-size: 11px;
            padding: 6px 12px;
            box-shadow: var(--shadow-md);
        }

        .connection-status.connected {
            background: #22c55e;
            border-color: #16a34a;
            animation: none;
        }

        .connection-status.disconnected {
            background: #dc2626;
        }

        /* Toasts */
        #toast {
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            font-size: 13px;
        }

        /* Login card */
        .login-card {
            background: #111827;
            border-radius: 16px;
            border: 1px solid #1f2937;
            box-shadow: var(--shadow-xl);
        }

        .login-card h2 {
            -webkit-text-fill-color: #f9fafb;
            text-transform: none;
            letter-spacing: 0;
        }

        /* Dark surface containers -> calm cards */
        .dark-surface {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            color: #111827;
            box-shadow: var(--shadow-md);
            border: 1px solid #e5e7eb;
        }

        .dark-surface h2,
        .dark-surface h3 {
            color: #111827;
            -webkit-text-fill-color: #111827;
            text-shadow: none;
        }

        /* Medium screens: gently tighten layout */
        @media (max-width: 1024px) {
            body {
                font-size: 14px;
            }

            .sidebar {
                min-width: 220px;
            }

            .tab-button {
                padding: 6px 12px;
            }

            .form-row {
                gap: 12px;
            }
        }

        /* Small screens: mobile-first, native-like */
        @media (max-width: 768px) {

            /* Main layout wrapper */
            .container {
                display: flex;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
                border-right: none;
                border-bottom: 1px solid #1f2937;
                box-shadow: none;
                padding-bottom: 8px;
                margin-bottom: 8px;
            }

            .sidebar h1 {
                text-align: center;
                margin-bottom: 8px;
            }

            .sidebar nav,
            .sidebar-menu {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px;
            }

            /* Ensure sidebar buttons flow nicely */
            .sidebar button {
                width: auto;
                margin: 2px;
                padding: 8px 12px;
            }

            /* Main content area */
            .main-content {
                width: 100%;
                padding: 10px;
                margin: 0;
            }

            /* Global padding cleanup */
            .tab-content {
                padding: 10px;
            }

            /* Forms on mobile: full-width inputs */
            .form-row {
                flex-direction: column;
                gap: 8px;
            }

            .form-group {
                flex: 1 1 100%;
            }

            input,
            select,
            textarea {
                width: 100%;
                min-height: 44px;
                /* Native-like tap target height */
            }

            button {
                min-height: 44px;
                width: auto;
            }

            /* Subtabs: full-width segmented control */
            .subtabs {
                flex-wrap: wrap;
                justify-content: center;
            }

            .subtab-btn {
                flex: 1 1 auto;
                text-align: center;
                padding: 8px 10px;
            }

            /* Cards: remove heavy margins, full width */
            .godfather-card,
            .dashboard-card,
            .chart-container,
            .report-filters,
            .bulk-actions,
            .dark-surface {
                margin: 6px 0;
                border-radius: 12px;
            }

            /* Tables: horizontal scroll wrapper on mobile */
            .table-wrapper,
            .table-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                /* prevent squashing important columns */
            }

            /* Totals box: sticky at bottom of screen might feel native-like */
            .totals-box {
                position: sticky;
                bottom: 0;
                z-index: 10;
                margin-top: 12px;
            }

            /* Login overlay: center on small screens */
            .login-card {
                max-width: 340px;
                margin: 0 auto;
            }

            /* Toast: full-width-ish at bottom, like mobile OS */
            #toast {
                max-width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        @media (max-width: 400px) {
            body {
                font-size: 13px;
            }

            h2 {
                font-size: 18px;
            }

            h3 {
                font-size: 14px;
            }

            .sidebar h1 {
                font-size: 18px;
            }

            .tab-button {
                font-size: 12px;
                padding: 6px 8px;
            }

            .subtab-btn {
                font-size: 11px;
                padding: 6px 8px;
            }

            input,
            select,
            textarea,
            button {
                font-size: 13px;
            }
        }
    </style>

</head>

<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()"></button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>

    <div class="connection-status disconnected" id="connectionStatus"> Offline</div>
    <div class="pending-badge" id="pendingSyncBadge" aria-live="polite" title="Pending changes waiting for sync"></div>
    <button class="perf-toggle" id="perfToggle" type="button" onclick="togglePerformanceMode()"
        title="Reduce animations and heavy effects"> Performance</button>

    <div id="loginOverlay">
        <div class="login-card">
            <h2>Factory Login</h2>
            <div class="login-form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
            </div>
            <div class="login-form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password">
            </div>
            <button class="login-btn" onclick="handleLogin()">Login System</button>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <h1> Factory Book</h1>
            <button class="tab-button active" data-tab-id="sales" onclick="switchMainTab('sales', this)">
                Sales</button>
            <button class="tab-button" data-tab-id="purchase" onclick="switchMainTab('purchase', this)">
                Purchase</button>
            <button class="tab-button" data-tab-id="reports" onclick="switchMainTab('reports', this)">
                Reports</button>
            <button class="tab-button" data-tab-id="ledger" onclick="switchMainTab('ledger', this)"> Ledger</button>
            <button class="tab-button" data-tab-id="size-control"
                onclick="switchMainTab('size-control', this); renderMachinesTable();"> Machine
                Size Control</button>
            <button class="tab-button" data-tab-id="dashboard" onclick="switchMainTab('dashboard', this)">
                Dashboard</button>
            <button class="tab-button" data-tab-id="production-entry"
                onclick="switchMainTab('production-entry', this)">
                Production Entry</button>
            <button class="tab-button" data-tab-id="packing" onclick="switchMainTab('packing', this)">
                Packing</button>
            <button class="tab-button" data-tab-id="masters" onclick="switchMainTab('masters', this)">
                Masters</button>
            <button class="tab-button" data-tab-id="inventory" onclick="switchMainTab('inventory', this)">
                Inventory</button>
            <button class="tab-button" data-tab-id="backup" onclick="switchMainTab('backup', this)"> Backup</button>
            <button class="tab-button" data-tab-id="users" onclick="switchMainTab('users', this)"> Users &
                Roles</button>
            <div style="flex: 1;"></div>
            <button class="tab-button" onclick="App.auth.logout()" style="margin-top: 20px;"> Logout</button>
        </div>

        <div class="main-content">

            <!-- USERS & ROLES TAB -->
            <div id="users" class="tab-content">
                <h2> Users & Roles Management</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchUsersSubtab('users-roles', this)">
                        Roles</button>
                    <button class="subtab-btn" onclick="switchUsersSubtab('users-list', this)"> Users</button>
                </div>

                <!-- ROLES SUBTAB -->
                <div id="users-roles" class="subtab-content active">
                    <div class="dashboard-card">
                        <h3>Manage Roles</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Role to Edit</label>
                                <select id="roleSelect" onchange="loadRoleForEdit()">
                                    <option value="">-- Create New Role --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Role ID / Name</label>
                                <input type="text" id="roleIdInput" placeholder="e.g. Foreman">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="roleDescriptionInput"
                                    placeholder="e.g. Can manage production only">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Allowed Tabs</label>
                            <div id="roleAllowedTabs" class="checkbox-grid">
                                <!-- Checkboxes injected by JS -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Allowed Machine Types (for Machine Size & Production Entry)</label>
                            <div id="roleAllowedMachineTypes" class="checkbox-grid">
                                <!-- Machine-type checkboxes injected by JS -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Capabilities / Permissions</label>
                            <div id="roleCapabilities" class="checkbox-grid">
                                <!-- Capability checkboxes injected by JS -->
                            </div>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveRole()"> Save Role</button>
                            <button class="btn btn-danger" onclick="deleteRole()"> Delete Role</button>
                        </div>
                    </div>
                </div>

                <!-- USERS SUBTAB -->
                <div id="users-list" class="subtab-content">
                    <div class="dashboard-card">
                        <h3>Manage Users</h3>
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Display Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Users injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-card" style="margin-top: 20px;">
                        <h3>Add / Edit User</h3>
                        <input type="hidden" id="editUserId">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="editUserUsername" placeholder="username">
                            </div>
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="editUserDisplayName" placeholder="Full Name">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="text" id="editUserPassword" placeholder="password">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="editUserRole">
                                    <!-- Roles injected by JS -->
                                </select>
                            </div>
                            <div class="form-group"
                                style="display: flex; align-items: center; gap: 10px; margin-top: 25px;">
                                <input type="checkbox" id="editUserActive" checked>
                                <label for="editUserActive" style="margin: 0;">Active User</label>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveUser()"> Save User</button>
                            <button class="btn btn-secondary" onclick="clearUserForm()"> Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SALES TAB -->
            <div id="sales" class="tab-content active">
                <h2>Sales Invoice</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchSalesSubtab('sales-create', this)">Create
                        Invoice</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-list', this)">View Invoices</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-quote-create', this)">Create
                        Quote</button>
                    <button class="subtab-btn" onclick="switchSalesSubtab('sales-quote-list', this)">View
                        Quotes</button>
                </div>

                <div id="sales-create" class="subtab-content active">
                    <form id="salesInvoiceForm" onsubmit="return false;">
                        <input type="hidden" id="saleInvoiceIdEdit">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Date</label>
                                <input type="date" id="saleDate" required>
                            </div>
                            <div class="form-group">
                                <label>Customer (Type to search)</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="saleCustomer" class="autocomplete-input"
                                        placeholder="Start typing customer name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="saleCustomerList"></div>
                                </div>
                                <button type="button" onclick="openAddCustomerModal()"
                                    style="width: auto; margin-top: 5px;">+ Add New Customer</button>
                                <input type="hidden" id="saleCustomerId">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Size</th>
                                    <th>Unit</th>

                                    <th>Qty</th>
                                    <th>Rate ()</th>
                                    <th>Discount (%)</th>
                                    <th>Line Tax ()</th>
                                    <th>Total ()</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="saleLineItems">
                            </tbody>
                        </table>

                        <button type="button" onclick="addSaleLine()" class="success">+ Add Line Item</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Additional Invoice Tax () - Applied on top of line taxes</label>
                                <input type="number" id="saleInvoiceTax" step="0.01" value="0" readonly>
                            </div>
                        </div>

                        <div class="totals-box">
                            <div class="total-item">
                                <label>Subtotal:</label>
                                <div class="amount currency"><span id="saleSubtotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Line Taxes:</label>
                                <div class="amount currency"><span id="saleTaxTotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Invoice Tax (18% GST):</label>
                                <div class="amount currency"><span id="saleInvoiceTaxDisplay">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Grand Total:</label>
                                <div class="amount currency"><span id="saleGrandTotal">0</span></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Notes (optional)</label>
                                <textarea id="saleNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="button-group no-print">
                            <button type="button" onclick="saveSalesInvoice()" class="success"> Save Invoice</button>
                            <button type="button" onclick="clearSalesForm()"> Clear Form</button>
                            <button type="button" onclick="window.print()" class="success"> Print</button>
                        </div>
                    </form>
                </div>

                <div id="sales-list" class="subtab-content">
                    <h3>All Sales Invoices</h3>
                    <div class="button-group no-print" style="margin:8px 0 12px 0; gap:8px;">
                        <button type="button" onclick="openImportModal('salesImport')"> Import CSV
                            (Sales Invoices)</button>
                        <button type="button" onclick="openImportModal('bankLedger')"> Import CSV
                            (Bank Statement)</button>
                    </div>

                    <!-- Bulk Actions for Sales Invoices -->
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSalesInvoices" onchange="toggleSelectAllSalesInvoices()">
                        <label for="selectAllSalesInvoices">Select All</label>
                        <select id="bulkActionSalesInvoices" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkActionSalesInvoices()" class="success">Apply</button>
                    </div>

                    <!-- Search bar for Sales Invoices -->
                    <div class="invoice-search">
                        <input type="text" id="salesInvoiceSearch"
                            placeholder="Search by party, item, amount or size..." style="margin: 12px 0; width: 100%;">
                    </div>

                    <table id="salesInvoiceTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Amount ()</th>
                                <th>Line Tax ()</th>
                                <th>Invoice Tax ()</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoices will be populated here -->
                            <tr id="salesTotalRow">
                                <td colspan="3" style="text-align: right;">TOTAL:</td>
                                <td id="salesTotalAmount" class="currency">0.00</td>
                                <td id="salesTotalLineTax" class="currency">0.00</td>
                                <td id="salesTotalInvoiceTax" class="currency">0.00</td>
                                <td></td> <!-- Empty for actions -->
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="sales-quote-create" class="subtab-content">
                    <h3>Create Quote</h3>
                    <form id="salesQuoteForm" onsubmit="return false;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="quoteDate">
                            </div>
                            <div class="form-group">
                                <label>Customer</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="quoteCustomer" class="autocomplete-input"
                                        placeholder="Start typing customer name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="quoteCustomerList"></div>
                                </div>
                                <input type="hidden" id="quoteCustomerId">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Stage</label>
                                <select id="quoteStage">
                                    <option value="Rolling">Rolling</option>
                                    <option value="Plating">Plating</option>
                                    <option value="Furnace">Hardening</option>
                                    <option value="Tampering">Tampering</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Size (only from inventory)</label>
                                <input type="text" id="quoteSize" list="quoteSizeOptions"
                                    placeholder="Start typing size..." onchange="handleQuoteSizeInput(this.value)">
                            </div>
                            <div class="form-group">
                                <label>Unit</label>
                                <select id="quoteUnit">
                                    <option value="KG">KG</option>
                                    <option value="PKT">PKT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Bag factor / count (per PETI)</label>
                                <input type="number" id="quoteBagFactor" min="1"
                                    placeholder="How many KG/PKT in one PETI">
                            </div>
                            <div class="form-group">
                                <label>PETI (to be sent)</label>
                                <input type="number" id="quotePeti" min="1" placeholder="No. of PETI to send">
                            </div>
                            <div class="form-group">
                                <label>Qty (from inventory)</label>
                                <input type="number" id="quoteQty" min="1" placeholder="Bags from inventory">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Size</th>
                                    <th>Unit</th>
                                    <th>PETI</th>
                                    <th>Stage</th>
                                    <th>Bags Used</th>
                                    <th>Total Qty</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="quoteLineItems">
                            </tbody>
                        </table>
                        <button type="button" class="success" onclick="addQuoteLine()">+ Add Line</button>

                        <div class="button-group no-print" style="margin-top:12px;">
                            <button type="button" class="success" onclick="saveQuote()"> Save Quote</button>
                            <button type="button" onclick="clearQuoteForm()"> Clear</button>
                        </div>
                    </form>
                </div>

                <div id="sales-quote-list" class="subtab-content">
                    <h3>View Quotes</h3>
                    <div class="invoice-search">
                        <input type="text" id="quoteSearch" placeholder="Search quotes..."
                            oninput="filterQuotes(this.value)">
                    </div>
                    <table id="quotesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Stage</th>
                                <th>Size</th>
                                <th>PETI</th>
                                <th>Total Qty</th>
                                <th>Bags Used</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PURCHASE TAB -->
            <div id="purchase" class="tab-content">
                <h2>Purchase Invoice</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchPurchaseSubtab('purchase-create', this)">Create
                        Invoice</button>
                    <button class="subtab-btn" onclick="switchPurchaseSubtab('purchase-list', this)">View
                        Invoices</button>
                </div>

                <div id="purchase-create" class="subtab-content active">
                    <form id="purchaseInvoiceForm" onsubmit="return false;">
                        <input type="hidden" id="purchaseInvoiceIdEdit">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Invoice Date</label>
                                <input type="date" id="purchaseDate" required>
                            </div>
                            <div class="form-group">
                                <label>Supplier (Type to search)</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="purchaseSupplier" class="autocomplete-input"
                                        placeholder="Start typing supplier name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="purchaseSupplierList"></div>
                                </div>
                                <button type="button" onclick="openAddSupplierModal()"
                                    style="width: auto; margin-top: 5px;">+ Add New Supplier</button>
                                <input type="hidden" id="purchaseSupplierId">
                            </div>
                        </div>

                        <div class="section-title">Line Items</div>
                        <table class="line-items-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Size (Ready Screws)</th>
                                    <th>Stage (Ready Screws)</th>
                                    <th>Bags Received (Ready Screws)</th>
                                    <th style="width: 120px;">Unit</th>
                                    <th>Qty</th>
                                    <th>Rate ()</th>
                                    <th>Line Tax ()</th>
                                    <th>Total ()</th>
                                    <th style="width: 60px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseLineItems">
                            </tbody>
                        </table>

                        <button type="button" onclick="addPurchaseLine()" class="success">+ Add Line Item</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Additional Invoice Tax () - Applied on top of line taxes</label>
                                <input type="number" id="purchaseInvoiceTax" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="totals-box">
                            <div class="total-item">
                                <label>Subtotal:</label>
                                <div class="amount currency"><span id="purchaseSubtotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Line Taxes:</label>
                                <div class="amount currency"><span id="purchaseTaxTotal">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Invoice Tax:</label>
                                <div class="amount currency"><span id="purchaseInvoiceTaxDisplay">0</span></div>
                            </div>
                            <div class="total-item">
                                <label>Grand Total:</label>
                                <div class="amount currency"><span id="purchaseGrandTotal">0</span></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Notes (optional)</label>
                                <textarea id="purchaseNotes" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="button-group no-print">
                            <button type="button" onclick="savePurchaseInvoice()" class="success"> Save
                                Invoice</button>
                            <button type="button" onclick="clearPurchaseForm()"> Clear Form</button>
                            <button type="button" onclick="window.print()" class="success"> Print</button>
                        </div>
                    </form>
                </div>

                <div id="purchase-list" class="subtab-content">
                    <h3>All Purchase Invoices</h3>
                    <div class="button-group no-print" style="margin:8px 0 12px 0; gap:8px;">
                        <button type="button" onclick="openImportModal('purchaseImport')"> Import
                            CSV (Purchase Invoices)</button>
                        <button type="button" onclick="openImportModal('bankLedger')"> Import CSV
                            (Bank Statement)</button>
                    </div>

                    <!-- Bulk Actions for Purchase Invoices -->
                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllPurchaseInvoices"
                            onchange="toggleSelectAllPurchaseInvoices()">
                        <label for="selectAllPurchaseInvoices">Select All</label>
                        <select id="bulkActionPurchaseInvoices" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkActionPurchaseInvoices()" class="success">Apply</button>
                    </div>

                    <!-- Search bar for Purchase Invoices -->
                    <div class="invoice-search">
                        <input type="text" id="purchaseInvoiceSearch"
                            placeholder="Search by party, item, amount or size..." style="margin: 12px 0; width: 100%;">
                    </div>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>Filter by Category</label>
                            <select id="purchaseCategoryFilter" onchange="filterPurchaseByCategory()">
                                <option value="">All Categories</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Machine Repair">Machine Repair</option>
                                <option value="RAW MATERIALS">RAW MATERIALS</option>
                                <option value="Other">Other</option>
                                <option value="Wire">Wire</option>
                                <option value="Ready Screws">Ready Screws</option>
                                <option value="P E">P E</option>
                                <option value="miscellaneous">miscellaneous</option>
                            </select>
                        </div>
                    </div>
                    <div id="categoryTotalsSummary"></div>
                    <table id="purchaseInvoiceTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Date</th>
                                <th>Supplier</th>
                                <th>Categories</th>
                                <th>Amount ()</th>
                                <th>Line Tax ()</th>
                                <th>Invoice Tax ()</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoices will be populated here -->
                            <tr id="purchaseTotalRow">
                                <td colspan="4" style="text-align: right;">TOTAL:</td>
                                <td id="purchaseTotalAmount" class="currency">0.00</td>
                                <td id="purchaseTotalLineTax" class="currency">0.00</td>
                                <td id="purchaseTotalInvoiceTax" class="currency">0.00</td>
                                <td></td> <!-- Empty for actions -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <h2>Reports</h2>

                <div class="subtabs">
                    <button class="subtab-btn active" onclick="switchReportsSubtab('report-sizewise', this)">Size-wise
                        Sales</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-sizewise-purchase', this)">Size-wise
                        Purchases</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-customerwise', this)">Customer-wise
                        Sales</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-pl', this)">P&L Statement</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-business-intel', this)"> Business
                        Intelligence</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-visual-analytics', this)"> Visual
                        Analytics</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-elaborate', this)">
                        Elaborate</button>
                    <button class="subtab-btn" onclick="switchReportsSubtab('report-activity-logs', this)">
                        Logs</button>
                </div>

                <div id="report-sizewise" class="subtab-content active">
                    <h3>Size-wise Sales Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportSizeFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportSizeToDate">
                        </div>
                        <button type="button" onclick="generateSizewiseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('sizewiseTable')"> Export CSV</button>
                    </div>
                    <table id="sizewiseTable">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Total Value ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-sizewise-purchase" class="subtab-content">
                    <h3>Size-wise Purchases Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportSizePurchaseFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportSizePurchaseToDate">
                        </div>
                        <button type="button" onclick="generateSizewisePurchaseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('sizewisePurchaseTable')"> Export CSV</button>
                    </div>
                    <table id="sizewisePurchaseTable">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Total Value ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-customerwise" class="subtab-content">
                    <h3>Customer-wise Sales Report</h3>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportCustFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportCustToDate">
                        </div>
                        <div class="form-group">
                            <label>Filter by Customer (optional)</label>
                            <input type="text" id="reportCustFilter" placeholder="Leave blank for all">
                        </div>
                        <button type="button" onclick="generateCustomerwiseReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('customerwiseTable')"> Export CSV</button>
                    </div>
                    <table id="customerwiseTable">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Total Sales ()</th>
                                <th>Total KG</th>
                                <th>Total PKT</th>
                                <th>Top Sizes</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="report-elaborate" class="subtab-content">
                    <h3>Elaborate Stock Flow Report</h3>
                    <p style="margin-bottom:8px;">See how every size is moving: factory production,
                        vendor purchases, and on-hand stock for the selected window.</p>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportElaborateFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportElaborateToDate">
                        </div>
                        <button type="button" onclick="generateElaborateReport()"> Generate Report</button>
                        <button type="button" onclick="exportReportCSV('elaborateFactoryTable')"> Export
                            Factory</button>
                        <button type="button" onclick="exportReportCSV('elaboratePurchaseTable')"> Export
                            Purchases</button>
                        <button type="button" onclick="exportReportCSV('elaborateStockTable')"> Export Stock</button>
                    </div>
                    <div class="elaborate-grid" style="display:grid; gap:18px;">
                        <div class="dashboard-card">
                            <h4>Factory Made (Production)</h4>
                            <table id="elaborateFactoryTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Total Bags</th>
                                        <th>Stages</th>
                                        <th>Machines</th>
                                        <th>Last Produced</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="dashboard-card">
                            <h4>Purchased Externally</h4>
                            <table id="elaboratePurchaseTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Total KG</th>
                                        <th>Total PKT</th>
                                        <th>Total Value ()</th>
                                        <th>Suppliers</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="dashboard-card">
                            <h4>Sizes Already In Stock</h4>
                            <table id="elaborateStockTable">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Raw Wire (KG)</th>
                                        <th>Finished Goods (PKT)</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                            <p style="font-size:12px; margin-top:8px;">Stock values represent the live
                                snapshot at the time of report creation.</p>
                        </div>
                    </div>
                </div>

                <div id="report-pl" class="subtab-content">
                    <h3>Profit & Loss Statement</h3>

                    <div class="subtabs" style="margin-bottom: 15px;">
                        <button class="subtab-btn active" onclick="switchPLSubtab('pl-gross', this)">Gross P&L (Grand
                            Total)</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-tax', this)">Actual Cost vs Tax
                            P&L</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-gst', this)">GST</button>
                        <button class="subtab-btn" onclick="switchPLSubtab('pl-masters', this)">Masters</button>
                    </div>

                    <div id="pl-gross" class="subtab-content active">
                        <h4 style="margin-bottom: 15px;">Gross Profit & Loss (Including All Taxes)</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportPLFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportPLToDate">
                            </div>
                            <button type="button" onclick="generatePLReport()" class="success"> Generate P&L</button>
                            <button type="button" onclick="exportReportCSV('plTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="plTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net Profit/Loss</td>
                                    <td id="plNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-tax" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">Profit & Loss - Actual Cost vs Line Tax</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportPLTaxFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportPLTaxToDate">
                            </div>
                            <button type="button" onclick="generatePLTaxReport()" class="success"> Generate
                                Report</button>
                            <button type="button" onclick="exportReportCSV('plTaxTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="plTaxTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net Profit/Loss (Actual Cost)</td>
                                    <td id="plTaxNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-gst" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">GST Calculation</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportGSTFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportGSTToDate">
                            </div>
                            <button type="button" onclick="generateGSTReport()" class="success"> Generate
                                Report</button>
                            <button type="button" onclick="exportReportCSV('gstTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="gstTable">
                            <thead>
                                <tr>
                                    <th>Particulars</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Net GST Payable</td>
                                    <td id="gstNetResult" style="text-align: right;">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div id="pl-masters" class="subtab-content">
                        <h4 style="margin-bottom: 15px;">Masters Summary</h4>
                        <div class="report-filters">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="reportMastersFromDate">
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="reportMastersToDate">
                            </div>
                            <button type="button" onclick="generateMastersReport()" class="success"> Generate Masters
                                Summary</button>
                            <button type="button" onclick="exportReportCSV('mastersTable')" class="success"> Export
                                CSV</button>
                        </div>
                        <table id="mastersTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th style="text-align: right;">Amount ()</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="report-activity-logs" class="subtab-content">
                    <h3>Action Logs</h3>
                    <p style="margin-bottom:8px;">All key actions are captured with time, user and
                        context for traceability.</p>
                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="logsFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="logsToDate">
                        </div>
                        <div class="form-group">
                            <label>Search</label>
                            <input type="text" id="logsSearch" placeholder="Search action, details or user..."
                                oninput="generateActivityLogs(false)">
                        </div>
                        <div class="form-group" style="align-self:flex-end;">
                            <label style="display:flex; align-items:center; gap:6px; font-size:13px;">
                                <input type="checkbox" id="logsHideNavigation" checked
                                    onchange="generateActivityLogs(false)">
                                Hide tab/navigation events
                            </label>
                        </div>
                        <button type="button" onclick="generateActivityLogs(true)"> Refresh Logs</button>
                        <button type="button" onclick="exportReportCSV('activityLogsTable')"> Export Logs</button>
                    </div>
                    <table id="activityLogsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Role</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <!-- NEW BUSINESS INTELLIGENCE DASHBOARD -->
                <div id="report-business-intel" class="subtab-content">
                    <h3>Business Intelligence Dashboard</h3>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportBIFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportBIToDate">
                        </div>
                        <button type="button" onclick="generateBusinessIntelligenceReport()" class="success"> Generate
                            Dashboard</button>
                        <button type="button" onclick="exportBIDashboard()" class="success"> Export Report</button>
                    </div>

                    <div id="biDashboard">
                        <div class="dashboard-cards">
                            <div class="dashboard-card">
                                <h4> Financial Overview</h4>
                                <div class="metric-value" id="biTotalSales">0</div>
                                <div>Total Sales</div>
                                <div class="metric-value" id="biTotalPurchases">0</div>
                                <div>Total Purchases</div>
                                <div class="metric-value" id="biNetProfit">0</div>
                                <div>Net Profit</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Inventory Health</h4>
                                <div class="metric-value" id="biTotalInventoryValue">0</div>
                                <div>Inventory Value</div>
                                <div class="metric-value" id="biLowStockItems">0</div>
                                <div>Low Stock Items</div>
                                <div class="metric-value" id="biInventoryTurnover">0.0</div>
                                <div>Turnover Ratio</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Customer Insights</h4>
                                <div class="metric-value" id="biTopCustomer">-</div>
                                <div>Top Customer</div>
                                <div class="metric-value" id="biAvgOrderValue">0</div>
                                <div>Avg Order Value</div>
                                <div class="metric-value" id="biCustomerCount">0</div>
                                <div>Total Customers</div>
                            </div>

                            <div class="dashboard-card">
                                <h4> Purchase Analysis</h4>
                                <div class="metric-value" id="biFrequentSupplier">-</div>
                                <div>Most Frequent Supplier</div>
                                <div class="metric-value" id="biRawMaterialCost">0</div>
                                <div>Raw Material Cost</div>
                                <div class="metric-value" id="biMaintenanceCost">0</div>
                                <div>Maintenance Cost</div>
                            </div>

                        </div>

                        <div class="chart-container">
                            <h4> Key Business Insights</h4>
                            <div id="biInsights">
                                <!-- Insights will be populated here -->
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4> Top Performers</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <h5>Top 5 Customers</h5>
                                    <ul class="top-list" id="biTopCustomers">
                                        <!-- Top customers will be populated here -->
                                    </ul>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <h5>Top 5 Products</h5>
                                    <ul class="top-list" id="biTopProducts">
                                        <!-- Top products will be populated here -->
                                    </ul>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <h5>Frequent Purchases</h5>
                                    <ul class="top-list" id="biFrequentPurchases">
                                        <!-- Frequent purchases will be populated here -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h4> Raw Material Consumption</h4>
                            <table id="biRawMaterialTable">
                                <thead>
                                    <tr>
                                        <th>Material Type</th>
                                        <th>Total Qty (KG)</th>
                                        <th>Total Cost ()</th>
                                        <th>Avg Monthly Usage</th>
                                        <th>Reorder Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>

                        <!--  Production Recommendations -->
                        <div class="chart-container">
                            <h4> Production Recommendations</h4>
                            <ul class="top-list" id="biProductionRecommendations">
                                <!-- Recommendations will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- GODFATHER COMMAND CENTER -->
                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #e5e7eb;">
                <h3> Godfather Command Center</h3>

                <div class="report-filters">
                    <div class="form-group" style="max-width: 180px;">
                        <label>From</label>
                        <input type="date" id="gfFromDate">
                    </div>
                    <div class="form-group" style="max-width: 180px;">
                        <label>To</label>
                        <input type="date" id="gfToDate">
                    </div>
                    <button type="button" onclick="generateGodfatherReport()" class="success"
                        style="margin-top: 23px;"> Run Oracle Engine</button>
                </div>

                <div class="godfather-grid">
                    <div class="godfather-card critical" id="card-runway">
                        <h4> Production Runway</h4>
                        <div class="metric" id="kpi-runway">-- Days</div>
                        <div class="sub-metric">Until Finished Stockout (based on last 30 days)</div>
                    </div>
                    <div class="godfather-card warning" id="card-cash">
                        <h4> Cash To Collect</h4>
                        <div class="metric" id="kpi-collect">0</div>
                        <div class="sub-metric">Outstanding Customer Balance (Ledger)</div>
                    </div>
                    <div class="godfather-card success" id="card-efficiency">
                        <h4> Capital Efficiency</h4>
                        <div class="metric" id="kpi-efficiency">0.0</div>
                        <div class="sub-metric">Revenue per KG of Wire (period)</div>
                    </div>
                    <div class="godfather-card" id="card-revenue">
                        <h4> Period Revenue</h4>
                        <div class="metric" id="kpi-revenue">0</div>
                        <div class="sub-metric" id="kpi-net">Net Cash (Sales  Purchases): 0</div>
                    </div>
                </div>

                <div class="insight-grid-gf">
                    <div class="chart-container godfather">
                        <h4> The Oracle: Production Queue</h4>
                        <p style="font-size:12px; color:#7f8c8d;">Prioritized based on 30-day sales velocity vs current
                            finished stock.</p>
                        <table id="gf-production-table">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Size</th>
                                    <th>Stock (PKT)</th>
                                    <th>Daily Velocity</th>
                                    <th>Runway</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="chart-container godfather">
                        <h4> Profitability X-Ray</h4>
                        <p style="font-size:12px; color:#7f8c8d;">Top revenue-contributing sizes in the selected period.
                        </p>
                        <ul class="list-widget" id="gf-profit-list"></ul>
                    </div>
                </div>

                <!-- GODFATHER VISUAL PULSE -->
                <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #e5e7eb;">

                <h3> Godfather Visual Pulse</h3>
                <div class="button-group">
                    <button type="button" onclick="generateGodfatherVisuals()" class="success"> Update Pulse &
                        Matrix</button>
                </div>

                <div class="chart-container godfather">
                    <h4> The Pulse: Daily Sales (Last 30 Days)</h4>
                    <canvas id="chart-pulse" height="120"></canvas>
                </div>

                <div class="chart-container godfather">
                    <h4> The Matrix: Stock vs Velocity</h4>
                    <p style="font-size:12px; color:#7f8c8d;">Top-left: dead stock; bottom-right: high-risk fast movers.
                    </p>
                    <canvas id="chart-matrix" height="260"></canvas>
                </div>

                <!-- NEW VISUAL ANALYTICS SECTION -->
                <div id="report-visual-analytics" class="subtab-content">
                    <h3> Visual Analytics & Charts</h3>

                    <div class="report-filters">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" id="reportChartFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" id="reportChartToDate">
                        </div>
                        <button type="button" onclick="generateAllCharts()" class="success"> Generate All
                            Charts</button>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Profit & Loss Trend</h4>
                            <canvas id="profitLossChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Sales by Size (Top 10)</h4>
                            <canvas id="salesBySizeChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Customer Sales Distribution</h4>
                            <canvas id="customerSalesChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Purchase Categories</h4>
                            <canvas id="purchaseCategoriesChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Monthly Sales vs Purchases</h4>
                            <canvas id="monthlyTrendChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h4> Raw Material Consumption</h4>
                            <canvas id="rawMaterialChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h4> Inventory Value Distribution</h4>
                            <canvas id="inventoryValueChart" class="chart-canvas"></canvas>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Purchase Frequency Analysis</h4>
                            <canvas id="purchaseFrequencyChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>

                    <!--  Stock vs Sales chart to visualise current finished goods stock against recent sales for top sizes -->
                    <div class="charts-row">
                        <div class="chart-wrapper full-width-chart">
                            <h4> Stock vs Sales (Top Sizes)</h4>
                            <canvas id="stockVsSalesChart" class="chart-canvas"
                                style="height: 400px !important;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEDGER TAB -->
            <div id="ledger" class="tab-content">
                <h2>Ledger</h2>

                <div class="report-filters">
                    <div class="form-group" style="flex: 1; min-width: 250px;">
                        <label>Select Party (Type to search)</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="ledgerPartySearch" class="autocomplete-input"
                                placeholder="Search customer or supplier..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="ledgerPartyList"></div>
                        </div>
                        <input type="hidden" id="ledgerPartyId">
                        <input type="hidden" id="ledgerPartyType">
                    </div>
                </div>

                <div id="ledgerViewSection" style="display:none;">
                    <h3>Ledger for <span id="ledgerPartyName"></span></h3>
                    <table id="ledgerTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reference</th>
                                <th>Type</th>
                                <th>Debit ()</th>
                                <th>Credit ()</th>
                                <th>Balance ()</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    <div class="section-title">Manual Adjustment</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="manualAdjDate">
                        </div>
                        <div class="form-group">
                            <label>Debit ()</label>
                            <input type="number" id="manualAdjDebit" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Credit ()</label>
                            <input type="number" id="manualAdjCredit" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Note</label>
                            <input type="text" id="manualAdjNote" placeholder="Reason for adjustment">
                        </div>
                    </div>
                    <div class="button-group no-print">
                        <button type="button" onclick="saveManualAdjustment()" class="success"> Save
                            Adjustment</button>
                    </div>

                    <div class="dark-surface" style="margin-top: 30px;">
                        <h3 style="margin-top: 0;">Net Balance: <span class="currency" id="netBalance">0</span></h3>
                        <small id="balanceNote"></small>
                    </div>
                </div>
            </div>

            <!-- Tab: Machine Size Control -->
            <div id="size-control" class="tab-content dark-surface">
                <h2>Machine Size Control & Status</h2>
                <p>Set current size being produced and machine status. Changes apply immediately to production tracking.
                </p>

                <div class="inventory-toolbar" style="margin-top: 10px;">
                    <div>
                        <select id="machineFilterSelect" class="form-control" onchange="setMachineFilter(this.value)">
                            <option value="All">All</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                        </select>
                    </div>
                    <button class="group-btn danger" onclick="forceReinitializeMachines()">Reset Machines</button>
                </div>

                <div class="dashboard-card" style="margin-top:16px;">
                    <h3 style="margin-top:0;">Pending Size Change Requests</h3>
                    <div id="size-control-change-requests" style="margin-top:12px;"></div>
                </div>

                <div id="size-control-grid" class="machine-grid">
                    <!-- Machine cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab: Dashboard -->
            <div id="dashboard" class="tab-content dark-surface">
                <h2>Machine Dashboard</h2>
                <p>Live visibility of every machine with shift-based totals. Use the controls below to request size
                    changes for specific machines.</p>

                <div class="inventory-toolbar" style="margin-top: 10px; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Machine
                            Group</label>
                        <select id="dashboardStageFilter" class="form-control"
                            onchange="setDashboardStageFilter(this.value)">
                            <option value="All">All</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Machine</label>
                        <select id="dashboardMachineSelect" class="form-control">
                            <option value="">Select Machine</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Target Size</label>
                        <select id="dashboardSizeSelect" class="form-control">
                            <option value="">Select Size</option>
                        </select>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <label style="display:block; font-size:0.85em; color:var(--text-secondary);">Notes
                            (optional)</label>
                        <input type="text" id="dashboardChangeNote" class="form-control"
                            placeholder="Add quick note for team">
                    </div>
                    <div style="align-self:flex-end;">
                        <button class="success" onclick="submitSizeChangeRequest()">Change</button>
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">Pending Size Change Requests</h3>
                        <small style="color:var(--text-secondary);">Appears here and in Machine Size Control tab</small>
                    </div>
                    <div id="dashboard-change-requests" style="margin-top:12px;"></div>
                </div>

                <div id="dashboard-grid" class="machine-grid" style="margin-top: 20px;">
                    <!-- Dashboard machine cards -->
                </div>
            </div>

            <!-- Tab: Production Entry -->
            <div id="production-entry" class="tab-content dark-surface">
                <h2>Production Entry</h2>
                <p>Record production output from machines. Click on a machine to add bags.</p>

                <div class="production-controls"
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <select id="productionFilterSelect" class="form-control"
                            onchange="setProductionFilter(this.value)">
                            <option value="All">All Machines</option>
                            <option value="Header">Header</option>
                            <option value="Rolling">Rolling</option>
                            <option value="Furnace">Furnace</option>
                            <option value="Tampering">Tampering</option>
                            <option value="Plating">Plating</option>
                        </select>
                    </div>
                    <div class="date-display" style="font-size: 1.2em; font-weight: bold; color: var(--color-primary);">
                        Today: <span id="production-date"></span>
                    </div>
                </div>

                <div id="production-entry-grid" class="machine-grid">
                    <!-- Production cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab: Packing & Finished Goods -->
            <div id="packing" class="tab-content">
                <h2>Packing & Finished Goods</h2>
                <p>Pack items into finished goods and manage finished inventory.</p>

                <div id="packing-grid">
                    <div class="packing-layout" style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="finished-goods-section">
                            <div class="dashboard-card">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3>Pending Orders (Quotes)</h3>
                                </div>
                                <div id="pending-orders-list" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Pending orders will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="finished-goods-section">
                            <div class="dashboard-card">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3>Finished Goods Inventory</h3>
                                    <span class="badge badge-ok" style="font-size: 1.2em;">Total: <span
                                            id="total-finished-goods">0</span> Bags</span>
                                </div>

                                <div id="finished-goods-list" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Finished goods list will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="packing-entry-section" style="margin-top: 8px;">
                            <div class="dashboard-card">
                                <h3>Quick Packing Entry</h3>
                                <div class="form-group">
                                    <label>Select Size</label>
                                    <div class="autocomplete-wrapper">
                                        <input type="text" id="packing-size-search" placeholder="Search size..."
                                            list="packingSizeStageOptions" autocomplete="off"
                                            onchange="handlePackingSizeInput(this.value)">
                                        <datalist id="packingSizeStageOptions"></datalist>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Source Stage</label>
                                        <select id="packing-source-stage" onchange="updatePackingSizeOptions()">
                                            <option value="Rolling">Rolling</option>
                                            <option value="Plating">Plating</option>
                                            <option value="Furnace">Furnace</option>
                                            <option value="Tampering">Tampering</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Number of Bags</label>
                                        <input type="number" id="packing-bags" placeholder="Qty" min="1">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Remarks / Packets per Bag</label>
                                    <input type="text" id="packing-remarks" placeholder="e.g. 20 packets of 1kg">
                                </div>

                                <div class="button-group">
                                    <button class="success" onclick="packItems()"> Move to Finished Goods</button>
                                    <button onclick="clearPackingForm()">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Inventory Tracking -->
            <div id="inventory" class="tab-content dark-surface">
                <div class="inventory-toolbar">
                    <h2>Inventory Tracking</h2>
                    <div class="inventory-search">
                        <input type="text" id="inventory-search" placeholder="Search inventory by size..."
                            oninput="filterInventoryBySize(this.value)">
                        <button type="button" onclick="clearInventorySearch()"></button>
                    </div>
                </div>

                <div id="inventory-search-info" class="inventory-search-info"></div>

                <div id="inventory-grid" class="inventory-grid">
                    <!-- Inventory stages will be populated by JavaScript -->
                </div>
            </div>

            <!-- MASTERS TAB -->
            <div id="masters" class="tab-content">
                <h2>Masters</h2>

                <div class="subtabs">
                    <button class="subtab-btn active"
                        onclick="switchMastersSubtab('masters-customers', this)">Customers</button>
                    <button class="subtab-btn"
                        onclick="switchMastersSubtab('masters-suppliers', this)">Suppliers</button>
                    <button class="subtab-btn" onclick="switchMastersSubtab('masters-sizes', this)">Sizes/Items</button>
                    <button class="subtab-btn" onclick="switchMastersSubtab('masters-machines', this)">Machines</button>
                </div>

                <div id="masters-customers" class="subtab-content active">
                    <h3>Customer Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddCustomerModal()"> Add New Customer</button>
                        <button class="btn btn--secondary" onclick="openImportModal('customers')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAll('customers')">
                        <label for="selectAllCustomers">Select All</label>
                        <select id="bulkActionCustomers" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('customers')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-suppliers" class="subtab-content">
                    <h3>Supplier Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddSupplierModal()"> Add New Supplier</button>
                        <button class="btn btn--secondary" onclick="openImportModal('suppliers')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSuppliers" onchange="toggleSelectAll('suppliers')">
                        <label for="selectAllSuppliers">Select All</label>
                        <select id="bulkActionSuppliers" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('suppliers')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="suppliersTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-sizes" class="subtab-content">
                    <h3>Size/Item Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddSizeModal()"> Add New Size</button>
                        <button class="btn btn--secondary" onclick="openImportModal('sizes')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllSizes" onchange="toggleSelectAll('sizes')">
                        <label for="selectAllSizes">Select All</label>
                        <select id="bulkActionSizes" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('sizes')" class="btn btn--primary">Apply</button>
                    </div>

                    <table id="sizesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Default Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div id="masters-machines" class="subtab-content">
                    <h3>Machine Masters</h3>
                    <div class="button-group">
                        <button class="btn btn--primary" onclick="openAddMachineModal()"> Add New Machine</button>
                        <button class="btn btn--secondary" onclick="openImportModal('machines')"> Import from
                            Excel</button>
                    </div>

                    <div class="bulk-actions">
                        <input type="checkbox" id="selectAllMachines" onchange="toggleSelectAll('machines')">
                        <label for="selectAllMachines">Select All</label>
                        <select id="bulkActionMachines" style="margin-left: 10px;">
                            <option value="">Bulk Actions</option>
                            <option value="edit">Edit Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button type="button" onclick="applyBulkAction('machines')"
                            class="btn btn--primary">Apply</button>
                    </div>

                    <table id="machinesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">Select</th>
                                <th>Machine Type</th>
                                <th>Display Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="inventory" class="tab-content dark-surface">
                <div class="inventory-toolbar">
                    <div>
                        <h2>Inventory</h2>
                        <p>Real-time stock levels updated from sales and purchases.</p>
                    </div>
                    <div class="inventory-search">
                        <input type="text" id="inventorySearchInput"
                            placeholder="Search by item type (e.g., 'wire', 'screw', '2mm', etc.)">
                        <button type="button" onclick="clearInventorySearch()"></button>
                    </div>
                </div>
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Size/Item</th>
                            <th>Raw Wire (KG)</th>
                            <th>Finished Goods (PKT)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <!-- BACKUP TAB -->
            <div id="backup" class="tab-content">
                <h2>Backup & Restore</h2>
                <p>Save all data to JSON file or restore from backup.</p>

                <div class="button-group no-print">
                    <button type="button" onclick="downloadBackup()" class="success"> Download Backup</button>
                    <button type="button" onclick="document.getElementById('restoreFile').click()" class="success">
                        Restore from File</button>
                    <button type="button" onclick="cleanupDuplicateLedgers()" class="danger"> Cleanup Duplicate
                        Ledgers</button>
                    <button type="button" id="btnDedupePurchaseInvoices" class="danger"
                        title="One-time cleanup to remove duplicate purchase invoices"> Clean Duplicate Purchase
                        Invoices</button>
                    <button type="button" id="sizeIdCleanupBtn" onclick="startSizeIdMigration()"
                        title="One-time data cleanup for quoted size IDs" class="danger"> Clean Size IDs (Remove Extra
                        Quotes)</button>
                    <button type="button" id="btnRunInventoryCleanup" class="danger"
                        title="This scans legacy inventory (finishedGoods, old inventory) and writes a single normalized inventory. Existing data will be backed up. Run only once, and when no one is changing stock.">
                         Run Inventory Cleanup (One-Time)
                    </button>
                    <input type="file" id="restoreFile" style="display:none;" accept=".json"
                        onchange="restoreBackup(event)">
                </div>

                <div id="backupStatus"></div>
                <div id="sizeIdMigrationLog" style="margin-top:10px;font-size:12px;color:#374151;"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('viewInvoiceModal')">&times;</span>
            <h3>Invoice Details</h3>
            <div id="invoiceContent"></div>
            <div class="button-group no-print" style="margin-top: 20px;">
                <button type="button" onclick="window.print()" class="success"> Print Invoice</button>
                <button type="button" onclick="closeModal('viewInvoiceModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- View Quote Modal -->
    <div id="viewQuoteModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('viewQuoteModal')">&times;</span>
            <h3>Quote Details</h3>
            <div id="quoteContent"></div>
            <div class="button-group no-print" style="margin-top: 20px;">
                <button type="button" onclick="closeModal('viewQuoteModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('customerModal')">&times;</span>
            <h3>Add/Edit Customer</h3>
            <form id="customerForm" onsubmit="saveCustomer(event); return false;">
                <input type="hidden" id="customerId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                </div>
                <button type="submit" class="success"> Save Customer</button>
                <button type="button" onclick="closeModal('customerModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('supplierModal')">&times;</span>
            <h3>Add/Edit Supplier</h3>
            <form id="supplierForm" onsubmit="saveSupplier(event); return false;">
                <input type="hidden" id="supplierId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Supplier Name *</label>
                        <input type="text" id="supplierName" required>
                    </div>
                </div>
                <button type="submit" class="success"> Save Supplier</button>
                <button type="button" onclick="closeModal('supplierModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Size Modal -->
    <div id="sizeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('sizeModal')">&times;</span>
            <h3>Add/Edit Size/Item</h3>
            <form id="sizeForm" onsubmit="saveSize(event); return false;">
                <input type="hidden" id="sizeId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Code *</label>
                        <input type="text" id="sizeCode" required>
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="sizeName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Default Unit Type</label>
                        <select id="sizeUnitType">
                            <option value="KG">KG</option>
                            <option value="PKT">PKT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="sizeDesc">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Price per KG ()</label>
                        <input type="number" id="sizePriceKG" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Price per PKT ()</label>
                        <input type="number" id="sizePricePKT" step="0.01" min="0">
                    </div>
                </div>
                <button type="submit" class="success"> Save Size</button>
                <button type="button" onclick="closeModal('sizeModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('importModal')">&times;</span>
            <h3 id="importModalTitle">Import Excel</h3>
            <input type="hidden" id="importType">

            <div id="importStep1">
                <p>Select Excel or CSV file to import:</p>
                <input type="file" id="importFile" accept=".xlsx,.xls,.csv" onchange="previewExcelFile(event)">
                <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">Supports XLSX, XLS, and CSV formats. All
                    rows will be imported (no limit).</p>
            </div>

            <div id="importStep2" style="display:none;">
                <p>Map columns from Excel to database fields:</p>
                <div id="columnMappingUI"></div>
                <button type="button" onclick="confirmImport()" class="success"> Import Data</button>
                <button type="button" onclick="cancelImport()">Cancel</button>
            </div>

            <div id="importStep3" style="display:none;">
                <div class="alert success" id="importMessage"> Import completed successfully!</div>
                <button type="button" onclick="closeModal('importModal')">Close</button>
            </div>
        </div>
    </div>

    <datalist id="sizeOptionsList"></datalist>
    <datalist id="quoteSizeOptions"></datalist>
    <div id="toast" aria-live="polite" aria-atomic="true"></div>

    <script>
        // ========== Firebase Configuration ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAvWG3-sFi3gjOzJj0AmpqK1M1KMTdA348",
            authDomain: "bokki-7bf3c.firebaseapp.com",
            databaseURL: "https://bokki-7bf3c-default-rtdb.firebaseio.com",
            projectId: "bokki-7bf3c",
            storageBucket: "bokki-7bf3c.firebasestorage.app",
            messagingSenderId: "1068686831368",
            appId: "1:1068686831368:web:96ed8e8a698e7900d0c6bd"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========== Key Sanitization Functions ==========
        function sanitizeKey(key) {
            if (!key) return key;
            return key.toString()
                .replace(/\./g, '_dot_')
                .replace(/\#/g, '_hash_')
                .replace(/\$/g, '_dollar_')
                .replace(/\[/g, '_openbracket_')
                .replace(/\]/g, '_closebracket_')
                .replace(/\//g, '_slash_');
        }

        function unsanitizeKey(key) {
            if (!key) return key;
            return key.toString()
                .replace(/_dot_/g, '.')
                .replace(/_hash_/g, '#')
                .replace(/_dollar_/g, '$')
                .replace(/_openbracket_/g, '[')
                .replace(/_closebracket_/g, ']')
                .replace(/_slash_/g, '/');
        }

        function getInventorySizeKey(key) {
            return sanitizeKey(key || 'UNKNOWN_SIZE');
        }



        // Util: Promise timeout to avoid silent hangs on network/db issues
        function withTimeout(promise, ms, msg) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error(msg || 'Operation timed out')), ms))
            ]);
        }


        // Wait until Firebase .info/connected flips true (up to timeout). Returns boolean instead of throwing.
        async function waitForOnline(timeoutMs = 8000) {
            const start = Date.now();
            while (!isConnected && (Date.now() - start) < timeoutMs) {
                await new Promise(r => setTimeout(r, 150));
            }
            return isConnected;
        }
        // ========== Firebase Helper Functions ==========
        let isConnected = false;
        let offlineTimer = null;

        function markConnecting() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl && statusEl.textContent !== ' Online') {
                statusEl.textContent = ' Connecting...';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // Check Firebase connection status
        function checkConnection() {
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function (snap) {
                if (snap.val() === true) {
                    clearTimeout(offlineTimer);
                    offlineTimer = null;
                    markOnline();
                    flushPendingWrites();
                } else {
                    isConnected = false;
                    markConnecting();
                    clearTimeout(offlineTimer);
                    offlineTimer = setTimeout(() => {
                        if (!isConnected) {
                            const statusEl = document.getElementById('connectionStatus');
                            if (statusEl) {
                                statusEl.textContent = ' Offline';
                                statusEl.className = 'connection-status disconnected';
                            }
                        }
                    }, 7000);
                }
                App.ui.updatePendingBadge();
            });
        }

        // Firebase database helper functions
        async function fbInsert(storeName, data) {
            const ref = database.ref(storeName).push();
            const key = ref.key;
            if (data.id) {
                data.id = sanitizeKey(data.id);
            }
            await withTimeout(ref.set(data), 12000, 'DB write timed out');
            markOnline();
            return key;
        }

        async function fbPut(storeName, key, data) {
            const sanitizedKey = sanitizeKey(key);
            if (data.id) {
                data.id = sanitizeKey(data.id);
            }
            await withTimeout(database.ref(`${storeName}/${sanitizedKey}`).set(data), 12000, 'DB write timed out');
            markOnline();
            return sanitizedKey;
        }

        async function fbDelete(storeName, key) {
            const sanitizedKey = sanitizeKey(key);
            await database.ref(`${storeName}/${sanitizedKey}`).remove();
            markOnline();
        }

        async function fbGet(storeName, key) {
            const sanitizedKey = sanitizeKey(key);
            const snapshot = await database.ref(`${storeName}/${sanitizedKey}`).once('value');
            const data = snapshot.val();
            markOnline();
            if (data && data.id) {
                data.id = unsanitizeKey(data.id);
            }
            return data;
        }

        async function fbGetAll(storeName) {
            const snapshot = await database.ref(storeName).once('value');
            const results = [];
            snapshot.forEach((childSnapshot) => {
                let data = childSnapshot.val();
                if (data && data.id) {
                    data.id = unsanitizeKey(data.id);
                }
                results.push({
                    ...data,
                    id: data.id || childSnapshot.key
                });
            });
            markOnline();
            return results;
        }

        // ========== Core App Namespace & Utilities ==========
        /**
         * Core reference data schemas for the app.
         *
         * These objects describe the **intended shape** of the main entities.
         * They are NOT used to mutate live data yet in this step.
         * They exist only as a single source of truth for the expected fields.
         */
        const Schemas = {
            /**
             * A screw size / item definition.
             * This corresponds to a record in the Sizes master.
             */
            size: {
                /** Stable internal id  e.g. "SIZE_M4_20" or Firebase key */
                id: '',
                /** Short human code  e.g. "#8", "M4" */
                code: '',
                /** Full human label  e.g. "#8 x 3/4\"", "#6 x 1\"" */
                label: '',
                /** Optional: type/category of screw  e.g. "SDS", "CSK", "Chipboard" */
                type: '',
                /** Optional: HSN code for GST and reports */
                hsn: '',
                /** Optional: any remarks or notes */
                remarks: '',
                /** Optional: whether this size is active in masters */
                isActive: true
            },

            /**
             * A party = customer or supplier.
             * Party type determines the role.
             */
            party: {
                /** Stable internal id  usually the Firebase key */
                id: '',
                /** "customer" or "supplier" */
                type: '',
                /** Display name of the party */
                name: '',
                /** Phone number */
                phone: '',
                /** GST number (if any) */
                gstNumber: '',
                /** Full address text */
                address: '',
                /** City */
                city: '',
                /** State */
                state: '',
                /** Optional: opening balance or reference info */
                openingBalance: 0,
                /** Whether this party is active */
                isActive: true,
                /** Timestamp when created (ms since epoch) */
                createdAt: 0,
                /** Timestamp when last updated (ms since epoch) */
                updatedAt: 0
            },

            /**
             * One line inside an invoice.
             * Used for both sales and purchase invoices.
             */
            invoiceLine: {
                /** Optional per-line id, can be index-based or UUID */
                id: '',
                /** Size id (foreign key to Schemas.size.id) */
                sizeId: '',
                /** Human description, usually derived from size label + extra text */
                description: '',
                /** HSN code for this line (can come from size or overridden manually) */
                hsn: '',
                /** Quantity (pcs, kg, etc.) */
                quantity: 0,
                /** Rate per unit */
                rate: 0,
                /** Basic amount before tax = quantity * rate */
                amount: 0,
                /** Tax percentage for this line  e.g. 18, 5, 0 */
                taxPercent: 0,
                /** Tax amount for this line */
                taxAmount: 0,
                /** Line total including tax = amount + taxAmount */
                totalWithTax: 0,
                /** Optional: unit, e.g. "pcs", "kg", etc. */
                unit: '',
                /** Optional: free-form remarks */
                remarks: ''
            },

            /**
             * Invoice document  sales or purchase.
             */
            invoice: {
                /** Stable id, ideally same as Firebase key */
                id: '',
                /** "sales" or "purchase" */
                type: '',
                /** Human-visible invoice number (e.g. "S-2025-0012") */
                number: '',
                /** ISO date string "YYYY-MM-DD" */
                date: '',
                /** Party id (customer or supplier) */
                partyId: '',
                /** Snapshot of party name at the time of invoice creation */
                partyNameSnapshot: '',
                /** Snapshot of party GST at time of creation */
                partyGstSnapshot: '',
                /** List of invoice lines */
                items: [],
                /** Subtotal (sum of line amounts before tax) */
                subtotal: 0,
                /** Total of all per-line tax amounts */
                taxTotal: 0,
                /** Additional / other tax (like CESS, etc.), optional */
                additionalTax: 0,
                /** Grand total after tax and round-off */
                grandTotal: 0,
                /** Round off adjustment applied to match actual total */
                roundOff: 0,
                /** Payment mode or terms, optional */
                paymentMode: '',
                /** Narration / notes visible on invoice and in ledger */
                narration: '',
                /** Timestamp when created */
                createdAt: 0,
                /** Timestamp when last updated */
                updatedAt: 0,
                /** User id / name that created this invoice */
                createdBy: '',
                /** User id / name that last updated this invoice */
                updatedBy: '',
                /** Flag for soft cancel / delete */
                isCancelled: false
            },

            /**
             * Inventory item representing stock for a particular size and category.
             */
            inventoryItem: {
                /** Stable id for this inventory record (can be sizeId-based or Firebase key) */
                id: '',
                /** Inventory category: "Raw Material", "Finished Goods", etc. */
                category: '',
                /** Size id for this inventory entry */
                sizeId: '',
                /** Current quantity in stock */
                quantity: 0,
                /** Unit of quantity: "kg", "pcs", etc. */
                unit: '',
                /**
                 * Source of this stock movement  e.g.
                 * "opening", "purchase", "production", "packing", "adjustment".
                 */
                source: '',
                /** Timestamp when this record was last updated */
                lastUpdatedAt: 0,
                /** User id / name that last updated this record */
                lastUpdatedBy: '',
                /** Optional remarks for adjustments etc. */
                remarks: ''
            }
        };

        /**
         * Factory helpers to create empty, normalized objects
         * that match the reference Schemas above.
         *
         * In this step, these are not yet wired into the rest of the app.
         * They are just utilities for future steps.
         */
        const ModelFactory = {
            /**
             * Create an empty Size record.
             */
            createEmptySize() {
                return {
                    id: '',
                    code: '',
                    label: '',
                    type: '',
                    hsn: '',
                    remarks: '',
                    isActive: true
                };
            },

            /**
             * Create an empty Party record.
             * @param {"customer"|"supplier"|""} type
             */
            createEmptyParty(type = '') {
                return {
                    id: '',
                    type,
                    name: '',
                    phone: '',
                    gstNumber: '',
                    address: '',
                    city: '',
                    state: '',
                    openingBalance: 0,
                    isActive: true,
                    createdAt: 0,
                    updatedAt: 0
                };
            },

            /**
             * Create an empty InvoiceLine.
             */
            createEmptyInvoiceLine() {
                return {
                    id: '',
                    sizeId: '',
                    description: '',
                    hsn: '',
                    quantity: 0,
                    rate: 0,
                    amount: 0,
                    taxPercent: 0,
                    taxAmount: 0,
                    totalWithTax: 0,
                    unit: '',
                    remarks: ''
                };
            },

            /**
             * Create an empty Invoice (sales or purchase).
             * @param {"sales"|"purchase"|""} type
             */
            createEmptyInvoice(type = '') {
                return {
                    id: '',
                    type,
                    number: '',
                    date: '',
                    partyId: '',
                    partyNameSnapshot: '',
                    partyGstSnapshot: '',
                    items: [],
                    subtotal: 0,
                    taxTotal: 0,
                    additionalTax: 0,
                    grandTotal: 0,
                    roundOff: 0,
                    paymentMode: '',
                    narration: '',
                    createdAt: 0,
                    updatedAt: 0,
                    createdBy: '',
                    updatedBy: '',
                    isCancelled: false
                };
            },

            /**
             * Create an empty InventoryItem.
             * @param {string} category
             */
            createEmptyInventoryItem(category = '') {
                return {
                    id: '',
                    category,
                    sizeId: '',
                    quantity: 0,
                    unit: '',
                    source: '',
                    lastUpdatedAt: 0,
                    lastUpdatedBy: '',
                    remarks: ''
                };
            }
        };

        /**
         * Normalize a raw size record from Firebase into a canonical Size object.
         * This does NOT write anything back; it only shapes the object.
         *
         * @param {any} raw - raw size object from Firebase or older code
         * @param {string} keyFromDb - Firebase key, used as fallback id
         * @returns {object|null} - normalized size object or null if invalid
         */
        function normalizeSize(raw, keyFromDb) {
            if (!raw) return null;

            const base = ModelFactory.createEmptySize();

            // Prefer explicit id from record, else fall back to DB key
            let id =
                raw.id ||
                raw.size_id ||
                raw.sizeId ||
                keyFromDb ||
                '';

            // Strip accidental wrapping quotes like "\"SIZE_12\""
            if (id.startsWith('"') && id.endsWith('"')) {
                id = id.slice(1, -1);
            }

            base.id = id;

            // Human fields: name/label/code
            const name =
                raw.label ||
                raw.size_name ||
                raw.name ||
                raw.description ||
                raw.full_label ||
                '';

            const code =
                raw.code ||
                raw.size_code ||
                raw.short_code ||
                raw.item_code ||
                '';

            base.code = String(code || '').trim();

            // If explicit label missing, try to assemble from parts
            let label = String(name || '').trim();
            if (!label) {
                const dia = raw.diameter || raw.dia || '';
                const len = raw.length || raw.len || '';
                const type = raw.type || raw.screw_type || '';
                const parts = [dia, len, type].filter(Boolean);
                label = parts.join(' ');
            }
            if (!label) {
                label = base.code || base.id;
            }
            base.label = label;

            // Optional type/category and HSN
            base.type = String(raw.type || raw.category || raw.size_type || raw.screw_type || '').trim();
            base.hsn = String(raw.hsn || raw.hsn_code || '').trim();
            base.remarks = String(raw.remarks || raw.notes || '').trim();

            // Active flag
            if (typeof raw.isActive === 'boolean') {
                base.isActive = raw.isActive;
            } else if (typeof raw.active === 'boolean') {
                base.isActive = raw.active;
            } else {
                base.isActive = true;
            }

            // Copy over any extra original fields so old code still sees them
            return { ...raw, ...base };
        }

        /**
         * Update in-memory size caches from raw Firebase data map.
         *
         * @param {object|Array} sizesSnapshot - map or array of raw size records
         */
        function updateSizeCaches(sizesSnapshot) {
            const byId = {};
            const list = [];

            const process = (raw, key) => {
                const normalized = normalizeSize(raw, key);
                if (normalized && normalized.id) {
                    byId[normalized.id] = normalized;
                    list.push(normalized);
                }
            };

            if (Array.isArray(sizesSnapshot)) {
                sizesSnapshot.forEach(raw => process(raw, raw.id));
            } else if (sizesSnapshot && typeof sizesSnapshot === 'object') {
                Object.keys(sizesSnapshot).forEach(key => process(sizesSnapshot[key], key));
            }

            if (!App.state.sizes) {
                App.state.sizes = { byId: {}, list: [] };
            }

            App.state.sizes.byId = byId;
            App.state.sizes.list = list;
        }

        function getSizeById(sizeId) {
            if (!sizeId || !App.state.sizes) return null;
            return App.state.sizes.byId[sizeId] || null;
        }

        function getSizeLabel(sizeId, fallback) {
            const rec = getSizeById(sizeId);
            if (rec && rec.label) return rec.label;
            if (rec && rec.code) return rec.code;
            return fallback || (sizeId || '');
        }

        /**
         * For places that still hold a "sizeKey" or raw object, normalize the id first.
         */
        function resolveSizeIdFromAny(lineOrRecord, fallback) {
            let id =
                (lineOrRecord && (lineOrRecord.sizeId || lineOrRecord.size_id || lineOrRecord.size || lineOrRecord.sizeKey)) ||
                fallback ||
                '';

            id = String(id || '').trim();
            if (id.startsWith('"') && id.endsWith('"')) {
                id = id.slice(1, -1);
            }
            return id;
        }

        /**
         * Normalize a customer/supplier ("party") record.
         *
         * @param {any} raw - raw party record from Firebase
         * @param {"customer"|"supplier"|""} type - expected type, may be empty
         * @param {string} keyFromDb - Firebase key, fallback for id
         */
        function normalizeParty(raw, type, keyFromDb) {
            if (!raw) return null;

            const base = ModelFactory.createEmptyParty(type || '');

            const id =
                raw.id ||
                raw.party_id ||
                raw.customer_id ||
                raw.supplier_id ||
                keyFromDb ||
                '';

            base.id = String(id || '').trim();

            // Decide type from hints if not provided
            let resolvedType = type || '';
            if (!resolvedType) {
                if (raw.type === 'customer' || raw.isCustomer) resolvedType = 'customer';
                else if (raw.type === 'supplier' || raw.isSupplier) resolvedType = 'supplier';
            }
            base.type = resolvedType || (raw.type || '');

            // Name: prefer display_name
            const name =
                raw.display_name ||
                raw.name ||
                raw.customer_name ||
                raw.supplier_name ||
                '';

            base.name = String(name || '').trim();
            base.phone = String(raw.phone || raw.mobile || raw.contact || '').trim();
            base.gstNumber = String(raw.gstNumber || raw.gst_no || raw.gstin || '').trim();
            base.address = String(raw.address || raw.full_address || '').trim();
            base.city = String(raw.city || '').trim();
            base.state = String(raw.state || '').trim();

            const opening = Number(raw.openingBalance || raw.opening_balance || 0);
            base.openingBalance = isNaN(opening) ? 0 : opening;

            if (typeof raw.isActive === 'boolean') {
                base.isActive = raw.isActive;
            } else if (typeof raw.active === 'boolean') {
                base.isActive = raw.active;
            } else {
                base.isActive = true;
            }

            base.createdAt = raw.createdAt || raw.created_at || 0;
            base.updatedAt = raw.updatedAt || raw.updated_at || 0;

            // Return merged: new canonical fields + original for compatibility
            return { ...raw, ...base };
        }

        /**
         * Update in-memory caches for customers and suppliers from raw Firebase data.
         *
         * @param {object|Array} customersData - map or array of raw customer records
         * @param {object|Array} suppliersData - map or array of raw supplier records
         */
        function updatePartyCaches(customersData, suppliersData) {
            const customersById = {};
            const suppliersById = {};

            const process = (data, type, targetMap) => {
                if (Array.isArray(data)) {
                    data.forEach(raw => {
                        const normalized = normalizeParty(raw, type, raw.id);
                        if (normalized && normalized.id) targetMap[normalized.id] = normalized;
                    });
                } else if (data && typeof data === 'object') {
                    Object.keys(data).forEach(key => {
                        const raw = data[key];
                        const normalized = normalizeParty(raw, type, key);
                        if (normalized && normalized.id) targetMap[normalized.id] = normalized;
                    });
                }
            };

            process(customersData, 'customer', customersById);
            process(suppliersData, 'supplier', suppliersById);

            if (!App.state.parties) {
                App.state.parties = { customersById: {}, suppliersById: {} };
            }

            App.state.parties.customersById = customersById;
            App.state.parties.suppliersById = suppliersById;
        }

        function getCustomerById(id) {
            if (!id || !App.state.parties) return null;
            return App.state.parties.customersById[id] || null;
        }

        function getSupplierById(id) {
            if (!id || !App.state.parties) return null;
            return App.state.parties.suppliersById[id] || null;
        }

        function getPartyNameDisplay(type, partyId, fallbackName) {
            const rec = type === 'purchase'
                ? getSupplierById(partyId)
                : getCustomerById(partyId);

            if (rec && rec.name) return rec.name;
            return fallbackName || '';
        }

        function normalizeInventoryItem(raw, category, keyFromDb) {
            if (!raw && !keyFromDb) return null;

            const candidate =
                raw && (raw.sizeId || raw.size_id || raw.size || raw.sizeKey || raw.current_size);
            let sizeId = resolveSizeIdFromAny(candidate || keyFromDb || '');

            if (!sizeId) return null;

            let qty = 0;
            if (raw) {
                // Handle simple number values (legacy structure) or object values
                const val = typeof raw === 'number' ? raw : (raw.qty || raw.quantity || raw.closingQty || raw.stock || raw.closing_stock || 0);
                qty = Number(val);
            }
            if (!Number.isFinite(qty)) qty = 0;

            const unit = (raw && (raw.unit || raw.uom || raw.qtyUnit)) || '';

            const now = Date.now();
            const item = {
                sizeId: String(sizeId),
                qty,
                unit,
                category: String(category || (raw && raw.category) || '').trim() || 'Finished Goods',
                source: (raw && (raw.source || raw.lastSource)) || 'migration',
                lastUpdatedAt: raw && raw.lastUpdatedAt ? raw.lastUpdatedAt : now,
                lastUpdatedBy: raw && raw.lastUpdatedBy ? raw.lastUpdatedBy : 'system-migration'
            };

            return { ...raw, ...item };
        }

        function buildNormalizedInventory(rawRoot) {
            const normalized = {};

            function ensureCategory(cat) {
                if (!normalized[cat]) normalized[cat] = {};
                return normalized[cat];
            }

            // 1) New style inventory (if present)
            if (rawRoot && rawRoot.inventory) {
                Object.keys(rawRoot.inventory).forEach(category => {
                    const catItems = rawRoot.inventory[category] || {};
                    const normCat = ensureCategory(category);

                    Object.keys(catItems).forEach(key => {
                        const rawItem = catItems[key];
                        const norm = normalizeInventoryItem(rawItem, category, key);
                        if (!norm) return;

                        const id = norm.sizeId;
                        const existing = normCat[id];

                        if (!existing) {
                            normCat[id] = norm;
                        } else {
                            const qty = Number(existing.qty || 0) + Number(norm.qty || 0);
                            normCat[id] = { ...existing, ...norm, qty };
                        }
                    });
                });
            }

            // 2) Legacy finishedGoods  "Finished Goods" category
            if (rawRoot && rawRoot.finishedGoods) {
                const category = 'Finished Goods';
                const catItems = rawRoot.finishedGoods;
                const normCat = ensureCategory(category);

                Object.keys(catItems).forEach(key => {
                    const rawItem = catItems[key];
                    const norm = normalizeInventoryItem(rawItem, category, key);
                    if (!norm) return;

                    const id = norm.sizeId;
                    const existing = normCat[id];

                    if (!existing) {
                        normCat[id] = norm;
                    } else {
                        const qty = Number(existing.qty || 0) + Number(norm.qty || 0);
                        normCat[id] = { ...existing, ...norm, qty };
                    }
                });
            }

            return normalized;
        }

        async function runInventoryCleanup() {
            try {
                // 1) Build a small root snapshot with relevant inventory branches
                const rootSnapshot = {
                    inventory: await fbGet('inventory') || {},
                    finishedGoods: await fbGet('finishedGoods') || {}
                };

                // 2) Build normalized inventory
                const normalizedInventory = buildNormalizedInventory(rootSnapshot);

                // 3) Backup legacy branches
                const backup = {
                    finishedGoods: rootSnapshot.finishedGoods,
                    inventory_old: rootSnapshot.inventory,
                    timestamp: Date.now()
                };
                await fbSet('inventory_legacy_backup', backup);

                // 4) Write new inventory
                await fbSet('inventory', normalizedInventory);

                // 5) Update local state
                appState.inventory = normalizedInventory;

                console.log('Inventory cleanup completed', normalizedInventory);
                alert('Inventory cleanup completed successfully. All stock is now unified.');
                recordActionLog('Inventory Cleanup', 'Ran inventory cleanup migration', {
                    timestamp: new Date().toISOString(),
                    details: 'Unified finishedGoods and inventory into single inventory structure'
                });

                // Refresh views
                if (typeof renderInventoryTab === 'function') renderInventoryTab();
                if (typeof renderFinishedGoodsList === 'function') renderFinishedGoodsList();

            } catch (err) {
                App.ui.reportIssue('Inventory cleanup failed', err, 'error');
                alert('Inventory cleanup failed. Check console for details.');
            }
        }

        function setInvoicesInState(type, invoicesArray) {
            if (!App.state.invoices) {
                App.state.invoices = { sales: [], purchase: [] };
            }
            if (type === 'sales') {
                App.state.invoices.sales = invoicesArray;
            } else if (type === 'purchase') {
                App.state.invoices.purchase = invoicesArray;
            }
        }

        function upsertInvoiceInState(type, normalizedInvoice) {
            if (!App.state.invoices) {
                App.state.invoices = { sales: [], purchase: [] };
            }
            const list = type === 'purchase'
                ? App.state.invoices.purchase
                : App.state.invoices.sales;

            const idx = list.findIndex(inv => inv.id === normalizedInvoice.id);
            if (idx >= 0) {
                list[idx] = normalizedInvoice;
            } else {
                list.push(normalizedInvoice);
            }
        }

        // ========== CONSTANTS ==========
        const ALL_TABS = [
            'dashboard',
            'sales',
            'purchase',
            'inventory',
            'production-entry',
            'packing',
            'reports',
            'ledger',
            'size-control',
            'masters',
            'backup',
            'users'
        ];

        const App = {
            state: {
                customers: [],
                suppliers: [],
                sizes: { byId: {}, list: [] },
                invoices: { sales: [], purchase: [] },
                pendingWrites: [],
                role: 'Admin',
                role: 'Admin',
                currentUser: null
            },
            auth: {
                usersById: {},
                usersByUsername: {},
                rolesById: {},
                currentUser: null
            },
            cache: {
                customersById: {},
                suppliersById: {},
                sizesById: {}
            },
            permissions: {
                Admin: { editInvoices: true, deleteInvoices: true, manageMasters: true, viewReports: true },
                Manager: { editInvoices: true, deleteInvoices: false, manageMasters: true, viewReports: true },
                Viewer: { editInvoices: false, deleteInvoices: false, manageMasters: false, viewReports: true }
            },
            utils: {},
            ui: {},
            db: {},
            invoiceEngine: {}
        };
        window.App = App;

        function loadPendingQueue() {
            try {
                const raw = localStorage.getItem('factory_pending_writes');
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (err) {
                console.warn('Failed to parse pending queue', err);
                return [];
            }
        }

        function persistPendingQueue() {
            try {
                localStorage.setItem('factory_pending_writes', JSON.stringify(App.state.pendingWrites.slice(0, 50)));
            } catch (err) {
                console.warn('Unable to persist pending queue', err);
            }
        }

        App.ui.updatePendingBadge = function () {
            const badge = document.getElementById('pendingSyncBadge');
            if (!badge) return;
            const count = App.state.pendingWrites.length;
            badge.textContent = count ? `${count} pending` : '';
            badge.style.display = count ? 'inline-flex' : 'none';
        };

        App.state.pendingWrites = loadPendingQueue();
        App.ui.updatePendingBadge();

        App.ui.toastTimeout = null;
        App.ui.showToast = function (message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.className = '';
            toast.textContent = message;
            toast.classList.add('show', type);
            clearTimeout(App.ui.toastTimeout);
            App.ui.toastTimeout = setTimeout(() => {
                toast.classList.remove('show', 'success', 'error', 'warning', 'info');
            }, 3600);
        };

        App.ui.reportIssue = function (context, err, severity = 'error') {
            const base = context || 'Unexpected error';
            let msg = base;

            if (err && err.message) {
                msg = `${base}: ${err.message}`;
            }

            console.error(base, err);
            App.ui.showToast(msg, severity);
        };

        App.utils.debounce = function (fn, wait = 300) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(null, args), wait);
            };
        };

        App.utils.formatCurrency = (num) => `${(Number(num) || 0).toFixed(2)}`;

        App.utils.resolveName = function (type, id, fallback = 'N/A') {
            return getPartyNameDisplay(type, id, fallback);
        };

        App.utils.resolveSizeName = function (sizeId, fallback = 'N/A') {
            return getSizeLabel(sizeId, fallback);
        };

        // Migration helper: clean quoted size IDs like "\"ID_123\"" or "'ID_123'" -> ID_123
        function cleanSizeIdForMigration(raw) {
            if (raw === null || raw === undefined) return raw;
            if (typeof raw !== 'string') return raw;
            let s = raw.trim();
            if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
                s = s.slice(1, -1);
            }
            return s;
        }

        function markOnline() {
            isConnected = true;
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = ' Online';
                statusEl.className = 'connection-status connected';
            }
        }

        // Core data snapshot loader to populate state even if realtime listeners lag
        async function fetchCoreDataSnapshot() {
            try {
                const [customers, suppliers, sizes, sales, purchases] = await Promise.all([
                    fbGetAll('customers').catch(() => []),
                    fbGetAll('suppliers').catch(() => []),
                    fbGetAll('sizes').catch(() => []),
                    App.db.listInvoices('sales'),
                    App.db.listInvoices('purchase')
                ]);
                updateCaches(customers, 'customers');
                updateCaches(suppliers, 'suppliers');
                updateCaches(sizes, 'sizes');
                updatePartyCaches(customers, suppliers);
                updateSizeCaches(sizes);
                debouncedRefreshCustomersTable();
                debouncedRefreshSuppliersTable();
                debouncedRefreshSizesTable();
                debouncedRefreshSalesInvoiceList();
                debouncedRefreshPurchaseInvoiceList();
            } catch (err) {
                App.ui.reportIssue('Core data snapshot fetch failed', err, 'error');
            }
        }

        // Wire up search inputs to live filtering
        function bindInvoiceSearchListeners() {
            const salesSearchEl = document.getElementById('salesInvoiceSearch');
            if (salesSearchEl) {
                salesSearchEl.addEventListener('input', () => App.invoiceEngine.renderInvoiceTable('sales'));
            }
            const purchaseSearchEl = document.getElementById('purchaseInvoiceSearch');
            if (purchaseSearchEl) {
                purchaseSearchEl.addEventListener('input', () => App.invoiceEngine.renderInvoiceTable('purchase'));
            }
            const purchaseCategoryEl = document.getElementById('purchaseCategoryFilter');
            if (purchaseCategoryEl) {
                purchaseCategoryEl.addEventListener('change', () => App.invoiceEngine.renderInvoiceTable('purchase'));
            }
        }

        function bindDedupePurchaseButton() {
            const btn = document.getElementById('btnDedupePurchaseInvoices');
            if (!btn) return;
            btn.addEventListener('click', async () => {
                const ok = confirm('This will scan purchase invoices and remove exact duplicate copies from the database. One copy is kept and deletions are logged. Run now?');
                if (!ok) return;
                const originalText = btn.textContent;
                try {
                    btn.disabled = true;
                    btn.textContent = 'Cleaning duplicates...';
                    await App.db.dedupePurchaseInvoices();
                } catch (err) {
                    console.error('Purchase invoice dedupe failed', err);
                    alert('Error cleaning duplicate purchase invoices: ' + (err && err.message ? err.message : err));
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        }

        // Shared helpers for reports to ensure consistent totals
        async function getReportInvoices(type) {
            try {
                return await App.db.listInvoices(type);
            } catch (err) {
                console.warn(`Report fetch failed for ${type}, falling back to cache`, err);
                return Array.isArray(App.state.invoices[type === 'sales' ? 'sales' : 'purchase']) ? App.state.invoices[type === 'sales' ? 'sales' : 'purchase'] : [];
            }
        }

        function computeInvoiceTotalsForReport(inv, type) {
            const lines = Array.isArray(inv.lines) ? inv.lines : [];
            return App.invoiceEngine.calculateTotals(type, lines, inv.invoice_tax);
        }

        // ======== One-time Size ID Cleanup Migration ========
        function appendSizeIdLog(msg) {
            console.log('[SizeIDMigration]', msg);
            const logBox = document.getElementById('sizeIdMigrationLog');
            if (logBox) {
                const line = document.createElement('div');
                line.textContent = msg;
                logBox.appendChild(line);
            }
        }

        function startSizeIdMigration() {
            if (!confirm('This will scan Firebase and clean size IDs stored like \"ID_123\" or \'ID_123\'. It will not delete data. Run now?')) return;
            const btn = document.getElementById('sizeIdCleanupBtn');
            if (btn) btn.disabled = true;
            runSizeIdCleanupMigration().finally(() => { if (btn) btn.disabled = false; });
        }

        // ======== Core App Init ========
        async function initApp() {
            try {
                checkConnection();
                setupRealtimeListeners();
                fetchCoreDataSnapshot();
                // Set default dates
                const today = getToday();
                const firstDay = getFirstDayOfMonth ? getFirstDayOfMonth() : today;
                if (document.getElementById('saleDate')) document.getElementById('saleDate').value = today;
                if (document.getElementById('purchaseDate')) document.getElementById('purchaseDate').value = today;
                if (document.getElementById('manualAdjDate')) document.getElementById('manualAdjDate').value = today;
                if (document.getElementById('reportPLFromDate')) document.getElementById('reportPLFromDate').value = firstDay;
                if (document.getElementById('reportPLToDate')) document.getElementById('reportPLToDate').value = today;
                if (document.getElementById('reportPLTaxFromDate')) document.getElementById('reportPLTaxFromDate').value = firstDay;
                if (document.getElementById('reportPLTaxToDate')) document.getElementById('reportPLTaxToDate').value = today;
                if (document.getElementById('reportGSTFromDate')) document.getElementById('reportGSTFromDate').value = firstDay;
                if (document.getElementById('reportGSTToDate')) document.getElementById('reportGSTToDate').value = today;
                if (document.getElementById('reportSizeFromDate')) document.getElementById('reportSizeFromDate').value = firstDay;
                if (document.getElementById('reportSizeToDate')) document.getElementById('reportSizeToDate').value = today;
                if (document.getElementById('reportSizePurchaseFromDate')) document.getElementById('reportSizePurchaseFromDate').value = firstDay;
                if (document.getElementById('reportSizePurchaseToDate')) document.getElementById('reportSizePurchaseToDate').value = today;

                // Initialize Admin Inventory Tools
                initAdminInventoryTools();
            } catch (err) {
                App.ui.reportIssue('Error in initApp', err, 'error');
            }
        }

        // Initialize Admin Inventory Tools
        function initAdminInventoryTools() {
            // Button moved to Backup tab, no wrapper check needed.

            const btn = document.getElementById('btnRunInventoryCleanup');
            if (!btn) return;

            // Prevent double-binding
            if (btn._inventoryCleanupWired) return;
            btn._inventoryCleanupWired = true;

            btn.addEventListener('click', async () => {
                const msg = [
                    'This will normalize all inventory and finishedGoods data',
                    'into a single inventory structure under "inventory".',
                    '',
                    'Existing "inventory" and "finishedGoods" will be backed up to',
                    '"inventory_legacy_backup".',
                    '',
                    'Run this only once, and when nobody is changing stock.',
                    '',
                    'Do you want to continue?'
                ].join('\n');

                if (!confirm(msg)) return;

                try {
                    await runInventoryCleanup();

                    // Reload inventory into memory
                    if (!window.appState) window.appState = {};
                    if (typeof fbGet === 'function') {
                        const inv = await fbGet('inventory') || {};
                        appState.inventory = inv;
                    }

                    // Refresh inventory-related UI if these functions exist
                    if (typeof renderInventoryTab === 'function') {
                        renderInventoryTab();
                    }
                    if (typeof renderFinishedGoodsList === 'function') {
                        renderFinishedGoodsList();
                    }

                    alert('Inventory cleanup completed successfully.');
                } catch (err) {
                    console.error('Inventory cleanup failed', err);
                    alert('Inventory cleanup failed. Check console for details.');
                }
            });
        }
        async function runSizeIdCleanupMigration() {
            const result = {
                totalUpdated: 0,
                perPath: {}
            };
            const tasks = [
                {
                    path: 'salesInvoices',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId', 'current_size'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'purchaseInvoices',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId', 'current_size'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'quotes',
                    handler: (val, childKey, updates) => {
                        (val.lines || []).forEach((line, idx) => {
                            ['size_id', 'sizeId'].forEach(k => {
                                const cleaned = cleanSizeIdForMigration(line[k]);
                                if (cleaned !== line[k]) {
                                    updates[`${childKey}/lines/${idx}/${k}`] = cleaned;
                                    result.totalUpdated++;
                                }
                            });
                        });
                    }
                },
                {
                    path: 'stockLevels',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id);
                        if (cleaned !== val.size_id) {
                            updates[`${childKey}/size_id`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                },
                {
                    path: 'productionEntries',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id || val.sizeId);
                        if (cleaned !== (val.size_id || val.sizeId)) {
                            if (val.size_id !== undefined) updates[`${childKey}/size_id`] = cleaned;
                            if (val.sizeId !== undefined) updates[`${childKey}/sizeId`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                },
                {
                    path: 'packingEntries',
                    handler: (val, childKey, updates) => {
                        const cleaned = cleanSizeIdForMigration(val.size_id || val.sizeId);
                        if (cleaned !== (val.size_id || val.sizeId)) {
                            if (val.size_id !== undefined) updates[`${childKey}/size_id`] = cleaned;
                            if (val.sizeId !== undefined) updates[`${childKey}/sizeId`] = cleaned;
                            result.totalUpdated++;
                        }
                    }
                }
            ];

            appendSizeIdLog('Starting size ID cleanup...');
            for (const task of tasks) {
                try {
                    const snap = await database.ref(task.path).once('value');
                    if (!snap.exists()) {
                        appendSizeIdLog(`${task.path}: no data`);
                        continue;
                    }
                    const updates = {};
                    snap.forEach(child => {
                        const val = child.val() || {};
                        task.handler(val, child.key, updates);
                    });
                    const count = Object.keys(updates).length;
                    if (count > 0) {
                        await database.ref(task.path).update(updates);
                    }
                    result.perPath[task.path] = count;
                    appendSizeIdLog(`${task.path}: updated ${count} fields`);
                } catch (err) {
                    appendSizeIdLog(`${task.path}: error ${err.message}`);
                    console.error('[SizeIDMigration]', task.path, err);
                }
            }
            appendSizeIdLog(`Size ID cleanup finished. Total fields cleaned: ${result.totalUpdated}`);
            return result;
        }

        App.utils.markInvalid = function (element, message) {
            if (!element) return;
            element.classList.add('input-error');
            if (message) {
                element.setAttribute('title', message);
                element.dataset.error = message;
            }
            element.setAttribute('aria-invalid', 'true');
        };

        App.utils.clearValidation = function (container) {
            if (!container) return;
            container.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
                el.removeAttribute('aria-invalid');
                el.removeAttribute('data-error');
                el.removeAttribute('title');
            });
        };

        function applyPerformanceMode(enabled) {
            const body = document.body;
            if (!body) return;
            if (enabled) {
                body.classList.add('performance-mode');
            } else {
                body.classList.remove('performance-mode');
            }
            const btn = document.getElementById('perfToggle');
            if (btn) {
                btn.textContent = enabled ? ' Performance: ON' : ' Performance';
            }
            try { localStorage.setItem('factory_perf_mode', enabled ? '1' : '0'); } catch (e) { }
        }

        function togglePerformanceMode() {
            const enabled = !document.body.classList.contains('performance-mode');
            applyPerformanceMode(enabled);
            App.ui.showToast(enabled ? 'Performance mode enabled' : 'Performance mode disabled', 'info');
        }

        App.ui.requireOnline = function () {
            if (!isConnected) {
                App.ui.showToast('Offline: Action queued for sync.', 'info');
                return false;
            }
            return true;
        };

        App.hasPermission = function (capability) {
            const roleId = App.state.role || 'Admin';

            // 1. Check dynamic role permissions
            if (App.auth && App.auth.rolesById && App.auth.rolesById[roleId]) {
                const roleDef = App.auth.rolesById[roleId];
                if (roleDef.permissions && roleDef.permissions[capability]) {
                    return true;
                }
            }

            // 2. Fallback to hardcoded defaults (legacy)
            return !!(App.permissions[roleId] && App.permissions[roleId][capability]);
        };

        function updateCaches(list, targetKey) {
            if (!Array.isArray(list)) return;

            if (targetKey === 'sizes') {
                updateSizeCaches(list);
                return;
            }

            App.state[targetKey] = list;
            const map = {};
            list.forEach(item => {
                if (!item || !item.id) return;
                map[item.id] = item;
            });
            if (targetKey === 'customers') {
                App.cache.customersById = map;
            } else if (targetKey === 'suppliers') {
                App.cache.suppliersById = map;
            }
        }

        function enqueueWrite(action) {
            App.state.pendingWrites.push(action);
            persistPendingQueue();
            App.ui.updatePendingBadge();
        }

        async function flushPendingWrites() {
            if (!isConnected || !App.state.pendingWrites.length) return;
            const remaining = [];
            for (const job of App.state.pendingWrites) {
                try {
                    if (job.type === 'put') {
                        await fbPut(job.path, job.key, job.payload);
                    } else if (job.type === 'push') {
                        await fbInsert(job.path, job.payload);
                    } else if (job.type === 'delete') {
                        await fbDelete(job.path, job.key);
                    } else if (job.type === 'update') {
                        await fbUpdate(job.path, job.payload);
                    }
                } catch (err) {
                    console.warn('Retry failed for job', job, err);
                    remaining.push(job);
                }
            }
            App.state.pendingWrites = remaining;
            persistPendingQueue();
            App.ui.updatePendingBadge();
        }
        // Real-time listeners for data updates

        // DEBOUNCE TIMERS TO PREVENT DUPLICATE REFRESHES
        let salesRefreshTimer = null;
        let purchaseRefreshTimer = null;
        let customersRefreshTimer = null;
        let suppliersRefreshTimer = null;
        let sizesRefreshTimer = null;
        let inventoryRefreshTimer = null;
        let logsRefreshTimer = null;

        function debouncedRefreshSalesInvoiceList() {
            clearTimeout(salesRefreshTimer);
            salesRefreshTimer = setTimeout(() => {
                refreshSalesInvoiceList();
            }, 300);
        }

        function debouncedRefreshPurchaseInvoiceList() {
            clearTimeout(purchaseRefreshTimer);
            purchaseRefreshTimer = setTimeout(() => {
                refreshPurchaseInvoiceList();
            }, 300);
        }

        function debouncedRefreshCustomersTable() {
            clearTimeout(customersRefreshTimer);
            customersRefreshTimer = setTimeout(() => {
                refreshCustomersTable();
            }, 300);
        }

        function debouncedRefreshSuppliersTable() {
            clearTimeout(suppliersRefreshTimer);
            suppliersRefreshTimer = setTimeout(() => {
                refreshSuppliersTable();
            }, 300);
        }

        function debouncedRefreshSizesTable() {
            clearTimeout(sizesRefreshTimer);
            sizesRefreshTimer = setTimeout(() => {
                refreshSizesTable();
            }, 300);
        }

        function refreshInventoryTable() {
            // Delegate to the main inventory renderer
            if (typeof renderInventoryTab === 'function') {
                renderInventoryTab();
            }
        }

        function debouncedRefreshInventoryTable() {
            clearTimeout(inventoryRefreshTimer);
            inventoryRefreshTimer = setTimeout(() => {
                refreshInventoryTable();
            }, 300);
        }

        function debouncedRefreshLogsTable() {
            clearTimeout(logsRefreshTimer);
            logsRefreshTimer = setTimeout(() => {
                activityLogsCache = [];
                if (document.getElementById('report-activity-logs')?.classList.contains('active')) {
                    generateActivityLogs(true);
                }
            }, 400);
        }

        function setupRealtimeListeners() {
            // Customers - debounced
            database.ref('customers').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'customers');
                debouncedRefreshCustomersTable();
            });

            // Suppliers - debounced
            database.ref('suppliers').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'suppliers');
                debouncedRefreshSuppliersTable();
            });

            // Sizes - debounced
            database.ref('sizes').on('value', (snapshot) => {
                const list = [];
                snapshot.forEach(child => {
                    const val = child.val() || {};
                    val.id = val.id || child.key;
                    list.push(val);
                });
                updateCaches(list, 'sizes');
                debouncedRefreshSizesTable();
            });

            // Sales Invoices - debounced
            database.ref('salesInvoices').on('value', (snapshot) => {
                const list = [];
                const seen = new Set();
                snapshot.forEach(child => {
                    const norm = normalizeInvoice(child.val(), 'sales', child.key);
                    if (!norm) return;
                    const key = norm.invoice_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    list.push(norm);
                });
                setInvoicesInState('sales', list);
                debouncedRefreshSalesInvoiceList();
            });

            // Purchase Invoices - debounced
            database.ref('purchaseInvoices').on('value', (snapshot) => {
                const list = [];
                const seen = new Set();
                snapshot.forEach(child => {
                    const norm = normalizeInvoice(child.val(), 'purchase', child.key);
                    if (!norm) return;
                    const key = norm.purchase_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    list.push(norm);
                });
                setInvoicesInState('purchase', list);
                debouncedRefreshPurchaseInvoiceList();
            });

            // Stock Levels - debounced
            database.ref('stockLevels').on('value', (snapshot) => {
                debouncedRefreshInventoryTable();
            });

            // Activity Logs - debounced refresh (only fetch when needed)
            if (database.ref('activityLogs')) {
                database.ref('activityLogs').limitToLast(300).on('value', () => {
                    debouncedRefreshLogsTable();
                });
            }
        }

        // ========== Database Facade ==========
        const INVOICE_PATH = { sales: 'salesInvoices', purchase: 'purchaseInvoices' };

        // ==========================================
        // BACKUP & RESTORE HELPERS
        // ==========================================

        async function fbSet(path, data) {
            await database.ref(path).set(data);
            markOnline();
        }

        async function fbUpdate(path, updates) {
            await database.ref(path).update(updates);
            markOnline();
        }

        /**
         * Build a complete backup snapshot of all important data.
         * This returns a plain JS object that will be JSON-stringified.
         */
        async function buildBackupObject() {
            const timestamp = new Date().toISOString();

            // 1) Fetch masters and other core tables.
            const [
                customers,
                suppliers,
                sizes,
                machines,
                appState,
                inventory,
                stockLevels,
                quotes,
                finishedGoods,
                salesRaw,
                purchaseRaw,
                productionEntries,
                packingEntries,
                activityLogs,
                ledgerEntries
            ] = await Promise.all([
                fbGetAll('customers').catch(() => []),
                fbGetAll('suppliers').catch(() => []),
                fbGetAll('sizes').catch(() => []),
                fbGetAll('machines').catch(() => []),
                fbGet('appState', 'appState').catch(() => null),
                database.ref('inventory').once('value').then(s => s.val() || {}),
                fbGetAll('stockLevels').catch(() => []),
                fbGetAll('quotes').catch(() => []),
                database.ref('finishedGoods').once('value').then(s => s.val() || {}),
                fbGetAll('salesInvoices').catch(() => []),
                fbGetAll('purchaseInvoices').catch(() => []),
                fbGetAll('productionEntries').catch(() => []),
                fbGetAll('packingEntries').catch(() => []),
                fbGetAll('activityLogs').catch(() => []),
                fbGetAll('ledgerEntries').catch(() => [])
            ]);

            // 2) Normalize invoices so IDs + structure are canonical.
            const salesInvoices = salesRaw
                .map(raw => normalizeInvoice(raw, 'sales', raw.id))
                .filter(Boolean);

            const purchaseInvoices = purchaseRaw
                .map(raw => normalizeInvoice(raw, 'purchase', raw.id))
                .filter(Boolean);

            // 3) Ensure every master / entry has a stable id (fallback to its id from fbGetAll).
            function ensureIdArray(list) {
                return (Array.isArray(list) ? list : []).map(item => {
                    const id = (item && item.id) ? String(item.id) : '';
                    return { ...item, id: id || String(Date.now()) + '-' + Math.random().toString(36).slice(2, 7) };
                });
            }

            const backup = {
                meta: {
                    backupVersion: 1,
                    createdAt: timestamp,
                    note: 'Factory app backup with canonical IDs preserved'
                },
                masters: {
                    customers: ensureIdArray(customers),
                    suppliers: ensureIdArray(suppliers),
                    sizes: ensureIdArray(sizes),
                    machines: ensureIdArray(machines)
                },
                core: {
                    appState: appState || {},
                    inventory: inventory || {},
                    stockLevels: ensureIdArray(stockLevels)
                },
                documents: {
                    quotes: ensureIdArray(quotes),
                    finishedGoods: finishedGoods || null
                },
                invoices: {
                    sales: salesInvoices,
                    purchase: purchaseInvoices
                },
                operations: {
                    productionEntries: ensureIdArray(productionEntries),
                    packingEntries: ensureIdArray(packingEntries),
                    activityLogs: ensureIdArray(activityLogs),
                    ledgerEntries: ensureIdArray(ledgerEntries)
                }
            };

            return backup;
        }

        async function downloadBackup() {
            const statusEl = document.getElementById('backupStatus');
            if (statusEl) {
                statusEl.textContent = 'Preparing backup...';
            }

            try {
                if (!App.ui.requireOnline || !App.ui.requireOnline()) {
                    if (statusEl) statusEl.textContent = 'Cannot create backup while offline.';
                    return;
                }

                const backup = await buildBackupObject();

                if (!backup.masters || !backup.invoices) {
                    throw new Error('Backup structure incomplete');
                }

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });

                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const mi = String(now.getMinutes()).padStart(2, '0');

                const filename = `factory_backup_${yyyy}${mm}${dd}_${hh}${mi}.json`;

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                if (statusEl) {
                    statusEl.textContent = `Backup downloaded: ${filename}`;
                }
                recordActionLog('Backup Created', `Created backup file ${filename}`, {
                    filename,
                    timestamp: now.toISOString()
                });
            } catch (err) {
                App.ui.reportIssue('Error creating backup', err, 'error');
                if (statusEl) {
                    statusEl.textContent = `Backup failed: ${err.message || err}`;
                }
            }
        }

        /**
         * Restore from a backup object that follows the format from buildBackupObject().
         * This performs a "full replace" of key collections.
         */
        async function restoreFromBackupObject(backup) {
            if (!backup || typeof backup !== 'object') {
                throw new Error('Invalid backup format');
            }

            const version = backup.meta && backup.meta.backupVersion;
            if (!version) {
                console.warn('Backup has no meta.backupVersion, continuing as v1.');
            }

            const masters = backup.masters || {};
            const core = backup.core || {};
            const documents = backup.documents || {};
            const invoices = backup.invoices || {};
            const ops = backup.operations || {};

            const rootRef = database.ref();

            await Promise.all([
                rootRef.child('customers').set(null),
                rootRef.child('suppliers').set(null),
                rootRef.child('sizes').set(null),
                rootRef.child('machines').set(null),
                rootRef.child('appState').set(null),
                rootRef.child('inventory').set(null),
                rootRef.child('stockLevels').set(null),
                rootRef.child('quotes').set(null),
                rootRef.child('finishedGoods').set(null),
                rootRef.child('salesInvoices').set(null),
                rootRef.child('purchaseInvoices').set(null),
                rootRef.child('productionEntries').set(null),
                rootRef.child('packingEntries').set(null),
                rootRef.child('activityLogs').set(null),
                rootRef.child('ledgerEntries').set(null)
            ]);

            async function restoreArray(path, list) {
                if (!Array.isArray(list)) return;
                for (const item of list) {
                    if (!item) continue;
                    const id = (item.id != null) ? String(item.id) : '';
                    if (!id) continue;
                    const payload = { ...item, id };
                    await safePut(path, id, payload);
                }
            }

            await restoreArray('customers', masters.customers);
            await restoreArray('suppliers', masters.suppliers);
            await restoreArray('sizes', masters.sizes);
            await restoreArray('machines', masters.machines);

            if (core.appState) {
                await fbPut('appState', 'appState', core.appState);
            }
            if (core.inventory) {
                await fbSet('inventory', core.inventory);
            }
            await restoreArray('stockLevels', core.stockLevels);

            await restoreArray('quotes', documents.quotes);
            if (documents.finishedGoods !== undefined) {
                await fbSet('finishedGoods', documents.finishedGoods || {});
            }

            async function restoreInvoices(path, list, type) {
                if (!Array.isArray(list)) return;
                for (const inv of list) {
                    if (!inv) continue;
                    const id = (inv.id != null) ? String(inv.id) : '';
                    if (!id) continue;

                    const normalized = normalizeInvoice(inv, type, id);
                    if (!normalized) continue;

                    const payload = { ...inv };
                    payload.id = normalized.id;

                    if (type === 'sales') {
                        payload.invoice_id = normalized.id;
                        payload.type = 'sales';
                    } else {
                        payload.purchase_id = normalized.id;
                        payload.type = 'purchase';
                    }

                    await safePut(path, normalized.id, payload);
                }
            }

            await restoreInvoices('salesInvoices', invoices.sales, 'sales');
            await restoreInvoices('purchaseInvoices', invoices.purchase, 'purchase');

            await restoreArray('productionEntries', ops.productionEntries);
            await restoreArray('packingEntries', ops.packingEntries);
            await restoreArray('activityLogs', ops.activityLogs);
            await restoreArray('ledgerEntries', ops.ledgerEntries);

            if (typeof loadPersistedAppState === 'function') {
                await loadPersistedAppState(null);
            }
            if (typeof fetchCoreDataSnapshot === 'function') {
                await fetchCoreDataSnapshot();
            }
        }

        async function restoreBackup(event) {
            const fileInput = event && event.target;
            const statusEl = document.getElementById('backupStatus');

            if (!fileInput || !fileInput.files || !fileInput.files.length) {
                if (statusEl) statusEl.textContent = 'No backup file selected.';
                return;
            }

            const file = fileInput.files[0];

            if (statusEl) {
                statusEl.textContent = `Reading backup file: ${file.name} ...`;
            }

            const proceed = window.confirm(
                'Restoring from backup will overwrite existing data for masters, invoices, inventory, and logs.\n\n' +
                'Make sure you have a fresh backup before continuing.\n\nContinue with restore?'
            );
            if (!proceed) {
                if (statusEl) statusEl.textContent = 'Restore cancelled by user.';
                fileInput.value = '';
                return;
            }

            try {
                if (!App.ui.requireOnline || !App.ui.requireOnline()) {
                    if (statusEl) statusEl.textContent = 'Cannot restore while offline.';
                    fileInput.value = '';
                    return;
                }

                const text = await file.text();
                let backup;
                try {
                    backup = JSON.parse(text);
                } catch (parseErr) {
                    throw new Error('Selected file is not valid JSON');
                }

                if (!backup.meta || !backup.meta.backupVersion) {
                    console.warn('Backup JSON has no meta.backupVersion, assuming v1.');
                }

                if (statusEl) {
                    statusEl.textContent = 'Restoring data from backup...';
                }

                await restoreFromBackupObject(backup);

                if (statusEl) {
                    statusEl.textContent = 'Restore completed successfully. Please re-check invoices, masters, and inventory.';
                }
                recordActionLog('Backup Restored', `Restored data from backup file ${file.name}`, {
                    filename: file.name,
                    backupVersion: backup.meta ? backup.meta.backupVersion : 'unknown',
                    timestamp: new Date().toISOString()
                });

                fileInput.value = '';
            } catch (err) {
                App.ui.reportIssue('Restore failed', err, 'error');
                if (statusEl) {
                    statusEl.textContent = `Restore failed: ${err.message || err}`;
                }
                fileInput.value = '';
            }
        }

        function normalizeInvoice(raw, type, keyFromDb) {
            if (!raw) return null;

            const isPurchase = type === 'purchase';
            const base = ModelFactory.createEmptyInvoice(type || '');

            // --- ID + type ---
            const id = isPurchase
                ? (raw.purchase_id || raw.purchaseId || raw.id || raw.invoice_id || keyFromDb)
                : (raw.invoice_id || raw.invoiceId || raw.id || keyFromDb);

            base.id = String(id || '').trim();
            base.type = type || (isPurchase ? 'purchase' : 'sales');

            // --- Invoice number & date ---
            base.number = String(
                raw.invoice_no ||
                raw.invoiceNumber ||
                raw.number ||
                raw.bill_no ||
                base.id
                || '').trim();

            base.date = String(
                raw.date ||
                raw.invoice_date ||
                raw.bill_date ||
                ''
                || '').trim();

            // --- Party Link ---
            // "partyId" is the canonical link.
            // "partyNameSnapshot" and "partyGstSnapshot" are historical records.
            const partyId =
                raw.partyId ||
                raw.customer_id ||
                raw.customerId ||
                raw.supplier_id ||
                raw.supplierId ||
                '';

            base.partyId = String(partyId || '').trim();

            const pName =
                raw.partyNameSnapshot ||
                raw.customer_name ||
                raw.customerName ||
                raw.supplier_name ||
                raw.supplierName ||
                '';
            base.partyNameSnapshot = String(pName || '').trim();

            const pGst =
                raw.partyGstSnapshot ||
                raw.customer_gst ||
                raw.supplier_gst ||
                '';
            base.partyGstSnapshot = String(pGst || '').trim();

            // --- Items / lines ---
            const rawLines = Array.isArray(raw.lines)
                ? raw.lines
                : (Array.isArray(raw.line_items) ? raw.line_items : []);

            base.items = rawLines.map((ln, idx) => {
                const line = ModelFactory.createEmptyInvoiceLine();
                line.id = ln.id || `L${idx}`;
                line.sizeId = String(
                    ln.sizeId ||
                    ln.size_id ||
                    ln.size ||
                    ''
                    || '').trim();
                line.description = String(
                    ln.description ||
                    ln.item_name ||
                    ln.name ||
                    ''
                    || '').trim();
                line.hsn = String(ln.hsn || ln.hsn_code || '').trim();

                const qty = Number(ln.quantity ?? ln.qty ?? 0);
                const rate = Number(ln.rate ?? ln.price ?? 0);
                const amount = isNaN(qty * rate) ? 0 : qty * rate;

                line.quantity = isNaN(qty) ? 0 : qty;
                line.rate = isNaN(rate) ? 0 : rate;
                line.amount = amount;

                const tPercent = Number(ln.taxPercent ?? ln.tax_percent ?? ln.gst_rate ?? 0);
                line.taxPercent = isNaN(tPercent) ? 0 : tPercent;

                const tAmount = Number(ln.taxAmount ?? ln.tax_amount ?? 0);
                line.taxAmount = isNaN(tAmount) ? 0 : tAmount;

                const gross = Number(ln.totalWithTax ?? ln.gross_total ?? (amount + tAmount));
                line.totalWithTax = isNaN(gross) ? amount + (line.taxAmount || 0) : gross;

                line.unit = String(ln.unit || ln.uom || '').trim();
                line.remarks = String(ln.remarks || ln.note || '').trim();

                // Merge back so old code still sees original fields
                return { ...ln, ...line };
            });

            // --- Totals (canonical) ---
            const subtotal = raw.invoice_subtotal ?? raw.subtotal ?? 0;
            const lineTaxTotal = raw.invoice_line_tax_total ?? raw.line_tax_total ?? 0;
            const additionalTax = raw.invoice_tax ?? raw.additional_tax ?? 0;
            const grandTotal = raw.invoice_grand_total ?? raw.total ?? 0;

            base.subtotal = Number(subtotal) || 0;
            base.taxTotal = Number(lineTaxTotal) || 0;
            base.additionalTax = Number(additionalTax) || 0;
            base.grandTotal = Number(grandTotal) || 0;
            base.roundOff = Number(raw.round_off ?? raw.roundOff ?? 0) || 0;

            base.paymentMode = String(raw.paymentMode || raw.payment_mode || '').trim();
            base.narration = String(raw.narration || raw.remarks || raw.note || '').trim();
            base.createdAt = raw.createdAt || raw.created_at || 0;
            base.updatedAt = raw.updatedAt || raw.updated_at || 0;
            base.createdBy = String(raw.createdBy || raw.user || '').trim();
            base.updatedBy = String(raw.updatedBy || '').trim();
            base.isCancelled = !!(raw.isCancelled || raw.cancelled);

            // --- Compatibility fields for existing code ---
            const normalized = { ...raw, ...base };

            if (isPurchase) {
                normalized.purchase_id = base.id;
                normalized.purchaseId = base.id;
                normalized.supplierId = base.partyId;
                normalized.supplier_id = base.partyId;
                normalized.supplier_name = base.partyNameSnapshot || raw.supplier_name || '';
            } else {
                normalized.invoice_id = base.id;
                normalized.invoiceId = base.id;
                normalized.customerId = base.partyId;
                normalized.customer_id = base.partyId;
                normalized.customer_name = base.partyNameSnapshot || raw.customer_name || '';
            }

            normalized.lines = base.items;
            normalized.invoice_subtotal = base.subtotal;
            normalized.invoice_line_tax_total = base.taxTotal;
            normalized.invoice_tax = base.additionalTax;
            normalized.invoice_grand_total = base.grandTotal;

            if (!normalized._key) normalized._key = keyFromDb || base.id;

            return normalized;
        }

        async function safePut(path, key, payload) {
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'put', path, key, payload });
                return key;
            }
            return fbPut(path, key, payload);
        }

        async function safePush(path, payload) {
            const tempKey = payload.id || payload.invoice_id || payload.purchase_id || `${path}-${Date.now()}`;
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'push', path, payload: { ...payload, id: tempKey } });
                return tempKey;
            }
            return fbInsert(path, payload);
        }

        async function safeDelete(path, key) {
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'delete', path, key });
                return;
            }
            return fbDelete(path, key);
        }

        async function safeUpdate(path, updates) {
            if (!App.ui.requireOnline()) {
                enqueueWrite({ type: 'update', path, payload: updates });
                return;
            }
            return fbUpdate(path, updates);
        }

        App.db.saveInvoice = async function (type, invoice) {
            const path = INVOICE_PATH[type] || type;
            const key = type === 'sales'
                ? (invoice.invoice_id || invoice.invoiceId || invoice.id)
                : (invoice.purchase_id || invoice.invoice_id || invoice.invoiceId || invoice.id);
            if (!key) throw new Error('Invoice key missing');
            const payload = { ...invoice };
            payload.type = type;
            if (type === 'sales') payload.invoice_id = key;
            if (type === 'purchase') payload.purchase_id = key;
            await safePut(path, key, payload);
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            const existing = Array.isArray(App.state.invoices[cacheKey]) ? [...App.state.invoices[cacheKey]] : [];
            const idx = existing.findIndex(inv => (inv.invoice_id || inv.purchase_id || inv.id) === key);
            const normalized = normalizeInvoice(payload, type, key);
            if (idx >= 0) existing[idx] = normalized; else existing.push(normalized);
            App.state.invoices[cacheKey] = existing;
            return key;
        };

        App.db.listInvoices = async function (type) {
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            const cached = App.state.invoices[cacheKey];
            if (Array.isArray(cached) && cached.length) return cached;
            const path = INVOICE_PATH[type] || type;
            try {
                const list = await fbGetAll(path);
                const normalizedList = [];
                const seen = new Set();
                list.forEach(item => {
                    const norm = normalizeInvoice(item, type, item.id);
                    if (!norm) return;
                    const key = type === 'sales' ? norm.invoice_id : norm.purchase_id;
                    if (seen.has(key)) return;
                    seen.add(key);
                    normalizedList.push(norm);
                });
                setInvoicesInState(cacheKey, normalizedList);
                return normalizedList;
            } catch (err) {
                App.ui.reportIssue(`Unable to load ${type} invoices from server, using cached data if available`, err, 'warning');
                return Array.isArray(cached) ? cached : [];
            }
        };

        App.db.getInvoice = async function (type, id) {
            const list = await App.db.listInvoices(type);
            const found = list.find(inv => inv.invoice_id === id || inv.purchase_id === id || inv.id === id);
            if (found) return found;
            const path = INVOICE_PATH[type] || type;
            const raw = await fbGet(path, id);
            return normalizeInvoice(raw, type, id);
        };

        App.db.deleteInvoice = async function (type, id) {
            const path = INVOICE_PATH[type] || type;
            await safeDelete(path, id);
            const cacheKey = type === 'sales' ? 'sales' : 'purchase';
            if (Array.isArray(App.state.invoices[cacheKey])) {
                App.state.invoices[cacheKey] = App.state.invoices[cacheKey].filter(inv => (inv.invoice_id || inv.purchase_id || inv.id) !== id);
            }
        };

        App.db.dedupePurchaseInvoices = async function () {
            if (!isConnected) return;
            try {
                if (localStorage.getItem('factory_purchase_dedupe_done') === '1') return;
            } catch (e) { }
            try {
                const rawList = await fbGetAll(INVOICE_PATH.purchase);
                const groups = {};
                rawList.forEach(item => {
                    const norm = normalizeInvoice(item, 'purchase', item.id);
                    if (!norm || !norm.purchase_id) return;
                    const key = norm.purchase_id;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push({ norm, raw: item });
                });
                const deletions = [];
                Object.values(groups).forEach(items => {
                    if (items.length <= 1) return;
                    const signature = (inv) => JSON.stringify({
                        date: inv.date,
                        supplier_id: inv.supplier_id,
                        subtotal: inv.invoice_subtotal,
                        lineTax: inv.invoice_line_tax_total,
                        invoiceTax: inv.invoice_tax,
                        grand: inv.invoice_grand_total,
                        lines: (inv.lines || []).map(l => ({
                            category: l.category,
                            size: l.size_id || l.size,
                            qty: l.qty,
                            rate: l.rate_per_unit || l.rate,
                            tax: l.tax_per_unit || l.tax,
                            stage: l.stage,
                            total: l.line_grand_total || l.line_total_before_tax
                        }))
                    });
                    const bySig = {};
                    items.forEach(entry => {
                        const sig = signature(entry.norm);
                        if (!bySig[sig]) bySig[sig] = [];
                        bySig[sig].push(entry);
                    });
                    Object.values(bySig).forEach(list => {
                        if (list.length <= 1) return;
                        // keep first, delete rest
                        list.slice(1).forEach(extra => {
                            const deleteKey = extra.raw.id || extra.norm._key || extra.norm.purchase_id;
                            deletions.push({ key: deleteKey, purchase_id: extra.norm.purchase_id });
                        });
                    });
                });
                for (const del of deletions) {
                    await safeDelete(INVOICE_PATH.purchase, del.key);
                    App.db.log({
                        action: 'purchase.invoice.dedupe.delete',
                        entityType: 'purchaseInvoice',
                        entityId: del.purchase_id,
                        description: `Removed duplicate purchase invoice ${del.purchase_id} (key ${del.key})`
                    });
                }
                if (deletions.length) {
                    App.ui.showToast(`Cleaned ${deletions.length} duplicate purchase invoices`, 'success');
                }
                try { localStorage.setItem('factory_purchase_dedupe_done', '1'); } catch (e) { }
            } catch (err) {
                console.warn('Deduplication failed', err);
            }
        };

        App.db.saveMaster = async function (kind, payload) {
            if (!payload.id) throw new Error('Missing master id');
            await safePut(kind, payload.id, payload);

            let existing = [];
            if (kind === 'sizes') {
                existing = (App.state.sizes && App.state.sizes.list) ? App.state.sizes.list : [];
            } else {
                existing = Array.isArray(App.state[kind]) ? App.state[kind] : [];
            }

            const updated = existing.filter(item => item.id !== payload.id).concat(payload);
            updateCaches(updated, kind);
            return payload.id;
        };

        App.db.deleteMaster = async function (kind, id) {
            await safeDelete(kind, id);
        };

        App.db.log = async function (details) {
            // 1) Read current user safely
            const currentUser = (window.App && App.auth && App.auth.currentUser) ||
                (window.App && App.state && App.state.currentUser) ||
                null;

            // 2) Derive userName
            let userName = details.user || details.userName;
            if (!userName && currentUser) {
                userName = currentUser.name || currentUser.displayName || currentUser.username;
            }
            if (!userName) userName = 'User';

            // 3) Derive userId
            let userId = details.userId;
            if (!userId && currentUser) {
                userId = currentUser.id;
            }
            if (!userId) userId = userName || 'local';

            // 4) Derive role
            let role = details.role;
            if (!role && currentUser) {
                role = currentUser.role || currentUser.roleId;
            }
            if (!role && window.App && App.state) {
                role = App.state.role;
            }
            if (!role) role = 'Admin';

            const entry = {
                id: details.id || `LOG-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                timestamp: details.timestamp || new Date().toISOString(),
                action: details.action || 'event',
                entityType: details.entityType || '',
                entityId: details.entityId || '',
                userId: userId,
                user: userName,
                role: role,
                description: details.description || '',
                details: details.details || details.extra || {},
                extra: details.extra || details.details || {}
            };

            await safePut('activityLogs', entry.id, entry);

            if (typeof appState !== 'undefined') {
                if (!Array.isArray(appState.activityLogs)) appState.activityLogs = [];
                appState.activityLogs.unshift(entry);
                appState.activityLogs = appState.activityLogs.slice(0, 500);
            }
            if (typeof activityLogsCache !== 'undefined') {
                if (!Array.isArray(activityLogsCache)) activityLogsCache = [];
                activityLogsCache.unshift(entry);
                activityLogsCache = activityLogsCache.slice(0, 500);
            }

            if (document.getElementById('report-activity-logs')?.classList.contains('active')) {
                setTimeout(() => {
                    if (typeof generateActivityLogs === 'function') generateActivityLogs(true);
                }, 50);
            }
            return entry;
        };

        // ========== Invoice Engine (Shared) ==========
        App.invoiceEngine.normalizeLines = function (type, lines) {
            if (!Array.isArray(lines)) return [];
            return lines.map((line, idx) => {
                const qty = parseFloat(line.qty) || 0;
                const rate = parseFloat(line.rate_per_unit || line.rate) || 0;
                const disc = parseFloat(line.discount_pct || 0);
                const taxPerUnit = parseFloat(line.tax_per_unit || line.tax) || 0;
                const base = qty * rate;
                const discountAmt = base * (disc / 100);
                const beforeTax = (typeof line.line_total_before_tax === 'number') ? line.line_total_before_tax : (base - discountAmt);
                const lineTax = (typeof line.line_tax_total === 'number') ? line.line_tax_total : (qty * taxPerUnit);
                const grand = (typeof line.line_grand_total === 'number') ? line.line_grand_total : (beforeTax + lineTax);
                return {
                    ...line,
                    line_id: line.line_id || idx + 1,
                    qty,
                    rate_per_unit: rate,
                    discount_pct: disc,
                    tax_per_unit: taxPerUnit,
                    line_total_before_tax: beforeTax,
                    line_tax_total: lineTax,
                    line_grand_total: grand
                };
            });
        };

        App.invoiceEngine.calculateTotals = function (type, lines, invoiceTaxValue) {
            const normalized = App.invoiceEngine.normalizeLines(type, lines);
            const subtotal = normalized.reduce((sum, l) => sum + (l.line_total_before_tax || 0), 0);
            const lineTax = normalized.reduce((sum, l) => sum + (l.line_tax_total || 0), 0);
            let invoiceTax = typeof invoiceTaxValue === 'number' && !isNaN(invoiceTaxValue) ? invoiceTaxValue : 0;
            if (type === 'sales') {
                invoiceTax = (subtotal - lineTax) * 0.18;
            }
            const grand = subtotal + lineTax + invoiceTax;
            return { subtotal, lineTax, invoiceTax, grand, lines: normalized };
        };

        App.invoiceEngine.nextInvoiceId = async function (type) {
            const todayPart = getToday().replace(/-/g, '');
            const prefix = type === 'sales' ? 'S' : 'P';
            const invoices = await App.db.listInvoices(type);
            const count = invoices.filter(inv => {
                const key = inv.id || '';
                return key.includes(todayPart);
            }).length;
            return `${prefix}-${todayPart}-${String(count + 1).padStart(3, '0')}`;
        };

        App.invoiceEngine.validateInvoice = function (type, invoice) {
            const errors = [];
            if (!invoice.date) errors.push({ field: 'date', message: 'Date is required' });
            if (!invoice.partyId) errors.push({ field: 'party', message: `Select a ${type === 'sales' ? 'customer' : 'supplier'}` });
            if (!Array.isArray(invoice.lines) || !invoice.lines.length) {
                errors.push({ field: 'lines', message: 'Add at least one line item' });
            } else {
                invoice.lines.forEach((line, idx) => {
                    if (!line.qty || line.qty <= 0) errors.push({ field: `line-${idx}-qty`, message: 'Quantity must be greater than zero' });
                    if (line.rate_per_unit < 0) errors.push({ field: `line-${idx}-rate`, message: 'Rate cannot be negative' });
                    if (type === 'sales' && !line.size_id) errors.push({ field: `line-${idx}-size`, message: 'Select a size for each line' });
                    if (type === 'purchase' && (line.category || '').toLowerCase() === 'ready screws') {
                        if (!line.size_id) errors.push({ field: `line-${idx}-size`, message: 'Select a size for Ready Screws' });
                        if (!line.stage) errors.push({ field: `line-${idx}-stage`, message: 'Select stage for Ready Screws' });
                        if (!line.bags_received || line.bags_received <= 0) errors.push({ field: `line-${idx}-bags`, message: 'Enter bags received' });
                    }
                });
            }
            if ((invoice.totals?.grand || 0) < 0) {
                errors.push({ field: 'totals', message: 'Total cannot be negative' });
            }
            return { valid: errors.length === 0, errors };
        };

        const lineDomConfig = {
            sales: {
                container: 'saleLineItems',
                fields: {
                    size: '.sl-size',
                    unit: '.sl-unit',
                    qty: '.sl-qty',
                    rate: '.sl-rate',
                    discount: '.sl-disc',
                    tax: '.sl-tax',
                    total: '.sl-total'
                }
            },
            purchase: {
                container: 'purchaseLineItems',
                fields: {
                    category: '.it-category',
                    description: '.it-name',
                    size: '.it-size',
                    stage: '.it-stage',
                    bags: '.it-bags',
                    unit: '.it-unit',
                    qty: '.it-qty',
                    rate: '.it-rate',
                    tax: '.it-tax',
                    total: '.it-total'
                }
            }
        };

        App.invoiceEngine.readLinesFromDOM = function (type) {
            const cfg = lineDomConfig[type];
            if (!cfg) return [];
            const rows = document.querySelectorAll(`#${cfg.container} tr`);
            const lines = [];
            rows.forEach((row, idx) => {
                if (type === 'sales') {
                    const qty = parseFloat(row.querySelector(cfg.fields.qty)?.value) || 0;
                    const rate = parseFloat(row.querySelector(cfg.fields.rate)?.value) || 0;
                    const disc = parseFloat(row.querySelector(cfg.fields.discount)?.value) || 0;
                    const taxPerUnit = parseFloat(row.querySelector(cfg.fields.tax)?.value) || 0;
                    const sizeInput = row.querySelector(cfg.fields.size);
                    const sizeIdRaw = sizeInput?.dataset.sizeId || sizeInput?.value || null;
                    const sizeId = resolveSizeIdFromAny({ sizeId: sizeIdRaw });

                    lines.push({
                        line_id: idx + 1,
                        size_id: sizeId || null,
                        unit_type: row.querySelector(cfg.fields.unit)?.value || 'KG',
                        qty,
                        rate_per_unit: rate,
                        discount_pct: disc,
                        tax_per_unit: taxPerUnit
                    });
                } else if (type === 'purchase') {
                    const qty = parseFloat(row.querySelector(cfg.fields.qty)?.value) || 0;
                    const rate = parseFloat(row.querySelector(cfg.fields.rate)?.value) || 0;
                    const taxPerUnit = parseFloat(row.querySelector(cfg.fields.tax)?.value) || 0;
                    const sizeInput = row.querySelector(cfg.fields.size);
                    const sizeIdRaw = sizeInput?.dataset.sizeId || sizeInput?.value || null;
                    const sizeId = resolveSizeIdFromAny({ sizeId: sizeIdRaw });

                    lines.push({
                        line_id: idx + 1,
                        category: row.querySelector(cfg.fields.category)?.value || '',
                        description: row.querySelector(cfg.fields.description)?.value || '',
                        size_id: sizeId || null,
                        stage: row.querySelector(cfg.fields.stage)?.value || '',
                        bags_received: parseInt(row.querySelector(cfg.fields.bags)?.value || 0, 10) || 0,
                        unit_type: row.querySelector(cfg.fields.unit)?.value || 'KG',
                        qty,
                        rate_per_unit: rate,
                        tax_per_unit: taxPerUnit
                    });
                }
            });
            return lines;
        };

        App.invoiceEngine.refreshTotals = function (type) {
            const lines = App.invoiceEngine.readLinesFromDOM(type);
            const totals = App.invoiceEngine.calculateTotals(
                type,
                lines,
                type === 'purchase' ? (parseFloat(document.getElementById('purchaseInvoiceTax')?.value) || 0) : undefined
            );

            // Update row totals in DOM
            const cfg = lineDomConfig[type];
            const rows = document.querySelectorAll(`#${cfg.container} tr`);
            totals.lines.forEach((line, idx) => {
                if (rows[idx]) {
                    const totalEl = rows[idx].querySelector(cfg.fields.total);
                    if (totalEl) totalEl.textContent = (line.line_grand_total || 0).toFixed(2);
                }
            });
            if (type === 'sales') {
                const invTaxInput = document.getElementById('saleInvoiceTax');
                if (invTaxInput) invTaxInput.value = totals.invoiceTax.toFixed(2);
                const subEl = document.getElementById('saleSubtotal');
                const lineTaxEl = document.getElementById('saleTaxTotal');
                const invTaxEl = document.getElementById('saleInvoiceTaxDisplay');
                const grandEl = document.getElementById('saleGrandTotal');
                if (subEl) subEl.textContent = totals.subtotal.toFixed(2);
                if (lineTaxEl) lineTaxEl.textContent = totals.lineTax.toFixed(2);
                if (invTaxEl) invTaxEl.textContent = totals.invoiceTax.toFixed(2);
                if (grandEl) grandEl.textContent = totals.grand.toFixed(2);
            } else {
                const subEl = document.getElementById('purchaseSubtotal');
                const lineTaxEl = document.getElementById('purchaseTaxTotal');
                const invTaxEl = document.getElementById('purchaseInvoiceTaxDisplay');
                const grandEl = document.getElementById('purchaseGrandTotal');
                if (subEl) subEl.textContent = totals.subtotal.toFixed(2);
                if (lineTaxEl) lineTaxEl.textContent = totals.lineTax.toFixed(2);
                if (invTaxEl) invTaxEl.textContent = totals.invoiceTax.toFixed(2);
                if (grandEl) grandEl.textContent = totals.grand.toFixed(2);
            }
            return totals;
        };

        App.invoiceEngine.renderInvoiceModal = async function (invoice, type) {
            if (!invoice) return;
            const lines = App.invoiceEngine.normalizeLines(type, invoice.lines || invoice.line_items || []);
            const partyId = invoice.partyId || (
                type === 'sales'
                    ? (invoice.customer_id || invoice.customerId || invoice.customer || invoice.customerid)
                    : (invoice.supplier_id || invoice.supplierId || invoice.supplier || invoice.supplierid || invoice.supplier_name)
            );
            const partyName = getPartyNameDisplay(
                type,
                partyId,
                type === 'sales'
                    ? (invoice.partyNameSnapshot || invoice.partyNameSnapshot || '(Deleted Customer)')
                    : (invoice.partyNameSnapshot || invoice.partyNameSnapshot || '(Deleted Supplier)')
            );
            const totals = App.invoiceEngine.calculateTotals(type, lines, invoice.invoice_tax);
            const idValue = invoice.id || invoice.invoiceNo || invoice.invoice_no || '';
            const headerTitle = type === 'sales' ? 'SALES INVOICE' : 'PURCHASE INVOICE';
            const columnHeaders = type === 'sales'
                ? ['Size', 'Unit', 'Qty', 'Rate ()', 'Discount (%)', 'Line Tax ()', 'Total ()']
                : ['Category', 'Item', 'Size', 'Stage', 'Unit', 'Qty', 'Rate ()', 'Line Tax ()', 'Total ()'];

            let html = `<div class="invoice-details">
                <div class="invoice-header">
                    <div>
                        <h2 style="margin: 0;">${headerTitle}</h2>
                        <strong>Invoice ID:</strong> ${idValue}<br>
                        <strong>Date:</strong> ${invoice.date || ''}
                    </div>
                    <div style="text-align: right;">
                        <strong>${type === 'sales' ? 'Customer' : 'Supplier'}:</strong> ${partyName}
                    </div>
                </div>
                <table style="width: 100%; margin: 20px 0; border-collapse: collapse;">
                    <thead><tr>`;
            columnHeaders.forEach(col => {
                html += `<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">${col}</th>`;
            });
            html += `</tr></thead><tbody>`;

            for (const line of lines) {
                if (type === 'sales') {
                    const sizeName = App.utils.resolveSizeName(line.sizeId, 'N/A');
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${sizeName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.unit_type || ''}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${line.qty}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.rate_per_unit)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${(line.discount_pct || 0).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_tax_total)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_grand_total)}</td>
                    </tr>`;
                } else {
                    const sizeName = App.utils.resolveSizeName(line.sizeId, line.size || 'N/A');
                    const stageLabel = line.stage ? (typeof INVENTORY_STAGE_LABELS !== 'undefined' ? (INVENTORY_STAGE_LABELS[line.stage] || line.stage) : line.stage) : '';
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.category || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.description || line.item_name || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${sizeName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${stageLabel || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${line.unit_type || ''}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${line.qty || 0}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.rate_per_unit)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_tax_total)}</td>
                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${App.utils.formatCurrency(line.line_grand_total)}</td>
                    </tr>`;
                }
            }

            html += `</tbody></table>
                <div style="display:flex; justify-content:flex-end; gap:40px; background:#ecf0f1; padding:15px; border-radius:4px;">
                    <div style="text-align:right;">
                        <strong>Subtotal:</strong><br>
                        <strong>Line Taxes:</strong><br>
                        <strong>Invoice Tax:</strong><br>
                        <strong style="font-size:18px;">Grand Total:</strong>
                    </div>
                    <div style="text-align:right; min-width:150px;">
                        ${App.utils.formatCurrency(totals.subtotal)}<br>
                        ${App.utils.formatCurrency(totals.lineTax)}<br>
                        ${App.utils.formatCurrency(totals.invoiceTax)}<br>
                        <strong style="font-size:18px; color:#e74c3c;">${App.utils.formatCurrency(totals.grand)}</strong>
                    </div>
                </div>`;

            if (invoice.notes) {
                html += `<div style="margin-top: 20px;"><strong>Notes:</strong> ${invoice.notes}</div>`;
            }

            html += `</div>`;

            const target = document.getElementById('invoiceContent') || document.getElementById('invoiceModalBody');
            if (target) {
                target.innerHTML = html;
            }
            openModal('viewInvoiceModal');
        };

        App.invoiceEngine.getListConfig = function (type) {
            if (type === 'purchase') {
                return {
                    cacheKey: 'purchase',
                    idField: 'id',
                    tableId: 'purchaseInvoiceTable',
                    totalRowId: 'purchaseTotalRow',
                    totals: {
                        amount: 'purchaseTotalAmount',
                        lineTax: 'purchaseTotalLineTax',
                        invoiceTax: 'purchaseTotalInvoiceTax'
                    },
                    searchInputId: 'purchaseInvoiceSearch',
                    partyResolver: (id) => getPartyNameDisplay('purchase', id, '(Deleted Supplier)'),
                    viewFn: 'viewPurchaseInvoice',
                    editFn: 'editPurchaseInvoice',
                    deleteFn: 'deletePurchaseInvoice'
                };
            }
            return {
                cacheKey: 'sales',
                idField: 'id',
                tableId: 'salesInvoiceTable',
                totalRowId: 'salesTotalRow',
                totals: {
                    amount: 'salesTotalAmount',
                    lineTax: 'salesTotalLineTax',
                    invoiceTax: 'salesTotalInvoiceTax'
                },
                searchInputId: 'salesInvoiceSearch',
                partyResolver: (id) => getPartyNameDisplay('sales', id, '(Deleted Customer)'),
                viewFn: 'viewSalesInvoice',
                editFn: 'editSalesInvoice',
                deleteFn: 'deleteSalesInvoice'
            };
        };

        App.invoiceEngine.getFilteredInvoices = function (type) {
            const cfg = App.invoiceEngine.getListConfig(type);
            const searchTerm = (document.getElementById(cfg.searchInputId)?.value || '').toLowerCase().trim();
            const categoryFilter = type === 'purchase' ? (document.getElementById('purchaseCategoryFilter')?.value || 'All') : 'All';
            const base = Array.isArray(App.state.invoices[cfg.cacheKey]) ? App.state.invoices[cfg.cacheKey] : [];
            const unique = [];
            const seen = new Set();
            base.forEach(inv => {
                const key = inv.id;
                if (!key || seen.has(key)) return;
                seen.add(key);
                unique.push(inv);
            });
            const filteredByCategory = unique.filter(inv => type !== 'purchase' || categoryFilter === 'All' || (inv.lines || []).some(l => (l.category || '').toLowerCase() === categoryFilter.toLowerCase()));
            if (!searchTerm) return filteredByCategory;

            const numSearch = parseFloat(searchTerm);
            const isNumeric = !isNaN(numSearch);
            return filteredByCategory.filter(inv => {
                const idStr = (inv.id || '').toLowerCase();
                const partyId = inv.partyId;
                const party = (cfg.partyResolver(partyId) || '').toLowerCase();
                const notesStr = (inv.notes || '').toLowerCase();
                const dateStr = (inv.date || '').toLowerCase();
                const totals = [
                    inv.invoice_grand_total,
                    inv.invoice_subtotal,
                    inv.invoice_line_tax_total,
                    inv.invoice_tax
                ].map(Number).filter(n => !isNaN(n));

                const lineMatch = (inv.lines || []).some(l => {
                    const sizeName = App.utils.resolveSizeName(l.sizeId, l.size || '').toLowerCase();
                    const desc = (l.description || l.item_name || '').toLowerCase();
                    const category = (l.category || '').toLowerCase();
                    const stage = (l.stage || '').toLowerCase();
                    const unit = (l.unit_type || '').toLowerCase();
                    const qty = parseFloat(l.qty);
                    const rate = parseFloat(l.rate_per_unit || l.rate);
                    const tax = parseFloat(l.tax_per_unit || l.tax);
                    const lineTotal = parseFloat(l.line_grand_total || l.line_total_before_tax || 0);
                    const textMatch = [sizeName, desc, category, stage, unit].some(v => v.includes(searchTerm));
                    const numMatch = isNumeric && [qty, rate, tax, lineTotal].some(n => !isNaN(n) && n === numSearch);
                    return textMatch || numMatch;
                });

                const amountMatch = isNumeric && totals.some(n => n === numSearch);
                return idStr.includes(searchTerm)
                    || party.includes(searchTerm)
                    || notesStr.includes(searchTerm)
                    || dateStr.includes(searchTerm)
                    || lineMatch
                    || amountMatch;
            });
        };

        App.invoiceEngine.renderInvoiceTable = function (type) {
            const cfg = App.invoiceEngine.getListConfig(type);
            const tbody = document.querySelector(`#${cfg.tableId} tbody`);
            if (!tbody) return;
            const categoryFilter = type === 'purchase' ? (document.getElementById('purchaseCategoryFilter')?.value || 'All') : 'All';
            const totalRow = document.getElementById(cfg.totalRowId);
            tbody.querySelectorAll(`tr:not(#${cfg.totalRowId})`).forEach(row => row.remove());

            const invoices = App.invoiceEngine.getFilteredInvoices(type);
            let totalAmount = 0;
            let totalLineTax = 0;
            let totalInvoiceTax = 0;
            invoices.forEach(inv => {
                const idVal = inv.id;
                const partyId = inv.partyId;
                const partyName = cfg.partyResolver(partyId);
                const row = document.createElement('tr');
                const viewId = idVal ? idVal.replace(/"/g, '') : '';
                const editDisabled = App.hasPermission('editInvoices') ? '' : 'disabled aria-disabled="true"';
                const deleteDisabled = App.hasPermission('deleteInvoices') ? '' : 'disabled aria-disabled="true"';
                row.innerHTML = `<td class="checkbox-column"><input type="checkbox" class="${type}InvoiceCheckbox" data-id="${viewId}"></td>
                    <td>${inv.date || ''}</td>
                    <td>${partyName}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_grand_total)}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_line_tax_total)}</td>
                    <td class="currency">${App.utils.formatCurrency(inv.invoice_tax || 0)}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" onclick="${cfg.viewFn}('${viewId}')">View</button>
                            <button type="button" ${editDisabled} onclick="${cfg.editFn}('${viewId}')">Edit</button>
                            <button type="button" class="danger" ${deleteDisabled} onclick="${cfg.deleteFn}('${viewId}')">Delete</button>
                        </div>
                    </td>`;
                tbody.insertBefore(row, totalRow);
                totalAmount += Number(inv.invoice_grand_total || 0);
                totalLineTax += Number(inv.invoice_line_tax_total || 0);
                totalInvoiceTax += Number(inv.invoice_tax || 0);
            });

            const totals = cfg.totals;
            document.getElementById(totals.amount).textContent = '' + totalAmount.toFixed(2);
            document.getElementById(totals.lineTax).textContent = '' + totalLineTax.toFixed(2);
            document.getElementById(totals.invoiceTax).textContent = '' + totalInvoiceTax.toFixed(2);
            if (type === 'purchase') {
                const summaryElement = document.getElementById('categoryTotalsSummary');
                if (summaryElement) {
                    summaryElement.innerHTML = categoryFilter && categoryFilter !== 'All'
                        ? `Showing ${invoices.length} invoices for ${categoryFilter}`
                        : `Showing ${invoices.length} purchase invoices`;
                }
            }
            setTimeout(() => addDataLabelsToTable(cfg.tableId), 50);
        };

        // ========== LEDGER CLEANUP FUNCTION ==========
        async function cleanupDuplicateLedgers() {
            if (!isConnected) {
                alert("No internet connection. Cannot cleanup ledgers.");
                return;
            }

            if (!confirm("This will delete all duplicate and extra ledger entries that don't correspond to actual invoices. This action cannot be undone. Continue?")) {
                return;
            }

            try {
                const statusElement = document.getElementById('backupStatus');
                statusElement.innerHTML = '<div class="alert"> Cleaning up ledger entries...</div>';

                // Get all data
                const salesInvoices = await App.db.listInvoices('sales');
                const purchaseInvoices = await App.db.listInvoices('purchase');
                const allLedgers = await fbGetAll('ledgerEntries');

                // Create sets of valid invoice IDs
                const validSalesInvoiceIds = new Set(salesInvoices.map(inv => inv.invoice_id));
                const validPurchaseInvoiceIds = new Set(purchaseInvoices.map(inv => inv.purchase_id));

                // Track which ledgers to keep and delete
                const ledgersToKeep = [];
                const ledgersToDelete = [];
                const seenEntries = new Set();

                for (const ledger of allLedgers) {
                    const key = `${ledger.date}_${ledger.party_type}_${ledger.party_id}_${ledger.reference_type}_${ledger.reference_id}_${ledger.debit}_${ledger.credit}_${ledger.note}`;

                    // Check if this is a duplicate
                    if (seenEntries.has(key)) {
                        ledgersToDelete.push(ledger);
                        continue;
                    }

                    seenEntries.add(key);

                    // Check if this ledger corresponds to a valid invoice
                    if (ledger.reference_type === 'SALE') {
                        if (validSalesInvoiceIds.has(ledger.reference_id)) {
                            ledgersToKeep.push(ledger);
                        } else {
                            ledgersToDelete.push(ledger);
                        }
                    } else if (ledger.reference_type === 'PURCHASE') {
                        if (validPurchaseInvoiceIds.has(ledger.reference_id)) {
                            ledgersToKeep.push(ledger);
                        } else {
                            ledgersToDelete.push(ledger);
                        }
                    } else {
                        // Keep manual adjustments and bank transactions
                        ledgersToKeep.push(ledger);
                    }
                }

                // Delete the invalid/duplicate ledger entries
                let deletedCount = 0;
                for (const ledger of ledgersToDelete) {
                    await fbDelete('ledgerEntries', ledger.id);
                    deletedCount++;
                }

                statusElement.innerHTML = `<div class="alert success"> Cleanup completed! Deleted ${deletedCount} duplicate/invalid ledger entries. Kept ${ledgersToKeep.length} valid entries.</div>`;

                console.log(`Ledger cleanup: Deleted ${deletedCount} entries, kept ${ledgersToKeep.length} entries`);

            } catch (error) {
                console.error("Error during ledger cleanup:", error);
                document.getElementById('backupStatus').innerHTML = '<div class="alert danger"> Error during cleanup: ' + error.message + '</div>';
            }
        }

        // ========== UI Helpers ==========
        function getToday() {
            const now = new Date();
            const istDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
            const year = istDate.getFullYear();
            const month = String(istDate.getMonth() + 1).padStart(2, '0');
            const day = String(istDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getFirstDayOfMonth() {
            const now = new Date();
            const istDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
            const year = istDate.getFullYear();
            const month = String(istDate.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}-01`;
        }

        function openModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.add('active');
            el.style.display = 'flex';
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('active');
            }
            if (el && el.style) {
                el.style.display = 'none';
            }
        }

        // ============================================
        // MOBILE HELPER FUNCTIONS
        // ============================================
        function addDataLabelsToTable(tableId) {
            // Add data-label attributes to table cells for mobile card layout
            const table = document.getElementById(tableId);
            if (!table) return;

            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    if (headers[index] && !cell.classList.contains('checkbox-column')) {
                        cell.setAttribute('data-label', headers[index]);
                    }
                });
            });
        }

        // Auto-add data labels to all tables after rendering
        function updateAllTableLabels() {
            const tables = document.querySelectorAll('table[id]');
            tables.forEach(table => {
                addDataLabelsToTable(table.id);
            });
        }

        // ============================================
        // MOBILE MENU FUNCTIONS
        // ============================================
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const menuToggle = document.getElementById('mobileMenuToggle');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            // Change icon
            if (sidebar.classList.contains('active')) {
                menuToggle.textContent = '';
                menuToggle.classList.add('open');
                overlay.style.left = '280px';
                overlay.style.width = 'calc(100% - 280px)';
            } else {
                menuToggle.textContent = '';
                menuToggle.classList.remove('open');
                overlay.style.left = '0';
                overlay.style.width = '100%';
            }
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const menuToggle = document.getElementById('mobileMenuToggle');

            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            menuToggle.textContent = '';
            menuToggle.classList.remove('open');
            overlay.style.left = '0';
            overlay.style.width = '100%';
        }

        // Close mobile menu when clicking on any tab
        function closeMobileMenuOnTabClick() {
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        }

        // ============================================
        // ORIGINAL TAB SWITCHING FUNCTION
        // ============================================
        function switchMainTab(tabId, btnElement) {
            // Close mobile menu when switching tabs
            closeMobileMenuOnTabClick();

            // Permission Check
            if (!canAccessTab(tabId)) {
                alert(' Access Denied: You do not have permission to view this section.');
                recordActionLog('AccessDenied', `Blocked access to tab ${tabId}`, { tabId: tabId });
                return;
            }

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Remove active class from all sidebar buttons
            document.querySelectorAll('.sidebar .tab-button').forEach(el => el.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            // Add active class to clicked button
            if (btnElement) {
                btnElement.classList.add('active');
            } else {
                // If no button passed, try to find it
                const btn = document.querySelector(`.sidebar .tab-button[data-tab-id="${tabId}"]`);
                if (btn) btn.classList.add('active');
            }

            // Save state
            localStorage.setItem('factoryLastTab', tabId);

            // Specific logic for tabs
            if (tabId === 'sales') {
                // Default subtab
                switchSalesSubtab('sales-create', document.querySelector('#sales .subtab-btn'));
            } else if (tabId === 'purchase') {
                switchPurchaseSubtab('purchase-create', document.querySelector('#purchase .subtab-btn'));
            } else if (tabId === 'reports') {
                // Refresh reports if needed
            } else if (tabId === 'inventory') {
                renderInventoryTab();
            } else if (tabId === 'users') {
                renderRolesTab(); // Default to roles or users
            }


            recordActionLog('Main Tab Switch', `Opened ${tabId} tab`, { tab: tabId });
        }

        function switchSalesSubtab(id, btn) {
            const parent = document.getElementById('sales');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchPurchaseSubtab(id, btn) {
            const parent = document.getElementById('purchase');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchReportsSubtab(id, btn) {
            const parent = document.getElementById('reports');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if (id === 'report-elaborate') {
                generateElaborateReport();
            } else if (id === 'report-activity-logs') {
                generateActivityLogs(false);
            }
            recordActionLog('Report Tab Switch', `Opened ${id}`, { tab: id });
        }

        function switchMastersSubtab(id, btn) {
            const parent = document.getElementById('masters');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function switchPLSubtab(id, btn) {
            const parent = document.getElementById('report-pl');
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        // ========== CUSTOMER AUTOCOMPLETE ==========
        document.getElementById('saleCustomer').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('saleCustomerList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const matches = customers.filter(c => c.display_name.toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(cust => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = cust.display_name;
                div.onclick = () => {
                    e.target.value = cust.display_name;
                    document.getElementById('saleCustomerId').value = cust.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // Quote customer autocomplete
        document.getElementById('quoteCustomer').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('quoteCustomerList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const matches = customers.filter(c => (c.display_name || '').toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(cust => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = cust.display_name;
                div.onclick = () => {
                    e.target.value = cust.display_name;
                    document.getElementById('quoteCustomerId').value = cust.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ========== SUPPLIER AUTOCOMPLETE ==========
        document.getElementById('purchaseSupplier').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('purchaseSupplierList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const suppliers = await fbGetAll('suppliers');
            const matches = suppliers.filter(s => s.supplier_name.toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(supp => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = supp.supplier_name;
                div.onclick = () => {
                    e.target.value = supp.supplier_name;
                    document.getElementById('purchaseSupplierId').value = supp.id;
                    dropdown.classList.remove('active');
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ========== LEDGER PARTY SEARCH ==========
        document.getElementById('ledgerPartySearch').addEventListener('input', async (e) => {
            const search = e.target.value.toLowerCase();
            const dropdown = document.getElementById('ledgerPartyList');
            if (!search) { dropdown.classList.remove('active'); return; }
            const customers = await fbGetAll('customers');
            const suppliers = await fbGetAll('suppliers');
            const allParties = [...customers.map(c => ({ ...c, type: 'CUSTOMER' })), ...suppliers.map(s => ({ ...s, type: 'SUPPLIER' }))];
            const matches = allParties.filter(p => (p.display_name || p.supplier_name).toLowerCase().includes(search));
            dropdown.innerHTML = '';
            matches.forEach(p => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = `${p.display_name || p.supplier_name} (${p.type})`;
                div.onclick = () => {
                    e.target.value = p.display_name || p.supplier_name;
                    document.getElementById('ledgerPartyId').value = p.id;
                    document.getElementById('ledgerPartyType').value = p.type;
                    document.getElementById('ledgerPartyName').textContent = p.display_name || p.supplier_name;
                    dropdown.classList.remove('active');
                    showLedgerForParty(p.id, p.type, p.display_name || p.supplier_name);
                };
                dropdown.appendChild(div);
            });
            if (matches.length > 0) dropdown.classList.add('active');
        });

        // ======== LEDGER VIEW & MANUAL ADJUSTMENT ========
        async function showLedgerForParty(partyId, partyType, partyName) {
            try {
                if (!partyId || !partyType) {
                    App.ui.showToast('Select a customer or supplier first.', 'error');
                    return;
                }
                const section = document.getElementById('ledgerViewSection');
                const tbody = document.querySelector('#ledgerTable tbody');
                const netBalanceEl = document.getElementById('netBalance');
                const balanceNoteEl = document.getElementById('balanceNote');
                if (!section || !tbody) return;

                const allLedgers = await fbGetAll('ledgerEntries');
                const entries = (allLedgers || []).filter(l => l.party_id === partyId && l.party_type === partyType);

                entries.sort((a, b) => {
                    const da = a.date || '';
                    const db = b.date || '';
                    if (da < db) return -1;
                    if (da > db) return 1;
                    const ra = a.reference_id || '';
                    const rb = b.reference_id || '';
                    return ra.localeCompare(rb);
                });

                tbody.innerHTML = '';
                let running = 0;
                entries.forEach(entry => {
                    const debit = Number(entry.debit) || 0;
                    const credit = Number(entry.credit) || 0;
                    running += (debit - credit);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${entry.date || ''}</td>
                        <td>${entry.reference_id || ''}</td>
                        <td>${entry.reference_type || ''}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(debit) : debit.toFixed(2)}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(credit) : credit.toFixed(2)}</td>
                        <td class="currency">${App.utils.formatCurrency ? App.utils.formatCurrency(running) : running.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                if (netBalanceEl) {
                    netBalanceEl.textContent = App.utils.formatCurrency ? App.utils.formatCurrency(running) : running.toFixed(2);
                }
                if (balanceNoteEl) {
                    const name = partyName || 'this party';
                    if (running > 0) balanceNoteEl.textContent = `${name} owes you this amount.`;
                    else if (running < 0) balanceNoteEl.textContent = `You owe ${name} this amount.`;
                    else balanceNoteEl.textContent = 'No net outstanding balance.';
                }
                section.style.display = 'block';
            } catch (err) {
                console.error('Unable to load ledger entries', err);
                App.ui.showToast(err.message || 'Unable to load ledger entries', 'error');
            }
        }

        async function saveManualAdjustment() {
            const partyId = document.getElementById('ledgerPartyId')?.value;
            const partyType = document.getElementById('ledgerPartyType')?.value;
            const partyName = document.getElementById('ledgerPartyName')?.textContent || '';
            if (!partyId || !partyType) {
                App.ui.showToast('Select a party before saving an adjustment.', 'error');
                return;
            }
            const date = document.getElementById('manualAdjDate')?.value || getToday();
            const debitVal = Number(document.getElementById('manualAdjDebit')?.value) || 0;
            const creditVal = Number(document.getElementById('manualAdjCredit')?.value) || 0;
            const noteVal = (document.getElementById('manualAdjNote')?.value || '').trim() || 'Manual adjustment';

            if (debitVal === 0 && creditVal === 0) {
                App.ui.showToast('Enter a debit or credit amount.', 'error');
                return;
            }
            if (debitVal !== 0 && creditVal !== 0) {
                App.ui.showToast('Use either debit or credit, not both.', 'error');
                return;
            }

            const entry = {
                date,
                party_type: partyType,
                party_id: partyId,
                reference_type: 'ADJUSTMENT',
                reference_id: 'ADJ-' + Date.now(),
                debit: debitVal,
                credit: creditVal,
                note: noteVal
            };

            try {
                await safePush('ledgerEntries', entry);
                App.ui.showToast('Manual adjustment saved.', 'success');
                const debitEl = document.getElementById('manualAdjDebit');
                const creditEl = document.getElementById('manualAdjCredit');
                const noteEl = document.getElementById('manualAdjNote');
                if (debitEl) debitEl.value = '0';
                if (creditEl) creditEl.value = '0';
                if (noteEl) noteEl.value = '';
                await showLedgerForParty(partyId, partyType, partyName);
            } catch (err) {
                console.error('Error saving manual adjustment', err);
                App.ui.showToast(err.message || 'Unable to save adjustment', 'error');
            }
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // ========== SALES INVOICE ==========
        async function addSaleLine(initialData = null) {
            const tbody = document.getElementById('saleLineItems');
            const id = 'sl_' + Date.now();
            const row = document.createElement('tr');
            row.id = id;
            row.innerHTML = `
                <td>
                    <div class="autocomplete-wrapper">
                        <input type="text" class="sl-size autocomplete-input" placeholder="Type size name..." data-id="${id}" autocomplete="off">
                        <div class="autocomplete-dropdown" id="saleSizeDropdown_${id}"></div>
                    </div>
                </td>
                <td><select class="sl-unit" data-id="${id}"><option value="KG">KG</option><option value="PKT">PKT</option></select></td>
                <td><input type="number" class="sl-qty" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="sl-rate" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="sl-disc" min="0" max="100" step="0.01" data-id="${id}" value="0"></td>
                <td><input type="number" class="sl-tax" step="0.01" data-id="${id}"></td>
                <td><span class="sl-total">0</span></td>
                <td><button type="button" onclick="document.getElementById('${id}').remove(); updateSalesTotals();" class="danger">Delete</button></td>
            `;
            tbody.appendChild(row);

            const sizeInput = row.querySelector('.sl-size');
            const dropdown = row.querySelector(`#saleSizeDropdown_${id}`);

            sizeInput.addEventListener('input', async (e) => {
                const search = e.target.value.toLowerCase();
                if (!search) { dropdown.classList.remove('active'); return; }
                const sizes = await fbGetAll('sizes');
                const matches = sizes.filter(s => (s.size_name || '').toLowerCase().includes(search) || (s.code || '').toLowerCase().includes(search));
                dropdown.innerHTML = '';
                matches.forEach(size => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${size.size_name} (${size.code})`;
                    div.onclick = async () => {
                        e.target.value = size.size_name;
                        e.target.dataset.sizeId = size.id;
                        row.querySelector('.sl-unit').value = size.default_unit_type || 'KG';
                        // Auto-set rate based on unit
                        const unit = row.querySelector('.sl-unit').value;
                        row.querySelector('.sl-rate').value = unit === 'KG' ? size.price_per_kg || 0 : size.price_per_pkt || 0;
                        dropdown.classList.remove('active');
                        updateSalesTotals();
                    };
                    dropdown.appendChild(div);
                });
                if (matches.length > 0) dropdown.classList.add('active');
            });

            // Auto-update rate when unit changes
            row.querySelector('.sl-unit').addEventListener('change', async (e) => {
                const sizeId = sizeInput.dataset.sizeId;
                if (sizeId) {
                    const fullSize = await fbGet('sizes', sizeId);
                    row.querySelector('.sl-rate').value = e.target.value === 'KG' ? fullSize.price_per_kg || 0 : fullSize.price_per_pkt || 0;
                    updateSalesTotals();
                }
            });

            function applyInitialData(data) {
                if (!data) return;
                if (data.sizeName) {
                    sizeInput.value = data.sizeName;
                }
                if (data.sizeId) {
                    sizeInput.dataset.sizeId = data.sizeId;
                }
                if (data.unit) row.querySelector('.sl-unit').value = data.unit;
                if (typeof data.qty !== 'undefined') row.querySelector('.sl-qty').value = data.qty;
                if (typeof data.rate !== 'undefined') row.querySelector('.sl-rate').value = data.rate;
                if (typeof data.discount !== 'undefined') row.querySelector('.sl-disc').value = data.discount;
                if (typeof data.tax !== 'undefined') row.querySelector('.sl-tax').value = data.tax;
                if (typeof data.total !== 'undefined') row.querySelector('.sl-total').textContent = Number(data.total).toFixed(2);
            }

            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updateSalesTotals);
                el.addEventListener('change', updateSalesTotals);
            });
            applyInitialData(initialData);
            updateSalesTotals();
            return row;
        }

        function updateSalesTotals() {
            App.invoiceEngine.refreshTotals('sales');
        }

        async function saveSalesInvoice() {
            const form = document.getElementById('salesInvoiceForm');
            App.utils.clearValidation(form);
            if (!App.hasPermission('editInvoices')) {
                App.ui.showToast('You do not have permission to edit invoices', 'error');
                return;
            }

            const date = document.getElementById('saleDate').value;
            const custId = document.getElementById('saleCustomerId').value;
            const lines = App.invoiceEngine.readLinesFromDOM('sales');
            const totals = App.invoiceEngine.calculateTotals('sales', lines);
            const existingId = document.getElementById('saleInvoiceIdEdit').value;
            const invId = existingId || await App.invoiceEngine.nextInvoiceId('sales');

            const custRecord = getCustomerById(custId);
            const invoice = {
                id: invId,
                date,
                partyId: custId,
                partyNameSnapshot: custRecord ? custRecord.name : 'Customer',
                partyGstSnapshot: custRecord ? custRecord.gstNumber : '',
                lines,
                invoice_subtotal: totals.subtotal,
                invoice_line_tax_total: totals.lineTax,
                invoice_tax: totals.invoiceTax,
                invoice_grand_total: totals.grand,
                notes: document.getElementById('saleNotes').value || '',
                updatedAt: new Date().toISOString(),
                createdBy: typeof getCurrentUserName === 'function' ? getCurrentUserName() : 'User'
            };

            const validation = App.invoiceEngine.validateInvoice('sales', { date, partyId: custId, lines, totals });
            if (!validation.valid) {
                validation.errors.forEach(err => {
                    if (err.field === 'date') App.utils.markInvalid(document.getElementById('saleDate'), err.message);
                    if (err.field === 'party') App.utils.markInvalid(document.getElementById('saleCustomer'), err.message);
                    if (err.field.startsWith('line-')) {
                        const parts = err.field.split('-');
                        const idx = parseInt(parts[1], 10);
                        const rows = document.querySelectorAll('#saleLineItems tr');
                        const row = rows[idx];
                        if (row) {
                            const fieldKey = parts[2];
                            if (fieldKey === 'qty') App.utils.markInvalid(row.querySelector('.sl-qty'), err.message);
                            if (fieldKey === 'rate') App.utils.markInvalid(row.querySelector('.sl-rate'), err.message);
                            if (fieldKey === 'size') App.utils.markInvalid(row.querySelector('.sl-size'), err.message);
                        }
                    }
                });
                App.ui.showToast(validation.errors[0].message, 'error');
                return;
            }

            try {
                await App.db.saveInvoice('sales', invoice);
            } catch (error) {
                console.error('Error saving invoice', error);
                App.ui.showToast(error.message || 'Unable to save invoice', 'error');
                return;
            }

            // Ledger handling
            try {
                if (isConnected) {
                    const allLedgers = await fbGetAll('ledgerEntries');
                    const existingLedgers = allLedgers.filter(l => l.reference_id === invId && l.reference_type === 'SALE');
                    for (const led of existingLedgers) {
                        await fbDelete('ledgerEntries', led.id);
                    }
                }
                await safePush('ledgerEntries', {
                    date,
                    party_type: 'CUSTOMER',
                    party_id: custId,
                    reference_type: 'SALE',
                    reference_id: invId,
                    debit: totals.grand,
                    credit: 0,
                    note: `Sale ${invId}`
                });
            } catch (err) {
                console.warn('Ledger update skipped', err);
            }

            // Stock adjustments
            for (const line of lines) {
                if (line.sizeId) {
                    let stock = null;
                    try {
                        stock = await fbGet('stockLevels', line.sizeId);
                    } catch (err) { }
                    if (!stock) stock = { size_id: line.sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                    if (line.unit_type === 'PKT') stock.finished_goods_qty -= line.qty;
                    await safePut('stockLevels', line.sizeId, stock);
                }
            }

            const customerName = App.utils.resolveName('customer', custId, 'Customer');
            recordActionLog(
                existingId ? 'Sales Invoice Updated' : 'Sales Invoice Created',
                `${existingId ? 'Updated' : 'Created'} sales invoice ${invId} for ${customerName}`,
                {
                    entityType: 'salesInvoice',
                    invoiceId: invId,
                    customerId: custId,
                    customerName,
                    grandTotal: totals.grand,
                    date,
                    linesCount: lines.length
                }
            );

            clearSalesForm();
            App.ui.showToast(`Saved invoice ${invId}`, 'success');
        }

        function clearSalesForm() {
            document.getElementById('salesInvoiceForm').reset();
            document.getElementById('saleDate').value = getToday();
            document.getElementById('saleLineItems').innerHTML = '';
            document.getElementById('saleCustomerId').value = '';
            document.getElementById('saleInvoiceTax').value = '0';
            document.getElementById('saleSubtotal').textContent = '0';
            document.getElementById('saleTaxTotal').textContent = '0';
            document.getElementById('saleInvoiceTaxDisplay').textContent = '0';
            document.getElementById('saleGrandTotal').textContent = '0';
            document.getElementById('saleInvoiceIdEdit').value = '';
            // Add initial line item after clearing
            addSaleLine();
        }

        async function refreshSalesInvoiceList() {
            try {
                await App.db.listInvoices('sales');
                App.invoiceEngine.renderInvoiceTable('sales');
            } catch (error) {
                console.error("Error refreshing sales invoices:", error);
            }
        }

        async function refreshPurchaseInvoiceList() {
            try {
                // Load purchase invoices into App.state.invoices.purchase
                await App.db.listInvoices('purchase');
                // Re-render purchase invoice table using the unified engine
                App.invoiceEngine.renderInvoiceTable('purchase');
            } catch (error) {
                console.error("Error refreshing purchase invoices:", error);
            }
        }

        async function viewSalesInvoice(invId) {
            try {
                const inv = await App.db.getInvoice('sales', invId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                await App.invoiceEngine.renderInvoiceModal(inv, 'sales');
            } catch (error) {
                console.error("Error viewing sales invoice:", error);
                App.ui.showToast("Error viewing sales invoice: " + error.message, 'error');
            }
        }

        async function editSalesInvoice(invId) {
            try {
                const inv = await App.db.getInvoice('sales', invId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                const customerId = inv.partyId || '';
                const customerName = getPartyNameDisplay('sales', customerId, inv.partyNameSnapshot || 'Customer');
                document.getElementById('saleDate').value = inv.date;
                document.getElementById('saleCustomer').value = customerName;
                document.getElementById('saleCustomerId').value = customerId;
                document.getElementById('saleInvoiceTax').value = inv.invoice_tax || '0';
                document.getElementById('saleNotes').value = inv.notes || '';
                document.getElementById('saleLineItems').innerHTML = '';

                for (const line of inv.lines || []) {
                    const sizeName = line.sizeId ? getSizeLabel(line.sizeId) : '';
                    await addSaleLine({
                        sizeName,
                        sizeId: line.sizeId || '',
                        unit: line.unit_type || 'KG',
                        qty: line.qty,
                        rate: line.rate_per_unit,
                        discount: line.discount_pct || 0,
                        tax: line.tax_per_unit,
                        total: line.line_grand_total
                    });
                }
                document.getElementById('saleInvoiceIdEdit').value = invId;
                updateSalesTotals();
                switchSalesSubtab('sales-create', document.querySelector('#sales .subtab-btn'));
            } catch (error) {
                App.ui.reportIssue('Error editing sales invoice', error, 'error');
            }
        }

        async function deleteSalesInvoice(invId) {
            if (!App.hasPermission('deleteInvoices')) {
                App.ui.showToast('You do not have permission to delete invoices', 'error');
                return;
            }
            const inv = await App.db.getInvoice('sales', invId);
            if (!inv) {
                App.ui.showToast('Invoice not found', 'error');
                return;
            }
            const customerName = getPartyNameDisplay('sales', inv.partyId, inv.partyNameSnapshot || 'Customer');
            if (!confirm(`Delete invoice ${invId} for ${customerName}?`)) return;
            try {
                for (const line of inv.lines || []) {
                    if (line.sizeId) {
                        let stock = await fbGet('stockLevels', line.sizeId).catch(() => null) || { size_id: line.sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                        if (line.unit_type === 'PKT') stock.finished_goods_qty = (stock.finished_goods_qty || 0) + (line.qty || 0);
                        await safePut('stockLevels', line.sizeId, stock);
                    }
                }
                try {
                    const ledgers = await fbGetAll('ledgerEntries');
                    const entries = ledgers.filter(l => l.reference_id === invId && l.reference_type === 'SALE');
                    for (const ent of entries) {
                        await safeDelete('ledgerEntries', ent.id);
                    }
                } catch (err) {
                    App.ui.reportIssue('Unable to clear ledger entries for sale', err, 'warning');
                }
                await App.db.deleteInvoice('sales', invId);
                recordActionLog('Sales Invoice Deleted', `Deleted sales invoice ${invId} for ${customerName}`, {
                    entityType: 'salesInvoice',
                    invoiceId: invId,
                    partyId: inv.partyId,
                    grandTotal: inv.invoice_grand_total
                });
                App.ui.showToast('Sales invoice deleted', 'success');
            } catch (err) {
                App.ui.reportIssue('Error deleting sales invoice', err, 'error');
            }
        }

        // ========== PURCHASE INVOICE ==========
        const READY_SCREW_STAGE_OPTIONS = [
            { value: 'Header', label: 'Header Output' },
            { value: 'Rolling', label: 'Rolling Output' },
            { value: 'Furnace', label: 'Hardening Output' },
            { value: 'Tampering', label: 'Tampering Output' },
            { value: 'Plating', label: 'Plating Output' },
            { value: 'Finished Goods', label: 'Finished Goods' }
        ];

        function toggleReadyScrewFields(row, categorySelect) {
            const show = (categorySelect?.value || '').toLowerCase() === 'ready screws';
            row.querySelectorAll('.ready-only-field').forEach(el => {
                el.style.display = show ? '' : 'none';
            });
            if (!show) {
                const sizeInput = row.querySelector('.it-size');
                const stageSelect = row.querySelector('.it-stage');
                const bagsInput = row.querySelector('.it-bags');
                if (sizeInput) {
                    sizeInput.value = '';
                    delete sizeInput.dataset.sizeId;
                }
                if (stageSelect) stageSelect.value = '';
                if (bagsInput) bagsInput.value = '';
            }
        }

        async function addPurchaseLine(initialData = null) {
            const tbody = document.getElementById('purchaseLineItems');
            const id = 'pl_' + Date.now();
            const stageOptionsHtml = READY_SCREW_STAGE_OPTIONS.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            const row = document.createElement('tr');
            row.id = id;
            row.innerHTML = `
                <td><select class="it-category" data-id="${id}">
                    <option value="">Select Category</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Machine Repair">Machine Repair</option>
                    <option value="RAW MATERIALS">RAW MATERIALS</option>
                    <option value="Other">Other</option>
                    <option value="Wire">Wire</option>
                    <option value="Ready Screws">Ready Screws</option>
                    <option value="P E">P E</option>
                    <option value="miscellaneous">miscellaneous</option>
                </select></td>
                <td><input type="text" class="it-name" placeholder="Description" data-id="${id}"></td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <div class="autocomplete-wrapper">
                            <input type="text" class="it-size autocomplete-input" placeholder="Type size name..." data-id="${id}" autocomplete="off">
                            <div class="autocomplete-dropdown" id="purchaseSizeDropdown_${id}"></div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <select class="it-stage" data-id="${id}">
                            <option value="">Select Stage</option>
                            ${stageOptionsHtml}
                        </select>
                    </div>
                </td>
                <td>
                    <div class="ready-only-field" style="display:none;">
                        <input type="number" class="it-bags" min="1" step="1" placeholder="# Bags">
                    </div>
                </td>
                <td><select class="it-unit" data-id="${id}"><option>KG</option><option>PKT</option></select></td>
                <td><input type="number" class="it-qty" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="it-rate" step="0.01" data-id="${id}"></td>
                <td><input type="number" class="it-tax" step="0.01" data-id="${id}"></td>
                <td><span class="it-total">0</span></td>
                <td><button type="button" onclick="document.getElementById('${id}').remove(); updatePurchaseTotals();" class="danger" style="padding: 4px 8px; font-size: 12px;">Delete</button></td>
            `;
            tbody.appendChild(row);

            const categorySelect = row.querySelector('.it-category');
            const sizeInput = row.querySelector('.it-size');
            const dropdown = row.querySelector(`#purchaseSizeDropdown_${id}`);
            const stageSelect = row.querySelector('.it-stage');
            const bagsInput = row.querySelector('.it-bags');

            sizeInput?.addEventListener('input', async (e) => {
                const search = e.target.value.toLowerCase();
                if (!search) { dropdown.classList.remove('active'); return; }
                let sizes = Array.isArray(App.state.sizes) && App.state.sizes.length ? App.state.sizes : null;
                if (!sizes) {
                    try {
                        sizes = await fbGetAll('sizes');
                        updateCaches(sizes, 'sizes');
                    } catch (err) {
                        sizes = [];
                    }
                }
                const matches = sizes.filter(s => (s.size_name || '').toLowerCase().includes(search) || (s.code || '').toLowerCase().includes(search));
                dropdown.innerHTML = '';
                matches.forEach(size => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.textContent = `${size.size_name} (${size.code})`;
                    div.onclick = () => {
                        e.target.value = size.size_name;
                        e.target.dataset.sizeId = size.id;
                        row.querySelector('.it-unit').value = size.default_unit_type || 'KG';
                        const unit = row.querySelector('.it-unit').value;
                        row.querySelector('.it-rate').value = unit === 'KG' ? size.price_per_kg || 0 : size.price_per_pkt || 0;
                        dropdown.classList.remove('active');
                        updatePurchaseTotals();
                    };
                    dropdown.appendChild(div);
                });
                if (matches.length > 0) dropdown.classList.add('active');
            });

            row.querySelector('.it-unit').addEventListener('change', async (e) => {
                const sizeId = sizeInput?.dataset.sizeId;
                if (sizeId) {
                    const fullSize = App.cache.sizesById[sizeId] || await fbGet('sizes', sizeId);
                    if (fullSize) {
                        row.querySelector('.it-rate').value = e.target.value === 'KG' ? fullSize.price_per_kg || 0 : fullSize.price_per_pkt || 0;
                        updatePurchaseTotals();
                    }
                }
            });

            function applyInitialData(data) {
                if (!data) return;
                if (data.category) categorySelect.value = data.category;
                if (data.description) row.querySelector('.it-name').value = data.description;
                if (data.sizeName) {
                    sizeInput.value = data.sizeName;
                    sizeInput.dataset.sizeId = data.sizeId || '';
                }
                if (stageSelect) {
                    if (data.stage) {
                        stageSelect.value = data.stage;
                    } else if ((data.category || '').toLowerCase() === 'ready screws') {
                        stageSelect.value = 'Finished Goods';
                    }
                }
                if (typeof data.receivedBags !== 'undefined' && bagsInput) {
                    bagsInput.value = data.receivedBags;
                }
                if (data.unit) row.querySelector('.it-unit').value = data.unit;
                if (typeof data.qty !== 'undefined') row.querySelector('.it-qty').value = data.qty;
                if (typeof data.rate !== 'undefined') row.querySelector('.it-rate').value = data.rate;
                if (typeof data.tax !== 'undefined') row.querySelector('.it-tax').value = data.tax;
                if (typeof data.total !== 'undefined') row.querySelector('.it-total').textContent = Number(data.total).toFixed(2);
            }

            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', updatePurchaseTotals);
                el.addEventListener('change', updatePurchaseTotals);
            });

            categorySelect.addEventListener('change', () => toggleReadyScrewFields(row, categorySelect));
            applyInitialData(initialData);
            toggleReadyScrewFields(row, categorySelect);
            return row;
        }

        function updatePurchaseTotals() {
            App.invoiceEngine.refreshTotals('purchase');
        }

        async function savePurchaseInvoice() {
            const form = document.getElementById('purchaseInvoiceForm');
            App.utils.clearValidation(form);
            if (!App.hasPermission('editInvoices')) {
                App.ui.showToast('You do not have permission to edit invoices', 'error');
                return;
            }

            const date = document.getElementById('purchaseDate').value;
            const suppId = document.getElementById('purchaseSupplierId').value;
            const lines = App.invoiceEngine.readLinesFromDOM('purchase');
            const invoiceTaxInput = parseFloat(document.getElementById('purchaseInvoiceTax').value) || 0;
            const totals = App.invoiceEngine.calculateTotals('purchase', lines, invoiceTaxInput);
            const existingId = document.getElementById('purchaseInvoiceIdEdit').value;
            const purId = existingId || await App.invoiceEngine.nextInvoiceId('purchase');

            const suppRecord = getSupplierById(suppId);
            const invoice = {
                id: purId,
                date,
                partyId: suppId,
                partyNameSnapshot: suppRecord ? suppRecord.name : 'Supplier',
                partyGstSnapshot: suppRecord ? suppRecord.gstNumber : '',
                lines,
                invoice_subtotal: totals.subtotal,
                invoice_line_tax_total: totals.lineTax,
                invoice_tax: totals.invoiceTax,
                invoice_grand_total: totals.grand,
                notes: document.getElementById('purchaseNotes').value || '',
                updatedAt: new Date().toISOString(),
                createdBy: typeof getCurrentUserName === 'function' ? getCurrentUserName() : 'User'
            };

            const validation = App.invoiceEngine.validateInvoice('purchase', { date, partyId: suppId, lines, totals });
            if (!validation.valid) {
                validation.errors.forEach(err => {
                    if (err.field === 'date') App.utils.markInvalid(document.getElementById('purchaseDate'), err.message);
                    if (err.field === 'party') App.utils.markInvalid(document.getElementById('purchaseSupplier'), err.message);
                    if (err.field.startsWith('line-')) {
                        const parts = err.field.split('-');
                        const idx = parseInt(parts[1], 10);
                        const rows = document.querySelectorAll('#purchaseLineItems tr');
                        const row = rows[idx];
                        if (row) {
                            const fieldKey = parts[2];
                            if (fieldKey === 'qty') App.utils.markInvalid(row.querySelector('.it-qty'), err.message);
                            if (fieldKey === 'rate') App.utils.markInvalid(row.querySelector('.it-rate'), err.message);
                            if (fieldKey === 'size') App.utils.markInvalid(row.querySelector('.it-size'), err.message);
                            if (fieldKey === 'stage') App.utils.markInvalid(row.querySelector('.it-stage'), err.message);
                            if (fieldKey === 'bags') App.utils.markInvalid(row.querySelector('.it-bags'), err.message);
                        }
                    }
                });
                App.ui.showToast(validation.errors[0].message, 'error');
                return;
            }

            try {
                await App.db.saveInvoice('purchase', invoice);
            } catch (error) {
                console.error('Error saving purchase invoice', error);
                App.ui.showToast(error.message || 'Unable to save purchase invoice', 'error');
                return;
            }

            try {
                if (isConnected) {
                    const allLedgers = await fbGetAll('ledgerEntries');
                    const existingLedgers = allLedgers.filter(l => l.reference_id === purId && l.reference_type === 'PURCHASE');
                    for (const led of existingLedgers) {
                        await fbDelete('ledgerEntries', led.id);
                    }
                }
                await safePush('ledgerEntries', {
                    date,
                    party_type: 'SUPPLIER',
                    party_id: suppId,
                    reference_type: 'PURCHASE',
                    reference_id: purId,
                    debit: 0,
                    credit: totals.grand,
                    note: `Purchase ${purId}`
                });
            } catch (err) {
                console.warn('Ledger update skipped for purchase', err);
            }

            let readyInventoryTouched = false;
            for (const line of lines) {
                const sizeId = line.size_id || line.sizeId;
                if (!sizeId) continue;
                let stock = null;
                try { stock = await fbGet('stockLevels', sizeId); } catch (err) { }
                if (!stock) stock = { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                const category = (line.category || '').toLowerCase();
                if (category === 'wire') {
                    stock.raw_wire_qty = (stock.raw_wire_qty || 0) + line.qty;
                } else if (category === 'ready screws') {
                    stock.finished_goods_qty = (stock.finished_goods_qty || 0) + line.qty;
                }
                await safePut('stockLevels', sizeId, stock);

                if (category === 'ready screws') {
                    const stageKey = typeof normalizeStageKey === 'function' ? normalizeStageKey(line.stage || 'Finished Goods') : (line.stage || 'Finished Goods');
                    const sizeKey = getInventorySizeKey(sizeId);
                    if (!appState.inventory[stageKey]) appState.inventory[stageKey] = {};
                    const bagsToAdd = line.bags_received && line.bags_received > 0 ? line.bags_received : Math.max(1, Math.ceil(line.qty || 0));
                    appState.inventory[stageKey][sizeKey] = (appState.inventory[stageKey][sizeKey] || 0) + bagsToAdd;
                    readyInventoryTouched = true;
                    recordActionLog('Inventory Adjusted', `Purchase invoice ${purId} updated stock for size ${sizeId}`, {
                        entityType: 'inventory',
                        purchaseId: purId,
                        supplierId: suppId,
                        sizeId: sizeId,
                        stage: category,
                        deltaQty: line.qty,
                        reason: 'purchase'
                    });
                }
            }
            if (readyInventoryTouched) {
                try { await fbPut('appState', 'appState', appState); } catch (err) { console.warn('Unable to persist inventory change', err); }
                if (typeof renderInventoryTab === 'function') renderInventoryTab();
            }

            const supplierName = App.utils.resolveName('supplier', suppId, 'Supplier');
            App.db.log({
                action: existingId ? 'purchase.invoice.update' : 'purchase.invoice.create',
                entityType: 'purchaseInvoice',
                entityId: purId,
                description: `${existingId ? 'Updated' : 'Created'} purchase ${purId} for ${supplierName}`,
                extra: { total: totals.grand, lines: lines.length }
            });

            clearPurchaseForm();
            App.ui.showToast(`Saved purchase ${purId}`, 'success');
        }

        function clearPurchaseForm() {
            document.getElementById('purchaseInvoiceForm').reset();
            document.getElementById('purchaseDate').value = getToday();
            document.getElementById('purchaseLineItems').innerHTML = '';
            document.getElementById('purchaseSupplierId').value = '';
            document.getElementById('purchaseInvoiceTax').value = '0';
            document.getElementById('purchaseSubtotal').textContent = '0';
            document.getElementById('purchaseTaxTotal').textContent = '0';
            document.getElementById('purchaseInvoiceTaxDisplay').textContent = '0';
            document.getElementById('purchaseGrandTotal').textContent = '0';
            document.getElementById('purchaseInvoiceIdEdit').value = '';
            addPurchaseLine();
        }

        async function viewPurchaseInvoice(purId) {
            try {
                const inv = await App.db.getInvoice('purchase', purId);
                if (!inv) {
                    App.ui.showToast('Invoice not found', 'error');
                    return;
                }
                await App.invoiceEngine.renderInvoiceModal(inv, 'purchase');
            } catch (error) {
                console.error('Error viewing purchase invoice:', error);
                App.ui.showToast('Error loading invoice: ' + error.message, 'error');
            }
        }

        async function editPurchaseInvoice(purId) {
            try {
                const inv = await App.db.getInvoice('purchase', purId);
                if (!inv) return;

                const supplierId = inv.partyId || '';
                const supplierName = getPartyNameDisplay('purchase', supplierId, inv.partyNameSnapshot || 'Supplier');

                document.getElementById('purchaseDate').value = inv.date;
                document.getElementById('purchaseSupplier').value = supplierName;
                document.getElementById('purchaseSupplierId').value = supplierId;
                document.getElementById('purchaseInvoiceTax').value = inv.invoice_tax || '0';
                document.getElementById('purchaseNotes').value = inv.notes || '';
                document.getElementById('purchaseLineItems').innerHTML = '';

                for (const line of inv.lines) {
                    const sizeId = line.size_id || line.sizeId || '';
                    const sizeName = getSizeLabel(sizeId, '');
                    await addPurchaseLine({
                        category: line.category,
                        description: line.description || '',
                        sizeName,
                        sizeId: sizeId,
                        unit: line.unit_type || 'KG',
                        qty: line.qty,
                        rate: line.rate_per_unit,
                        tax: line.tax_per_unit,
                        total: line.line_grand_total,
                        stage: line.stage || '',
                        receivedBags: line.bags_received || ''
                    });
                }
                document.getElementById('purchaseInvoiceIdEdit').value = purId;
                updatePurchaseTotals();
                switchPurchaseSubtab('purchase-create', document.querySelector('#purchase .subtab-btn'));
            } catch (error) {
                App.ui.reportIssue('Error editing purchase invoice', error, 'error');
            }
        }

        async function deletePurchaseInvoice(purId) {
            if (!App.hasPermission('deleteInvoices')) {
                App.ui.showToast('You do not have permission to delete invoices', 'error');
                return;
            }
            const inv = await App.db.getInvoice('purchase', purId);
            if (!inv) {
                App.ui.showToast('Invoice not found', 'error');
                return;
            }
            const supplierName = getPartyNameDisplay('purchase', inv.partyId, inv.partyNameSnapshot || 'Supplier');
            const totalDisplay = App.utils.formatCurrency(inv.invoice_grand_total || 0);
            if (!confirm(`Delete purchase ${purId} for ${supplierName}? Total ${totalDisplay}`)) return;
            let readyInventoryTouched = false;
            for (const line of inv.lines || []) {
                const sizeId = line.size_id || line.sizeId;
                if (line.category === 'Wire' && sizeId) {
                    const stock = await fbGet('stockLevels', sizeId).catch(() => null) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                    stock.raw_wire_qty = (parseFloat(stock.raw_wire_qty) || 0) - (line.qty || 0);
                    await safePut('stockLevels', sizeId, stock);
                } else if (line.category === 'Ready Screws' && sizeId) {
                    const stock = await fbGet('stockLevels', sizeId).catch(() => null) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                    stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) - (line.qty || 0);
                    await safePut('stockLevels', sizeId, stock);
                    const stageKey = typeof normalizeStageKey === 'function' ? normalizeStageKey(line.stage || 'Finished Goods') : (line.stage || 'Finished Goods');
                    const sizeKey = getInventorySizeKey(sizeId);
                    if (appState.inventory && appState.inventory[stageKey] && typeof appState.inventory[stageKey][sizeKey] !== 'undefined') {
                        const bagsToRemove = (line.bags_received && line.bags_received > 0) ? line.bags_received : Math.max(1, Math.ceil(line.qty || 0));
                        const current = parseFloat(appState.inventory[stageKey][sizeKey]) || 0;
                        const nextValue = Math.max(0, current - bagsToRemove);
                        if (nextValue <= 0) {
                            delete appState.inventory[stageKey][sizeKey];
                        } else {
                            appState.inventory[stageKey][sizeKey] = nextValue;
                        }
                        readyInventoryTouched = true;
                    }
                }
            }
            try {
                const ledgers = await fbGetAll('ledgerEntries');
                const ents = ledgers.filter(l => l.reference_id === purId && l.reference_type === 'PURCHASE');
                for (const ent of ents) {
                    await safeDelete('ledgerEntries', ent.id);
                }
            } catch (err) {
                App.ui.reportIssue('Unable to clean purchase ledger entries', err, 'warning');
            }
            await App.db.deleteInvoice('purchase', purId);
            if (readyInventoryTouched) {
                try { await fbPut('appState', 'appState', appState); } catch (err) { App.ui.reportIssue('Unable to persist inventory after delete', err, 'error'); }
                if (typeof renderInventoryTab === 'function') renderInventoryTab();
                if (typeof renderFinishedGoodsList === 'function') renderFinishedGoodsList();
            }

            // Log inventory rollback if applicable
            if (readyInventoryTouched) {
                recordActionLog('Inventory Rollback', `Rolled back inventory for deleted purchase invoice ${purId}`, {
                    entityType: 'inventory',
                    purchaseId: purId,
                    affectedSizes: 'Multiple' // Could be more specific if we tracked it
                });
            }

            recordActionLog('Purchase Invoice Deleted', `Deleted purchase invoice ${purId} for ${supplierName}`, {
                entityType: 'purchaseInvoice',
                purchaseId: purId,
                partyId: inv.partyId,
                grandTotal: inv.invoice_grand_total
            });
            App.ui.showToast('Purchase invoice deleted', 'success');
        }

        // ========== BULK ACTIONS FOR PURCHASE INVOICES ==========
        function toggleSelectAllPurchaseInvoices() {
            const selectAllCheckbox = document.getElementById('selectAllPurchaseInvoices');
            const checkboxes = document.querySelectorAll('#purchaseInvoiceTable .purchaseInvoiceCheckbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function applyBulkActionPurchaseInvoices() {
            const selectElement = document.getElementById('bulkActionPurchaseInvoices');
            const action = selectElement.value;

            if (!action) {
                alert('Please select a bulk action');
                return;
            }

            const checkboxes = document.querySelectorAll('#purchaseInvoiceTable .purchaseInvoiceCheckbox:checked');

            if (checkboxes.length === 0) {
                alert('Please select at least one invoice');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

            if (action === 'edit') {
                if (selectedIds.length > 1) {
                    alert('Please select only one invoice to edit');
                    return;
                }

                // Edit the first selected invoice
                editPurchaseInvoice(selectedIds[0]);
            } else if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected invoices?`)) {
                    return;
                }

                // Delete all selected invoices
                selectedIds.forEach(id => {
                    deletePurchaseInvoice(id);
                });

                // Reset the bulk action dropdown
                selectElement.value = '';

                // Uncheck select all checkbox
                document.getElementById('selectAllPurchaseInvoices').checked = false;
            }
        }

        // ========== MASTERS ==========
        function openAddCustomerModal() {
            document.getElementById('customerId').value = '';
            document.getElementById('customerForm').reset();
            openModal('customerModal');
        }

        async function saveCustomer(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('customerForm'));
            const name = (document.getElementById('customerName').value || '').trim();
            if (!name) {
                App.utils.markInvalid(document.getElementById('customerName'), 'Name required');
                App.ui.showToast('Customer name is required', 'error');
                return;
            }
            const id = document.getElementById('customerId').value || 'C_' + Date.now();
            const cust = { id, display_name: name };
            try {
                await App.db.saveMaster('customers', cust);
                const isNew = !document.getElementById('customerId').value;
                recordActionLog(isNew ? 'Customer Created' : 'Customer Updated', `${isNew ? 'Created' : 'Updated'} customer ${name}`, {
                    entityType: 'customer',
                    entityId: id,
                    name,
                    phone: cust.phone || ''
                });
                closeModal('customerModal');
                App.ui.showToast('Customer saved', 'success');
            } catch (err) {
                console.error('Error saving customer', err);
                App.ui.showToast(err.message || 'Unable to save customer', 'error');
            }
        }

        async function refreshCustomersTable() {
            try {
                const custs = (App.state.customers && App.state.customers.length) ? App.state.customers : await fbGetAll('customers');
                updateCaches(custs, 'customers');
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';
                custs.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${c.id}"></td>
                        <td>${c.display_name}</td>
                        <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editCustomer('${c.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteCustomer('${c.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                App.ui.reportIssue('Error refreshing customers', error, 'error');
            }
        }

        async function editCustomer(id) {
            const cust = await fbGet('customers', id);
            if (cust) {
                document.getElementById('customerId').value = id;
                document.getElementById('customerName').value = cust.display_name;
                openModal('customerModal');
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('Delete?')) return;
            try {
                await App.db.deleteMaster('customers', id);
                recordActionLog('Customer Deleted', `Deleted customer ${id}`, {
                    entityType: 'customer',
                    entityId: id,
                    name: id // Ideally we'd have the name, but id is fallback
                });
                App.ui.showToast('Customer deleted', 'success');
            } catch (err) {
                console.error('Error deleting customer', err);
                App.ui.showToast(err.message || 'Unable to delete customer', 'error');
            }
        }

        function openAddSupplierModal() {
            document.getElementById('supplierId').value = '';
            document.getElementById('supplierForm').reset();
            openModal('supplierModal');
        }

        async function saveSupplier(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('supplierForm'));
            const name = (document.getElementById('supplierName').value || '').trim();
            if (!name) {
                App.utils.markInvalid(document.getElementById('supplierName'), 'Name required');
                App.ui.showToast('Supplier name is required', 'error');
                return;
            }
            const id = document.getElementById('supplierId').value || 'S_' + Date.now();
            const supp = { id, supplier_name: name };
            try {
                await App.db.saveMaster('suppliers', supp);
                const isNew = !document.getElementById('supplierId').value;
                recordActionLog(isNew ? 'Supplier Created' : 'Supplier Updated', `${isNew ? 'Created' : 'Updated'} supplier ${name}`, {
                    entityType: 'supplier',
                    entityId: id,
                    name,
                    phone: supp.phone || ''
                });
                closeModal('supplierModal');
                App.ui.showToast('Supplier saved', 'success');
            } catch (err) {
                App.ui.reportIssue('Error saving supplier', err, 'error');
            }
        }

        async function refreshSuppliersTable() {
            try {
                const supps = (App.state.suppliers && App.state.suppliers.length) ? App.state.suppliers : await fbGetAll('suppliers');
                updateCaches(supps, 'suppliers');
                const tbody = document.querySelector('#suppliersTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';
                supps.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${s.id}"></td>
                        <td>${s.supplier_name}</td>
                        <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editSupplier('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteSupplier('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                App.ui.reportIssue('Error refreshing suppliers', error, 'error');
            }
        }

        async function editSupplier(id) {
            const supp = await fbGet('suppliers', id);
            if (supp) {
                document.getElementById('supplierId').value = id;
                document.getElementById('supplierName').value = supp.supplier_name;
                openModal('supplierModal');
            }
        }

        async function deleteSupplier(id) {
            if (!confirm('Delete?')) return;
            try {
                await App.db.deleteMaster('suppliers', id);
                recordActionLog('Supplier Deleted', `Deleted supplier ${id}`, {
                    entityType: 'supplier',
                    entityId: id,
                    name: id
                });
                App.ui.showToast('Supplier deleted', 'success');
            } catch (err) {
                console.error('Error deleting supplier', err);
                App.ui.showToast(err.message || 'Unable to delete supplier', 'error');
            }
        }

        function openAddSizeModal() {
            document.getElementById('sizeId').value = '';
            document.getElementById('sizeForm').reset();
            openModal('sizeModal');
        }

        async function saveSize(e) {
            e.preventDefault();
            App.utils.clearValidation(document.getElementById('sizeForm'));
            const name = (document.getElementById('sizeName').value || '').trim();
            const code = (document.getElementById('sizeCode').value || '').trim();
            if (!name || !code) {
                if (!code) App.utils.markInvalid(document.getElementById('sizeCode'), 'Code required');
                if (!name) App.utils.markInvalid(document.getElementById('sizeName'), 'Name required');
                App.ui.showToast('Size code and name are required', 'error');
                return;
            }
            const id = document.getElementById('sizeId').value || 'SZ_' + Date.now();
            const sz = {
                id,
                code,
                size_name: name,
                default_unit_type: document.getElementById('sizeUnitType').value,
                description: document.getElementById('sizeDesc').value,
                price_per_kg: parseFloat(document.getElementById('sizePriceKG').value) || 0,
                price_per_pkt: parseFloat(document.getElementById('sizePricePKT').value) || 0
            };
            try {
                await App.db.saveMaster('sizes', sz);
                const isNew = !document.getElementById('sizeId').value;
                recordActionLog(isNew ? 'Size Created' : 'Size Updated', `${isNew ? 'Created' : 'Updated'} size ${name}`, {
                    entityType: 'size',
                    entityId: id,
                    name,
                    code
                });
                closeModal('sizeModal');
                App.ui.showToast('Size saved', 'success');
            } catch (err) {
                App.ui.reportIssue('Error saving size', err, 'error');
            }
        }

        async function refreshSizesTable() {
            try {
                const sizes = (App.state.sizes && App.state.sizes.list) ? App.state.sizes.list : [];
                if (!sizes.length) await fbGetAll('sizes'); // Fallback if empty, though fetchCoreDataSnapshot should have handled it

                const tbody = document.querySelector('#sizesTable tbody');
                tbody.innerHTML = '';
                const masterDisabled = App.hasPermission('manageMasters') ? '' : 'disabled aria-disabled="true"';

                // Use the centralized list
                const list = (App.state.sizes && App.state.sizes.list) ? App.state.sizes.list : [];

                list.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${s.id}"></td>
                <td>${s.code || ''}</td>
                <td>${s.label}</td>
                <td>${s.remarks || ''}</td>
                <td>${s.type || ''}</td>
                <td>${(s.price_per_kg || 0).toFixed(2)}</td>
                <td>${(s.price_per_pkt || 0).toFixed(2)}</td>
                <td><div class="action-buttons"><button type="button" ${masterDisabled} onclick="editSize('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Edit</button><button type="button" class="danger" ${masterDisabled} onclick="deleteSize('${s.id}')" style="width:auto;padding:5px 10px;font-size:12px;">Delete</button></div></td>`;
                    tbody.appendChild(row);
                });
                updateSizeOptionsDatalist();
            } catch (error) {
                App.ui.reportIssue('Error refreshing sizes', error, 'error');
            }
        }
        async function editSize(id) {
            const sz = await fbGet('sizes', id);
            if (sz) {
                document.getElementById('sizeId').value = id;
                document.getElementById('sizeCode').value = sz.code;
                document.getElementById('sizeName').value = sz.size_name;
                document.getElementById('sizeUnitType').value = sz.default_unit_type || 'KG';
                document.getElementById('sizeDesc').value = sz.description || '';
                document.getElementById('sizePriceKG').value = sz.price_per_kg || '';
                document.getElementById('sizePricePKT').value = sz.price_per_pkt || '';
                openModal('sizeModal');
            }
        }

        async function deleteSize(id) {
            if (!confirm('Delete?')) return;
            try {

                await App.db.deleteMaster('sizes', id);
                recordActionLog('Size Deleted', `Deleted size ${id}`, {
                    entityType: 'size',
                    entityId: id,
                    name: id
                });
                App.ui.showToast('Size deleted', 'success');
            } catch (err) {
                console.error('Error deleting size', err);
                App.ui.showToast(err.message || 'Unable to delete size', 'error');
            }
        }

        // ========== BULK ACTIONS FOR MASTERS ==========
        function toggleSelectAll(type) {
            const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const checkboxes = document.querySelectorAll(`#${type}Table .rowCheckbox`);

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function applyBulkAction(type) {
            const selectElement = document.getElementById(`bulkAction${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const action = selectElement.value;

            if (!action) {
                alert('Please select a bulk action');
                return;
            }

            const checkboxes = document.querySelectorAll(`#${type}Table .rowCheckbox:checked`);

            if (checkboxes.length === 0) {
                alert('Please select at least one item');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.id);

            if (action === 'edit') {
                if (selectedIds.length > 1) {
                    alert('Please select only one item to edit');
                    return;
                }

                // Edit the first selected item
                if (type === 'customers') {
                    editCustomer(selectedIds[0]);
                } else if (type === 'suppliers') {
                    editSupplier(selectedIds[0]);
                } else if (type === 'sizes') {
                    editSize(selectedIds[0]);
                }
            } else if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected items?`)) {
                    return;
                }

                // Delete all selected items
                selectedIds.forEach(id => {
                    if (type === 'customers') {
                        deleteCustomer(id);
                    } else if (type === 'suppliers') {
                        deleteSupplier(id);
                    } else if (type === 'sizes') {
                        deleteSize(id);
                    }
                });

                // Reset the bulk action dropdown
                selectElement.value = '';

                // Uncheck select all checkbox
                document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked = false;
            }
        }

        // ========== IMPORT ==========
        function openImportModal(type) {
            document.getElementById('importType').value = type;
            document.getElementById('importModalTitle').textContent = `Import ${type}`;
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importFile').value = '';
            openModal('importModal');
        }

        async function previewExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const lines = evt.target.result.split('\n');
                    const header = lines[0].split(',').map(s => s.trim().replace(/"/g, ''));
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const vals = lines[i].split(',').map(s => s.trim().replace(/"/g, ''));
                            const row = {};
                            header.forEach((h, idx) => row[h] = vals[idx] || '');
                            data.push(row);
                        }
                    }
                    window.importedData = data;
                    window.importedColumns = header;
                    showColumnMappingUI();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function getImportFields(type) {
            switch (type) {
                case 'customers':
                    return ['display_name'];
                case 'suppliers':
                    return ['supplier_name'];
                case 'machines':
                    return ['machine_type', 'display_name', 'status', 'current_size'];
                default:
                    return ['code', 'size_name', 'description', 'price_per_kg', 'price_per_pkt'];
            }
        }

        function showColumnMappingUI() {
            const type = document.getElementById('importType').value;
            const fields = getImportFields(type);

            const ui = document.getElementById('columnMappingUI');
            ui.innerHTML = '';
            fields.forEach(f => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                const label = document.createElement('label');
                label.textContent = f + ': ';
                const sel = document.createElement('select');
                sel.id = 'map_' + f;
                sel.innerHTML = '<option value="">-- Select --</option>';
                window.importedColumns.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    sel.appendChild(opt);
                });
                div.appendChild(label);
                div.appendChild(sel);
                ui.appendChild(div);
            });

            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
        }

        async function confirmImport() {
            if (!isConnected) {
                alert("No internet connection. Cannot import data.");
                return;
            }

            const type = document.getElementById('importType').value;
            const fields = getImportFields(type);

            const mapping = {};
            fields.forEach(f => { mapping[f] = document.getElementById('map_' + f).value; });

            let cnt = 0;
            for (const row of window.importedData) {
                const rec = { id: 'ID_' + Date.now() + '_' + cnt };
                for (const f in mapping) {
                    if (mapping[f]) rec[f] = row[mapping[f]];
                }
                if (type === 'machines') {
                    rec.machine_type = rec.machine_type || 'Other';
                    rec.display_name = rec.display_name || `Machine ${cnt + 1}`;
                    rec.status = rec.status || 'Idle';
                    rec.current_size = rec.current_size || '';
                }
                await fbInsert(type, rec);
                cnt++;
            }

            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'block';
            document.getElementById('importMessage').textContent = ' Imported ' + cnt + ' records.';
        }

        function cancelImport() {
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep1').style.display = 'block';
        }


        // ===== PATCH: Extended Invoice & Bank Import (non-destructive) =====
        (function () {
            function parseNum(v) { const n = parseFloat(String(v || '').replace(/[^0-9.\-]/g, '')); return isNaN(n) ? 0 : n; }

            async function getOrCreateCustomerByName(nameRaw) {
                const name = (nameRaw || '').trim();
                const customers = await fbGetAll('customers');
                const found = customers.find(c => (c.display_name || '').toLowerCase() === name.toLowerCase());
                if (found) return found.id;
                const id = 'C_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                await fbPut('customers', id, { id, display_name: name || ('UNKNOWN CUSTOMER ' + id.slice(-4)) });
                return id;
            }
            async function getOrCreateSupplierByName(nameRaw) {
                const name = (nameRaw || '').trim();
                const suppliers = await fbGetAll('suppliers');
                const found = suppliers.find(s => (s.supplier_name || '').toLowerCase() === name.toLowerCase());
                if (found) return found.id;
                const id = 'S_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                await fbPut('suppliers', id, { id, supplier_name: name || ('UNKNOWN SUPPLIER ' + id.slice(-4)) });
                return id;
            }
            async function findSizeIdByName(sizeNameRaw) {
                const nm = (sizeNameRaw || '').trim();
                if (!nm) return null;
                const sizes = await fbGetAll('sizes');
                const hit = sizes.find(s => (s.size_name || '').toLowerCase() === nm.toLowerCase());
                return hit ? hit.id : null;
            }
            function nextRef(prefix, date) {
                const ymd = (date || getToday()).replace(/-/g, '');
                return fbGetAll(prefix === 'S' ? 'salesInvoices' : 'purchaseInvoices').then(all => {
                    all = all.map(v => normalizeInvoice(v, prefix === 'S' ? 'sales' : 'purchase', v.id));
                    const cnt = all.filter(x => (prefix === 'S' ? (x.invoice_id || '') : (x.purchase_id || '')).includes(ymd)).length;
                    return `${prefix}-${ymd}-${String(cnt + 1).padStart(3, '0')}`;
                });
            }

            // Override column mapping to include our new types while preserving old ones
            const _orig_showMap = showColumnMappingUI;
            showColumnMappingUI = function () {
                const type = document.getElementById('importType').value;
                let fields;
                if (type === 'salesImport') {
                    fields = ['date', 'customer_name', 'size_name', 'unit_type', 'qty', 'rate', 'discount_pct', 'line_tax', 'notes'];
                } else if (type === 'purchaseImport') {
                    fields = ['date', 'supplier_name', 'category', 'description', 'size_name', 'unit_type', 'qty', 'rate', 'line_tax', 'invoice_tax', 'notes'];
                } else if (type === 'bankLedger') {
                    fields = ['date', 'party_name', 'debit', 'credit', 'note'];
                } else {
                    return _orig_showMap();
                }
                const ui = document.getElementById('columnMappingUI');
                ui.innerHTML = '';
                fields.forEach(f => {
                    const row = document.createElement('div');
                    row.style.marginBottom = '10px';
                    row.innerHTML = `<label>${f}: </label><select id="map_${f}"><option value="">-- Select --</option>${(window.importedColumns || []).map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
                    ui.appendChild(row);
                });
                document.getElementById('importStep1').style.display = 'none';
                document.getElementById('importStep2').style.display = 'block';
            };

            // Route confirmImport for new types (fallback to original for others)
            const _orig_confirm = confirmImport;
            confirmImport = async function () {
                const type = document.getElementById('importType').value;
                const mapVal = (k) => { const el = document.getElementById('map_' + k); return el ? el.value : ''; };
                if (type === 'salesImport' || type === 'purchaseImport' || type === 'bankLedger') {
                    const rows = window.importedData || [];
                    try {
                        if (type === 'salesImport') {
                            // Build and save minimal 1-line invoices per row
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const customer = r[mapVal('customer_name')] || '';
                                const sizeName = r[mapVal('size_name')] || '';
                                const unit = (r[mapVal('unit_type')] || 'PKT').toUpperCase();
                                const qty = parseNum(r[mapVal('qty')]);
                                const rate = parseNum(r[mapVal('rate')]);
                                const disc = parseNum(r[mapVal('discount_pct')]);
                                const perTax = parseNum(r[mapVal('line_tax')]);
                                const notes = r[mapVal('notes')] || '';

                                const custId = await getOrCreateCustomerByName(customer);
                                const sizeId = await findSizeIdByName(sizeName);

                                const rawLine = {
                                    line_id: 1,
                                    category: 'Sale',
                                    description: sizeName || 'Imported',
                                    size_id: sizeId || null,
                                    unit_type: unit,
                                    qty,
                                    rate_per_unit: rate,
                                    discount_pct: disc,
                                    tax_per_unit: perTax
                                };
                                const totals = App.invoiceEngine.calculateTotals('sales', [rawLine]);

                                const invId = await nextRef('S', date);
                                const custRecord = getCustomerById(custId);
                                const invoice = {
                                    invoice_id: invId,
                                    date,
                                    partyId: custId,
                                    partyNameSnapshot: custRecord ? custRecord.name : customer,
                                    partyGstSnapshot: custRecord ? custRecord.gstNumber : '',
                                    customer_id: custId,
                                    lines: totals.lines,
                                    invoice_subtotal: totals.subtotal,
                                    invoice_line_tax_total: totals.lineTax,
                                    invoice_tax: totals.invoiceTax,
                                    invoice_grand_total: totals.grand,
                                    notes
                                };
                                await fbPut('salesInvoices', invId, invoice);
                                await fbInsert('ledgerEntries', { date, party_type: 'CUSTOMER', party_id: custId, reference_type: 'SALE', reference_id: invId, debit: totals.grand, credit: 0, note: `Sale ${invId}` });
                                if (sizeId && unit === 'PKT') {
                                    let stock = await fbGet('stockLevels', sizeId) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                                    stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) - qty;
                                    await fbPut('stockLevels', sizeId, stock);
                                }
                            }
                        } else if (type === 'purchaseImport') {
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const supplier = r[mapVal('supplier_name')] || '';
                                const category = r[mapVal('category')] || 'P E';
                                const desc = r[mapVal('description')] || 'Imported';
                                const sizeName = r[mapVal('size_name')] || '';
                                const unit = (r[mapVal('unit_type')] || 'KG').toUpperCase();
                                const qty = parseNum(r[mapVal('qty')]);
                                const rate = parseNum(r[mapVal('rate')]);
                                const perTax = parseNum(r[mapVal('line_tax')]);
                                const invTax = parseNum(r[mapVal('invoice_tax')]);
                                const notes = r[mapVal('notes')] || '';

                                const suppId = await getOrCreateSupplierByName(supplier);
                                const sizeId = await findSizeIdByName(sizeName);

                                const rawLine = {
                                    line_id: 1,
                                    category,
                                    description: desc,
                                    size_id: sizeId || null,
                                    unit_type: unit,
                                    qty,
                                    rate_per_unit: rate,
                                    tax_per_unit: perTax
                                };
                                const totals = App.invoiceEngine.calculateTotals('purchase', [rawLine], invTax);

                                const purId = await nextRef('P', date);
                                const suppRecord = getSupplierById(suppId);
                                const invoice = {
                                    purchase_id: purId,
                                    date,
                                    partyId: suppId,
                                    partyNameSnapshot: suppRecord ? suppRecord.name : supplier,
                                    partyGstSnapshot: suppRecord ? suppRecord.gstNumber : '',
                                    supplier_id: suppId,
                                    lines: totals.lines,
                                    invoice_subtotal: totals.subtotal,
                                    invoice_line_tax_total: totals.lineTax,
                                    invoice_tax: totals.invoiceTax,
                                    invoice_grand_total: totals.grand,
                                    notes
                                };
                                await fbPut('purchaseInvoices', purId, invoice);
                                await fbInsert('ledgerEntries', { date, party_type: 'SUPPLIER', party_id: suppId, reference_type: 'PURCHASE', reference_id: purId, debit: 0, credit: totals.grand, note: `Purchase ${purId}` });

                                if (sizeId) {
                                    let stock = await fbGet('stockLevels', sizeId) || { size_id: sizeId, raw_wire_qty: 0, finished_goods_qty: 0 };
                                    if (category === 'Wire') { stock.raw_wire_qty = (parseFloat(stock.raw_wire_qty) || 0) + qty; }
                                    if (category === 'Ready Screws') { stock.finished_goods_qty = (parseFloat(stock.finished_goods_qty) || 0) + qty; }
                                    await fbPut('stockLevels', sizeId, stock);
                                }
                            }
                        } else if (type === 'bankLedger') {
                            const all = await fbGetAll('ledgerEntries');
                            const datePrefix = getToday().replace(/-/g, '');
                            let cnt = all.filter(x => (x.reference_id || '').includes(`L-${datePrefix}-`)).length;
                            for (const r of rows) {
                                const date = r[mapVal('date')] || getToday();
                                const name = r[mapVal('party_name')] || '';
                                const debit = parseNum(r[mapVal('debit')]);
                                const credit = parseNum(r[mapVal('credit')]);
                                const note = r[mapVal('note')] || 'Imported bank entry';
                                const ref = `L-${(date || getToday()).replace(/-/g, '')}-${String(++cnt).padStart(3, '0')}`;
                                if (credit > 0) {
                                    const custId = await getOrCreateCustomerByName(name);
                                    await fbInsert('ledgerEntries', { date, party_type: 'CUSTOMER', party_id: custId, reference_type: 'RECEIPT', reference_id: ref, debit: 0, credit: credit, note });
                                } else if (debit > 0) {
                                    const suppId = await getOrCreateSupplierByName(name);
                                    await fbInsert('ledgerEntries', { date, party_type: 'SUPPLIER', party_id: suppId, reference_type: 'PAYMENT', reference_id: ref, debit: debit, credit: 0, note });
                                }
                            }
                        }
                        // Show success
                        document.getElementById('importStep2').style.display = 'none';
                        const s3 = document.getElementById('importStep3'); if (s3) s3.style.display = 'block';
                        alert('Import completed.');
                    } catch (e) { console.error(e); alert('Import failed: ' + e.message); }
                } else {
                    return _orig_confirm();
                }
            };
        })();
        // ===== END PATCH =====

        // ========== REPORTS ==========
        async function generateSizewiseReport() {
            try {
                const fromDate = document.getElementById('reportSizeFromDate').value;
                const toDate = document.getElementById('reportSizeToDate').value;
                const sales = await App.db.listInvoices('sales');

                const agg = {};
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const normalizedLines = App.invoiceEngine.normalizeLines('sales', inv.lines);
                    for (const line of normalizedLines) {
                        const sizeId = resolveSizeIdFromAny(line);
                        if (!sizeId) continue;
                        if (!agg[sizeId]) agg[sizeId] = { size_name: getSizeLabel(sizeId), total_kg: 0, total_pkt: 0, total_value: 0 };
                        if (line.unit_type === 'KG') agg[sizeId].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[sizeId].total_pkt += line.qty;
                        agg[sizeId].total_value += line.line_grand_total;
                    }
                }

                const tbody = document.querySelector('#sizewiseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].size_name}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating size-wise report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateSizewisePurchaseReport() {
            try {
                const fromDate = document.getElementById('reportSizePurchaseFromDate').value;
                const toDate = document.getElementById('reportSizePurchaseToDate').value;
                const purchases = await App.db.listInvoices('purchase');

                const agg = {};
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    for (const line of normalizedLines) {
                        const sizeId = resolveSizeIdFromAny(line);
                        if (!sizeId) continue;
                        if (!agg[sizeId]) agg[sizeId] = { size_name: getSizeLabel(sizeId), total_kg: 0, total_pkt: 0, total_value: 0 };
                        if (line.unit_type === 'KG') agg[sizeId].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[sizeId].total_pkt += line.qty;
                        agg[sizeId].total_value += line.line_grand_total;
                    }
                }

                const tbody = document.querySelector('#sizewisePurchaseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].size_name}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating size-wise purchase report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateCustomerwiseReport() {
            try {
                const fromDate = document.getElementById('reportCustFromDate').value;
                const toDate = document.getElementById('reportCustToDate').value;
                const filter = document.getElementById('reportCustFilter').value.toLowerCase();
                const sales = await App.db.listInvoices('sales');
                const sizes = await fbGetAll('sizes');

                const sizeMap = {};
                sizes.forEach(s => { sizeMap[s.id] = s; });

                const agg = {};
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const custName = getPartyNameDisplay('sales', inv.partyId, inv.partyNameSnapshot || inv.customer_name || 'Unknown');
                    if (filter && !custName.toLowerCase().includes(filter)) continue;
                    const key = inv.partyId || 'UNKNOWN';
                    if (!agg[key]) agg[key] = { customer_name: custName, total_value: 0, total_kg: 0, total_pkt: 0, sizes: {} };

                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    agg[key].total_value += totals.grand;

                    const normalizedLines = App.invoiceEngine.normalizeLines('sales', inv.lines);
                    for (const line of normalizedLines) {
                        if (!line.size_id) continue;
                        const size = sizeMap[line.size_id];
                        if (!size) continue;
                        if (line.unit_type === 'KG') agg[key].total_kg += line.qty;
                        else if (line.unit_type === 'PKT') agg[key].total_pkt += line.qty;
                        if (!agg[key].sizes[size.size_name]) agg[key].sizes[size.size_name] = 0;
                        agg[key].sizes[size.size_name] += line.qty;
                    }
                }

                const tbody = document.querySelector('#customerwiseTable tbody');
                tbody.innerHTML = '';
                for (const key in agg) {
                    const topSizes = Object.entries(agg[key].sizes).sort((a, b) => b[1] - a[1]).slice(0, 3).map(s => s[0]).join(', ');
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${agg[key].customer_name}</td><td class="currency">${agg[key].total_value.toFixed(2)}</td><td>${agg[key].total_kg.toFixed(2)}</td><td>${agg[key].total_pkt.toFixed(2)}</td><td>${topSizes}</td>`;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error("Error generating customer-wise report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateElaborateReport() {
            try {
                const fromDate = document.getElementById('reportElaborateFromDate').value;
                const toDate = document.getElementById('reportElaborateToDate').value;

                const [purchases, stockLevels] = await Promise.all([
                    App.db.listInvoices('purchase'),
                    fbGetAll('stockLevels')
                ]);

                let productionHistory = Array.isArray(appState.productionHistory) ? [...appState.productionHistory] : [];
                if (!productionHistory.length && isConnected) {
                    try {
                        const persisted = await fbGet('appState', 'appState');
                        if (persisted?.productionHistory?.length) {
                            productionHistory = persisted.productionHistory;
                        }
                    } catch (err) {
                        console.warn('Unable to fetch production history from Firebase', err);
                    }
                }

                // Factory production aggregation
                const factoryAgg = {};
                productionHistory.forEach(entry => {
                    const ts = entry?.timestamp || entry?.time || null;
                    if (!isDateWithinRange(ts, fromDate, toDate)) return;
                    const sizeId = resolveSizeIdFromAny({ sizeId: entry.size || entry.size_id || entry.sizeId || entry.size_name }, entry.size || entry.size_name);
                    if (!sizeId) return;
                    if (!factoryAgg[sizeId]) {
                        factoryAgg[sizeId] = {
                            sizeName: getSizeLabel(sizeId),
                            totalBags: 0,
                            machines: new Set(),
                            stages: new Set(),
                            lastTimestamp: null
                        };
                    }
                    factoryAgg[sizeId].totalBags += Number(entry.bags) || 0;
                    if (entry.machineName) factoryAgg[sizeId].machines.add(entry.machineName);
                    if (entry.stage) factoryAgg[sizeId].stages.add(entry.stage);
                    const parsedTs = parseAnyTimestamp(ts);
                    if (parsedTs && (!factoryAgg[sizeId].lastTimestamp || parsedTs > factoryAgg[sizeId].lastTimestamp)) {
                        factoryAgg[sizeId].lastTimestamp = parsedTs;
                    }
                });

                const factoryBody = document.querySelector('#elaborateFactoryTable tbody');
                factoryBody.innerHTML = '';
                const factoryEntries = Object.values(factoryAgg);
                if (!factoryEntries.length) {
                    factoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6b7280;">No production entries for this range</td></tr>';
                } else {
                    factoryEntries
                        .sort((a, b) => b.totalBags - a.totalBags)
                        .forEach(entry => {
                            const machines = Array.from(entry.machines).join(', ') || '-';
                            const stages = Array.from(entry.stages).join(', ') || '-';
                            const last = entry.lastTimestamp ? entry.lastTimestamp.toLocaleString() : '-';
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${entry.sizeName}</td><td>${entry.totalBags.toFixed(2)}</td><td>${stages}</td><td>${machines}</td><td>${last}</td>`;
                            factoryBody.appendChild(row);
                        });
                }

                // Purchase aggregation
                const purchaseAgg = {};
                purchases.forEach(inv => {
                    if (!isDateWithinRange(inv.date, fromDate, toDate)) return;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    normalizedLines.forEach(line => {
                        const sizeId = resolveSizeIdFromAny(line);
                        if (!sizeId) return;
                        if (!purchaseAgg[sizeId]) {
                            purchaseAgg[sizeId] = {
                                sizeName: getSizeLabel(sizeId),
                                total_kg: 0,
                                total_pkt: 0,
                                total_value: 0,
                                suppliers: new Set()
                            };
                        }
                        if ((line.unit_type || '').toUpperCase() === 'KG') purchaseAgg[sizeId].total_kg += line.qty || 0;
                        else purchaseAgg[sizeId].total_pkt += line.qty || 0;
                        purchaseAgg[sizeId].total_value += line.line_grand_total || 0;
                        const partyId = inv.partyId || inv.supplier_id;
                        if (partyId) {
                            const suppName = getPartyNameDisplay('purchase', partyId, 'Supplier');
                            purchaseAgg[sizeId].suppliers.add(suppName);
                        }
                    });
                });

                const purchaseBody = document.querySelector('#elaboratePurchaseTable tbody');
                purchaseBody.innerHTML = '';
                const purchaseEntries = Object.values(purchaseAgg);
                if (!purchaseEntries.length) {
                    purchaseBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#6b7280;">No purchase entries for this range</td></tr>';
                } else {
                    purchaseEntries
                        .sort((a, b) => b.total_value - a.total_value)
                        .forEach(entry => {
                            const supplierNames = Array.from(entry.suppliers).join(', ') || '-';
                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${entry.sizeName}</td><td>${entry.total_kg.toFixed(2)}</td><td>${entry.total_pkt.toFixed(2)}</td><td class="currency">${entry.total_value.toFixed(2)}</td><td>${supplierNames}</td>`;
                            purchaseBody.appendChild(row);
                        });
                }

                // Stock snapshot
                const stockBody = document.querySelector('#elaborateStockTable tbody');
                stockBody.innerHTML = '';
                if (!stockLevels.length) {
                    stockBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#6b7280;">No stock data available</td></tr>';
                } else {
                    stockLevels.forEach(stock => {
                        const sizeKey = getInventorySizeKey(stock.size_id || stock.id || '');
                        const sizeName = getSizeLabel(sizeKey) || sizeMap[sizeKey]?.size_name || stock.size_id || 'Unknown Size';
                        const lastUpdated = stock.updated_at ? (parseAnyTimestamp(stock.updated_at)?.toLocaleString() || '-') : '-';
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${sizeName}</td><td>${(stock.raw_wire_qty || 0).toFixed(2)}</td><td>${(stock.finished_goods_qty || 0).toFixed(2)}</td><td>${lastUpdated}</td>`;
                        stockBody.appendChild(row);
                    });
                }

                recordActionLog('Elaborate Report', `Generated elaborate stock flow report`, { fromDate, toDate, productionSizes: factoryEntries.length, purchaseSizes: purchaseEntries.length });
            } catch (error) {
                console.error('Error generating elaborate report:', error);
                alert('Error building elaborate report: ' + error.message);
            }
        }

        async function fetchActivityLogs(limit = 300) {
            if (!isConnected || typeof database === 'undefined') {
                return (appState.activityLogs || []).slice(0, limit);
            }
            const snapshot = await database.ref('activityLogs').orderByChild('timestamp').limitToLast(limit).once('value');
            const logs = [];
            snapshot.forEach(child => {
                logs.push({
                    id: child.key,
                    ...(child.val() || {})
                });
            });
            return logs.sort((a, b) => {
                const aTime = parseAnyTimestamp(a.timestamp)?.getTime() || 0;
                const bTime = parseAnyTimestamp(b.timestamp)?.getTime() || 0;
                return bTime - aTime;
            });
        }

        async function generateActivityLogs(forceReload = false) {
            try {
                if (!activityLogsCache.length || forceReload) {
                    let fetchedLogs = [];
                    try {
                        fetchedLogs = await fetchActivityLogs(400);
                    } catch (err) {
                        console.warn('Unable to fetch logs from server', err);
                    }
                    const localLogs = Array.isArray(appState.activityLogs) ? appState.activityLogs.slice(0, 500) : [];
                    const combined = [...fetchedLogs, ...localLogs];
                    const seen = new Set();
                    activityLogsCache = combined.filter(log => {
                        if (!log || !log.id) return false;
                        if (seen.has(log.id)) return false;
                        seen.add(log.id);
                        return true;
                    }).sort((a, b) => {
                        const aTime = parseAnyTimestamp(a.timestamp)?.getTime() || 0;
                        const bTime = parseAnyTimestamp(b.timestamp)?.getTime() || 0;
                        return bTime - aTime;
                    }).slice(0, 500);
                    appState.activityLogs = activityLogsCache.slice(0, 500);
                }
                const fromDate = document.getElementById('logsFromDate')?.value;
                const toDate = document.getElementById('logsToDate')?.value;
                const searchValue = (document.getElementById('logsSearch')?.value || '').toLowerCase();

                const hideNav = document.getElementById('logsHideNavigation')?.checked;
                const navActions = new Set(['Main Tab Switch', 'Report Tab Switch']);
                const filtered = activityLogsCache.filter((log) => {
                    const inRange = isDateWithinRange(log.timestamp, fromDate, toDate);
                    if (!inRange) return false;
                    if (hideNav && navActions.has(log.action)) return false;
                    if (!searchValue) return true;
                    const haystack = [
                        log.user,
                        log.role,
                        log.action,
                        log.description,
                        JSON.stringify(log.details || {})
                    ].join(' ').toLowerCase();
                    return haystack.includes(searchValue);
                });

                const tbody = document.querySelector('#activityLogsTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!filtered.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No log entries for this selection</td></tr>';
                    return;
                }
                filtered.slice(0, 400).forEach((log, index) => {
                    const ts = parseAnyTimestamp(log.timestamp);

                    // Format details nicely
                    let detailsHtml = '';
                    if (log.details && typeof log.details === 'object' && Object.keys(log.details).length > 0) {
                        const entries = Object.entries(log.details)
                            .filter(([k, v]) => k !== 'entityType' && k !== 'entityId' && k !== 'userId' && k !== 'role') // Hide redundant fields
                            .map(([k, v]) => `<span style="display:inline-block; margin-right:8px; background:rgba(0,0,0,0.03); padding:2px 6px; border-radius:4px;"><strong>${k}:</strong> ${v}</span>`)
                            .join('');
                        if (entries) detailsHtml = `<div style="margin-top:4px; font-size:0.85em; color:#555;">${entries}</div>`;
                    } else if (log.extra && typeof log.extra === 'object') {
                        // Fallback for old logs
                        detailsHtml = `<div style="margin-top:4px; font-size:0.85em; color:#555;">${JSON.stringify(log.extra)}</div>`;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${index + 1}</td><td>${ts ? ts.toLocaleString() : '-'}</td><td>${log.user || '-'}</td><td>${log.role || '-'}</td><td>${log.action || '-'}</td><td>${log.description || ''}${detailsHtml}</td>`;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading logs:', error);
                alert('Unable to load logs: ' + error.message);
            }
        }

        // ========== P&L REPORTS WITH UPDATED CALCULATIONS ==========
        async function generatePLReport() {
            try {
                const fromDate = document.getElementById('reportPLFromDate').value;
                const toDate = document.getElementById('reportPLToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSales = 0;
                let totalPurchases = 0;

                sales.forEach(inv => {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) return;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSales += totals.grand;
                });

                purchases.forEach(inv => {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) return;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    normalizedLines.forEach(line => {
                        if ((line.category || '').trim() === 'P E') return;
                        totalPurchases += Number(line.line_grand_total || 0);
                    });
                });

                const net = totalSales - totalPurchases;

                const tbody = document.querySelector('#plTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Including All Taxes)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Excluding P E Category)</td><td style="text-align: right;" class="currency">${totalPurchases.toFixed(2)}</td></tr>
                `;
                document.getElementById('plNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        async function generatePLTaxReport() {
            try {
                const fromDate = document.getElementById('reportPLTaxFromDate').value;
                const toDate = document.getElementById('reportPLTaxToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSales = 0;
                let totalPurchases = 0;

                // Total Sales (excluding all taxes)
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSales += totals.subtotal;
                }

                // Total Purchases (excluding all taxes) excluding P E category
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    for (const line of normalizedLines) {
                        // Exclude P E category
                        if (line.category !== 'P E') {
                            totalPurchases += Number(line.line_total_before_tax || 0);
                        }
                    }
                }

                const net = totalSales - totalPurchases;

                const tbody = document.querySelector('#plTaxTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Excluding All Taxes)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Excluding P E Category & Taxes)</td><td style="text-align: right;" class="currency">${totalPurchases.toFixed(2)}</td></tr>
                `;
                document.getElementById('plTaxNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L tax report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== GST CALCULATION ==========
        async function generateGSTReport() {
            try {
                const fromDate = document.getElementById('reportGSTFromDate').value || document.getElementById('reportPLFromDate').value;
                const toDate = document.getElementById('reportGSTToDate').value || document.getElementById('reportPLToDate').value;
                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSalesLineTax = 0;
                let totalPurchaseLineTax = 0;

                // Total Sales (only line tax)
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSalesLineTax += Number(totals.lineTax || 0);
                }

                // Total Purchases (only line tax) excluding P E category
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    normalizedLines.forEach(line => {
                        if ((line.category || '').trim() === 'P E') return;
                        totalPurchaseLineTax += Number(line.line_tax_total || 0);
                    });
                }

                const netGST = totalSalesLineTax - totalPurchaseLineTax;

                const tbody = document.querySelector('#gstTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales Line Tax</td><td style="text-align: right;" class="currency">${totalSalesLineTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Line Tax (Excluding P E)</td><td style="text-align: right;" class="currency">${totalPurchaseLineTax.toFixed(2)}</td></tr>
                `;
                document.getElementById('gstNetResult').textContent = `${netGST.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating GST report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== CATEGORY-WISE PURCHASE FILTER ==========
        async function filterPurchaseByCategory() {
            App.invoiceEngine.renderInvoiceTable('purchase');
        }

        /**
         * Override Actual Cost vs Tax P&L to EXCLUDE "P E" purchase lines
         * - Sums sales as before (actual + tax)
         * - For purchases, sums only non-PE lines split into actual (before tax) and tax
         */
        async function generatePLTaxReport() {
            try {
                const fromDate = document.getElementById('reportPLTaxFromDate').value;
                const toDate = document.getElementById('reportPLTaxToDate').value;
                const sales = await App.db.listInvoices('sales');
                const purchases = await App.db.listInvoices('purchase');

                let totalSales = 0, totalSalesTax = 0;
                let totalPurchase = 0, totalPurchaseTax = 0;

                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const lineTax = Number(inv.invoice_line_tax_total || 0);
                    const invTax = Number(inv.invoice_tax || 0);
                    const grand = Number(inv.invoice_grand_total || 0);
                    totalSalesTax += (lineTax + invTax);
                    totalSales += (grand - (lineTax + invTax));
                }

                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const normalizedLines = App.invoiceEngine.normalizeLines('purchase', inv.lines);
                    for (const line of normalizedLines) {
                        const cat = (line.category || '').trim();
                        if (cat === 'P E') continue;
                        totalPurchase += Number(line.line_total_before_tax || 0);
                        totalPurchaseTax += Number(line.line_tax_total || 0);
                    }
                }

                const net = (totalSales - totalPurchase);

                const tbody = document.querySelector('#plTaxTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales (Actual Cost)</td><td style="text-align: right;" class="currency">${totalSales.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Taxes</td><td style="text-align: right;" class="currency">${totalSalesTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchases (Actual Cost, Excl. P E)</td><td style="text-align: right;" class="currency">${totalPurchase.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Taxes (Excl. P E)</td><td style="text-align: right;" class="currency">${totalPurchaseTax.toFixed(2)}</td></tr>
                `;
                document.getElementById('plTaxNetResult').textContent = `${net.toFixed(2)}`;
            } catch (error) {
                console.error("Error generating P&L tax report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== MASTERS REPORT ==========
        async function generateMastersReport() {
            try {
                const fromDate = document.getElementById('reportMastersFromDate').value;
                const toDate = document.getElementById('reportMastersToDate').value;

                const sales = await getReportInvoices('sales');
                const purchases = await getReportInvoices('purchase');

                let totalSaleAmount = 0;      // qty * rate - disc (excluding line tax) for sales
                let totalPurchaseAmount = 0;  // qty * rate - disc (excluding line tax) for purchases
                let totalSalesInvoiceTax = 0;
                let totalPurchaseInvoiceTax = 0;
                let totalSalesLineTax = 0;
                let totalPurchaseLineTax = 0;

                // Process sales invoices
                for (const inv of sales) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'sales');
                    totalSaleAmount += totals.subtotal;
                    totalSalesLineTax += totals.lineTax;
                    totalSalesInvoiceTax += totals.invoiceTax;
                }

                // Process purchase invoices
                for (const inv of purchases) {
                    if ((fromDate && inv.date < fromDate) || (toDate && inv.date > toDate)) continue;
                    const totals = computeInvoiceTotalsForReport(inv, 'purchase');
                    totalPurchaseAmount += totals.subtotal;
                    totalPurchaseLineTax += totals.lineTax;
                    totalPurchaseInvoiceTax += totals.invoiceTax;
                }

                const tbody = document.querySelector('#mastersTable tbody');
                tbody.innerHTML = `
                    <tr><td>Total Sales Amount (Excl. Line Tax)</td><td style="text-align: right;" class="currency">${totalSaleAmount.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Amount (Excl. Line Tax)</td><td style="text-align: right;" class="currency">${totalPurchaseAmount.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Invoice Tax</td><td style="text-align: right;" class="currency">${totalSalesInvoiceTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Invoice Tax</td><td style="text-align: right;" class="currency">${totalPurchaseInvoiceTax.toFixed(2)}</td></tr>
                    <tr><td>Total Sales Line Tax</td><td style="text-align: right;" class="currency">${totalSalesLineTax.toFixed(2)}</td></tr>
                    <tr><td>Total Purchase Line Tax</td><td style="text-align: right;" class="currency">${totalPurchaseLineTax.toFixed(2)}</td></tr>
                `;
            } catch (error) {
                console.error("Error generating masters report:", error);
                alert('Error generating report: ' + error.message);
            }
        }

        // ========== INVENTORY SEARCH ==========
        document.getElementById('inventorySearchInput').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const table = document.getElementById('inventoryTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let match = false;

                // Check each cell in the row for the search term
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        match = true;
                        break;
                    }
                }

                // Show or hide the row based on match
                row.style.display = match ? '' : 'none';
            }
        });

        function clearInventorySearch() {
            document.getElementById('inventorySearchInput').value = '';
            const table = document.getElementById('inventoryTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                row.style.display = '';
            }
        }

        // Auto-associate labels that are not wired to any form control
        function autoAssociateLabels() {
            const controlsSelector = 'input, select, textarea';
            document.querySelectorAll('label').forEach((label, idx) => {
                if (label.htmlFor) return;
                if (label.querySelector(controlsSelector)) return; // nested control already associates
                const siblingControl = label.parentElement?.querySelector(controlsSelector) || label.nextElementSibling?.matches?.(controlsSelector) && label.nextElementSibling;
                if (siblingControl) {
                    if (!siblingControl.id) siblingControl.id = `auto-field-${idx}`;
                    label.htmlFor = siblingControl.id;
                }
            });
        }

        // ========== SALES & PURCHASE INVOICE SEARCH ==========
        // Apply search filter and highlighting to sales invoices table
        function applySalesSearch() {
            App.invoiceEngine.renderInvoiceTable('sales');
        }

        // Apply search filter and highlighting to purchase invoices table
        function applyPurchaseSearch() {
            App.invoiceEngine.renderInvoiceTable('purchase');
        }


        // ========== AUTHENTICATION LOGIC ==========
        App.auth.loadAuthData = async function () {
            try {
                // Load Roles
                const roleSnap = await database.ref('roles').once('value');
                const roles = {};
                roleSnap.forEach(child => {
                    const val = child.val();
                    if (val) {
                        val.id = val.id || child.key;
                        roles[val.id] = val;
                    }
                });
                App.auth.rolesById = roles;

                // Load Users
                const snapshot = await database.ref('users').once('value');
                const users = {};
                const usersByUsername = {};
                snapshot.forEach(child => {
                    const val = child.val();
                    if (val) {
                        val.id = val.id || child.key;
                        users[val.id] = val;
                        if (val.username) {
                            usersByUsername[val.username.toLowerCase()] = val;
                        }
                    }
                });
                App.auth.usersById = users;
                App.auth.usersByUsername = usersByUsername;
                console.log('Loaded users:', Object.keys(users).length, 'Roles:', Object.keys(roles).length);
            } catch (err) {
                console.error('Failed to load auth data', err);
            }
        };

        App.auth.login = async function (username, password) {
            if (!username || !password) throw new Error('Username and password required');
            const normUser = username.trim().toLowerCase();
            const user = App.auth.usersByUsername[normUser];

            if (!user) throw new Error('Invalid username');
            if (user.password !== password) throw new Error('Invalid password');
            if (user.isActive === false) throw new Error('User is inactive');

            return user;
        };

        App.auth.setCurrentUser = function (user) {
            App.auth.currentUser = user;

            // Link role
            const roleId = user.roleId || 'Admin';
            const role = App.auth.rolesById[roleId];

            App.state.currentUser = {
                id: user.id,
                name: user.displayName || user.username,
                username: user.username,
                role: roleId,
                roleName: role ? role.name : roleId,
                isAdmin: (roleId === 'Admin')
            };
            App.state.role = App.state.currentUser.role;

            // Persist session
            localStorage.setItem('factoryUserId', user.id);

            // Update UI Visibility based on Role
            if (typeof applyRoleVisibility === 'function') {
                applyRoleVisibility();
            }

            // Update UI
            document.body.classList.remove('logged-out');
            document.body.classList.add('logged-in');

            // Log
            recordActionLog('Login', 'User logged in', {
                userId: user.id,
                username: user.username,
                role: roleId
            });
        };

        App.auth.logout = function () {
            App.auth.currentUser = null;
            App.state.currentUser = null;
            localStorage.removeItem('factoryUserId');
            window.location.reload();
        };

        window.handleLogin = async function () {
            const userField = document.getElementById('loginUsername');
            const passField = document.getElementById('loginPassword');
            const errorField = document.getElementById('loginError');
            const btn = document.querySelector('.login-btn');

            errorField.textContent = '';
            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                const user = await App.auth.login(userField.value, passField.value);
                App.auth.setCurrentUser(user);

                // Initialize app if not done
                if (!window.appInitialized) {
                    if (typeof initApp === 'function') await initApp();
                    window.appInitialized = true;
                }

                // Initialize machines if not done (it was separate in original code)
                if (!window.machinesInitialized && typeof initializeMachines === 'function') {
                    await initializeMachines();
                    window.machinesInitialized = true;
                }

            } catch (err) {
                errorField.textContent = err.message || 'Login failed';
                btn.disabled = false;
                btn.textContent = 'Login System';
            }
        };

        // ========== USERS & ROLES MANAGEMENT ==========

        function switchUsersSubtab(subId, btn) {
            document.querySelectorAll('#users .subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#users .subtab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(subId).classList.add('active');
            if (btn) btn.classList.add('active');

            if (subId === 'users-roles') renderRolesTab();
            if (subId === 'users-list') renderUsersTab();
        }

        // --- ROLES LOGIC ---
        function renderRolesTab() {
            const select = document.getElementById('roleSelect');
            if (!select) return;

            // Populate Role Select
            select.innerHTML = '<option value="">-- Create New Role --</option>';
            const roles = App.auth.rolesById || {};
            Object.values(roles).forEach(role => {
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.textContent = role.name || role.id;
                select.appendChild(opt);
            });

            // Render Checkboxes
            const container = document.getElementById('roleAllowedTabs');
            if (container) {
                container.innerHTML = '';

                const TAB_LABELS = {
                    'dashboard': 'Dashboard',
                    'sales': 'Sales',
                    'purchase': 'Purchase',
                    'inventory': 'Inventory',
                    'production-entry': 'Production Entry',
                    'packing': 'Packing',
                    'reports': 'Reports',
                    'ledger': 'Ledger',
                    'size-control': 'Machine Size Control',
                    'masters': 'Masters',
                    'backup': 'Backup',
                    'users': 'Users & Roles'
                };

                ALL_TABS.forEach(tabId => {
                    if (tabId === 'users') return; // Don't allow disabling users tab easily? Or maybe yes? Let's allow it.

                    const labelText = TAB_LABELS[tabId] || (tabId.charAt(0).toUpperCase() + tabId.slice(1));

                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" value="${tabId}" id="chk_role_${tabId}">
                        ${labelText}
                    `;
                    container.appendChild(label);
                });
            }

            // Render Machine Type Checkboxes
            const machineTypesContainer = document.getElementById('roleAllowedMachineTypes');
            if (machineTypesContainer) {
                machineTypesContainer.innerHTML = '';
                const MACHINE_TYPES = ['Header', 'Rolling', 'Furnace', 'Tampering', 'Plating', 'Other'];

                MACHINE_TYPES.forEach(type => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" value="${type}" id="chk_role_machine_${type}">
                        ${type}
                    `;
                    machineTypesContainer.appendChild(label);
                });
            }

            // Render Capabilities Checkboxes
            const capabilitiesContainer = document.getElementById('roleCapabilities');
            if (capabilitiesContainer) {
                capabilitiesContainer.innerHTML = '';
                const CAPABILITIES = [
                    { id: 'editInvoices', label: 'Edit Invoices' },
                    { id: 'deleteInvoices', label: 'Delete Invoices' },
                    { id: 'manageMasters', label: 'Manage Masters (Customers, Suppliers, Sizes)' },
                    { id: 'viewReports', label: 'View Reports' },
                    { id: 'manageUsers', label: 'Manage Users & Roles' }
                ];

                CAPABILITIES.forEach(cap => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" value="${cap.id}" id="chk_role_cap_${cap.id}">
                        ${cap.label}
                    `;
                    capabilitiesContainer.appendChild(label);
                });
            }
        }

        function loadRoleForEdit() {
            const roleId = document.getElementById('roleSelect').value;
            const idInput = document.getElementById('roleIdInput');
            const descInput = document.getElementById('roleDescriptionInput');

            if (!roleId) {
                // New Role
                idInput.value = '';
                idInput.disabled = false;
                descInput.value = '';
                // Uncheck all
                document.querySelectorAll('#roleAllowedTabs input').forEach(chk => chk.checked = false);
                document.querySelectorAll('#roleAllowedMachineTypes input').forEach(chk => chk.checked = false);
                document.querySelectorAll('#roleCapabilities input').forEach(chk => chk.checked = false);
                return;
            }

            const role = App.auth.rolesById[roleId];
            if (role) {
                idInput.value = role.id;
                idInput.disabled = true; // Cannot change ID of existing role
                descInput.value = role.description || '';

                // Set checkboxes
                document.querySelectorAll('#roleAllowedTabs input').forEach(chk => {
                    chk.checked = !!(role.allowedTabs && role.allowedTabs[chk.value]);
                });

                // Set machine type checkboxes
                document.querySelectorAll('#roleAllowedMachineTypes input').forEach(chk => {
                    chk.checked = !!(role.allowedMachineTypes && role.allowedMachineTypes[chk.value]);
                });

                // Set capability checkboxes
                document.querySelectorAll('#roleCapabilities input').forEach(chk => {
                    chk.checked = !!(role.permissions && role.permissions[chk.value]);
                });
            }
        }

        async function saveRole() {
            const idInput = document.getElementById('roleIdInput');
            const descInput = document.getElementById('roleDescriptionInput');
            const roleId = idInput.value.trim();

            if (!roleId) {
                alert('Please enter a Role ID');
                return;
            }

            const allowedTabs = {};
            document.querySelectorAll('#roleAllowedTabs input').forEach(chk => {
                if (chk.checked) allowedTabs[chk.value] = true;
            });

            const allowedMachineTypes = {};
            document.querySelectorAll('#roleAllowedMachineTypes input').forEach(chk => {
                if (chk.checked) allowedMachineTypes[chk.value] = true;
            });

            const permissions = {};
            document.querySelectorAll('#roleCapabilities input').forEach(chk => {
                if (chk.checked) permissions[chk.value] = true;
            });

            const roleData = {
                id: roleId,
                name: roleId,
                description: descInput.value.trim(),
                allowedTabs: allowedTabs,
                allowedMachineTypes: allowedMachineTypes,
                permissions: permissions
            };

            try {
                await database.ref('roles/' + roleId).set(roleData);

                // Update local cache
                App.auth.rolesById[roleId] = roleData;

                alert('Role saved successfully');
                recordActionLog('RoleSave', `Saved role ${roleId}`, { roleId: roleId });

                // Refresh UI
                renderRolesTab();
                document.getElementById('roleSelect').value = roleId;
                loadRoleForEdit();

                // If current user is affected, re-apply visibility
                const currentUser = getCurrentUser();
                if (currentUser && (currentUser.role === roleId || currentUser.roleId === roleId)) {
                    applyRoleVisibility();
                }

            } catch (err) {
                console.error(err);
                alert('Error saving role: ' + err.message);
            }
        }

        async function deleteRole() {
            const roleId = document.getElementById('roleIdInput').value;
            if (!roleId) return;

            if (roleId === 'Admin') {
                alert('Cannot delete Admin role');
                return;
            }

            if (!confirm(`Are you sure you want to delete role "${roleId}"?`)) return;

            try {
                await database.ref('roles/' + roleId).remove();
                delete App.auth.rolesById[roleId];

                alert('Role deleted');
                recordActionLog('RoleDelete', `Deleted role ${roleId}`, { roleId: roleId });

                renderRolesTab();
                loadRoleForEdit(); // Reset form
            } catch (err) {
                console.error(err);
                alert('Error deleting role');
            }
        }

        // --- USERS LOGIC ---
        function renderUsersTab() {
            const tbody = document.querySelector('#usersTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const users = App.auth.usersById || {};
            Object.values(users).forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.displayName || ''}</td>
                    <td>${user.roleId || 'Admin'}</td>
                    <td>${user.isActive !== false ? ' Active' : ' Inactive'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editUser('${user.id}')"> Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Populate Role Select in User Form
            const roleSelect = document.getElementById('editUserRole');
            if (roleSelect) {
                roleSelect.innerHTML = '';
                const roles = App.auth.rolesById || {};
                Object.values(roles).forEach(role => {
                    const opt = document.createElement('option');
                    opt.value = role.id;
                    opt.textContent = role.name || role.id;
                    roleSelect.appendChild(opt);
                });
                // Add Admin fallback if not present
                if (!roles['Admin']) {
                    const opt = document.createElement('option');
                    opt.value = 'Admin';
                    opt.textContent = 'Admin';
                    roleSelect.appendChild(opt);
                }
            }
        }

        function editUser(userId) {
            const user = App.auth.usersById[userId];
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserDisplayName').value = user.displayName || '';
            document.getElementById('editUserPassword').value = user.password;
            document.getElementById('editUserRole').value = user.roleId || 'Admin';
            document.getElementById('editUserActive').checked = user.isActive !== false;

            // Scroll to form
            document.getElementById('editUserUsername').scrollIntoView({ behavior: 'smooth' });
        }

        function clearUserForm() {
            document.getElementById('editUserId').value = '';
            document.getElementById('editUserUsername').value = '';
            document.getElementById('editUserDisplayName').value = '';
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserRole').value = 'Admin';
            document.getElementById('editUserActive').checked = true;
        }

        async function saveUser() {
            const idInput = document.getElementById('editUserId');
            const usernameInput = document.getElementById('editUserUsername');
            const nameInput = document.getElementById('editUserDisplayName');
            const passInput = document.getElementById('editUserPassword');
            const roleInput = document.getElementById('editUserRole');
            const activeInput = document.getElementById('editUserActive');

            const username = usernameInput.value.trim();
            const password = passInput.value.trim();

            if (!username || !password) {
                alert('Username and Password are required');
                return;
            }

            let userId = idInput.value;
            if (!userId) {
                // Create new ID
                userId = 'U-' + Date.now();
            }

            const userData = {
                id: userId,
                username: username,
                displayName: nameInput.value.trim(),
                password: password,
                roleId: roleInput.value,
                isActive: activeInput.checked
            };

            try {
                await database.ref('users/' + userId).set(userData);

                // Update local cache
                App.auth.usersById[userId] = userData;
                App.auth.usersByUsername[username.toLowerCase()] = userData;

                alert('User saved successfully');
                recordActionLog('UserSave', `Saved user ${username}`, { userId: userId, roleId: userData.roleId });

                renderUsersTab();
                clearUserForm();

            } catch (err) {
                console.error(err);
                alert('Error saving user: ' + err.message);
            }
        }

        // ========== PERMISSIONS LOGIC ==========
        function getCurrentUser() {
            return (window.App && App.auth && App.auth.currentUser) ||
                (window.App && App.state && App.state.currentUser) ||
                null;
        }

        function getCurrentRole() {
            if (!App.auth.currentUser) return null;
            const roleId = App.auth.currentUser.role || App.auth.currentUser.roleId;
            return App.auth.rolesById[roleId];
        }

        function getCurrentRoleMachineTypes() {
            const role = getCurrentRole();
            if (!role || !role.allowedMachineTypes) {
                // No restriction defined for this role -> see all machines
                return null;
            }

            const allowed = Object.keys(role.allowedMachineTypes)
                .filter(t => role.allowedMachineTypes[t]);

            // If empty, treat as "no restriction" (backwards compatibility)
            if (allowed.length === 0) return null;

            return allowed;
        }

        function getCurrentRoleId() {
            const user = getCurrentUser();
            if (user) return user.role || user.roleId || 'Admin';
            return App.state.role || 'Admin';
        }



        function canAccessTab(tabId) {
            const role = getCurrentRole();
            // If no role defined (or Admin), allow everything by default
            if (!role) return true;
            // If role has no allowedTabs map, allow everything (backward compatibility)
            if (!role.allowedTabs) return true;

            // Otherwise check specific permission
            return !!role.allowedTabs[tabId];
        }

        function applyRoleVisibility() {
            const role = getCurrentRole();
            console.log('Applying role visibility for:', role ? role.id : 'Admin (default)');

            ALL_TABS.forEach(tabId => {
                const allowed = canAccessTab(tabId);
                const btn = document.querySelector(`.sidebar .tab-button[data-tab-id="${tabId}"]`);
                if (btn) {
                    btn.style.display = allowed ? 'flex' : 'none';
                }
            });

            // Check if current active tab is allowed
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                const activeId = activeTab.id;
                if (!canAccessTab(activeId)) {
                    // Switch to first allowed tab
                    const firstAllowed = ALL_TABS.find(id => canAccessTab(id));
                    if (firstAllowed) {
                        console.warn(`Current tab ${activeId} not allowed, switching to ${firstAllowed}`);
                        switchMainTab(firstAllowed, document.querySelector(`.sidebar .tab-button[data-tab-id="${firstAllowed}"]`));
                    }
                }
            }
        }

        async function restoreSessionIfAny() {
            const userId = localStorage.getItem('factoryUserId');
            if (!userId) return false;

            const user = App.auth.usersById[userId];
            if (user && user.isActive !== false) {
                console.log('Restoring session for', user.username);
                App.auth.setCurrentUser(user);
                return true;
            } else {
                localStorage.removeItem('factoryUserId');
                return false;
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('load', async function () {
            // Start in logged-out state
            document.body.classList.add('logged-out');

            try {
                // 1. Load Auth Data
                await App.auth.loadAuthData();

                // 2. Try Restore Session
                const restored = await restoreSessionIfAny();

                if (restored) {
                    // If restored, initialize app immediately
                    if (typeof initApp === 'function') await initApp();
                    window.appInitialized = true;

                    if (typeof initializeMachines === 'function') await initializeMachines();
                    window.machinesInitialized = true;
                } else {
                    // If not restored, stay in logged-out state (Login Overlay visible)
                    // App init will happen inside handleLogin
                }

                App.ui.updatePendingBadge();
                const perfStored = localStorage.getItem('factory_perf_mode');
                const perfPref = perfStored === null ? true : perfStored === '1';
                applyPerformanceMode(perfPref);

            } catch (err) {
                console.error('Error initializing core app:', err);
            }


            // Machine init is handled in the main flow now


            updateQuoteSizeOptions();
            refreshQuotesList();
            renderPendingOrders();

            const quoteDateEl = document.getElementById('quoteDate');
            if (quoteDateEl && !quoteDateEl.value) {
                quoteDateEl.value = getToday();
            }

            autoAssociateLabels();
            bindInvoiceSearchListeners();
            bindDedupePurchaseButton();
        });

        let machineFilter = localStorage.getItem('machineFilter') || 'All';
        let productionFilter = localStorage.getItem('productionFilter') || 'All';
        let activityLogsCache = [];
        let dashboardStageFilter = localStorage.getItem('dashboardStageFilter') || 'All';
        let quoteLines = [];
        let editingQuoteId = null;
        let cachedQuotes = [];
        let cachedCustomers = [];

        function updateSizeOptionsDatalist() {
            const datalist = document.getElementById('sizeOptionsList');
            const list = (App.state.sizes && App.state.sizes.list) ? App.state.sizes.list : [];
            if (!datalist || !list.length) return;

            const options = list.map(size => {
                const label = size.label || size.code || size.id;
                return `<option value="${label}"></option>`;
            }).join('');
            datalist.innerHTML = options;

            const quoteDatalist = document.getElementById('quoteSizeOptions');
            if (quoteDatalist) quoteDatalist.innerHTML = options;
        }

        // ==========================================
        // MACHINE MANAGEMENT LOGIC
        // ==========================================

        function ensureDefaultInventoryStages() {
            if (!window.appState.inventory) window.appState.inventory = {};
            INVENTORY_STAGES.forEach(stage => {
                if (!window.appState.inventory[stage]) {
                    window.appState.inventory[stage] = {};
                }
            });
        }

        function normalizeSizes(sizeList) {
            // DEPRECATED: Wrapper for compatibility. Use updateSizeCaches instead.
            if (!Array.isArray(sizeList)) return [];

            // Convert list -> map for updateSizeCaches
            const map = {};
            sizeList.forEach(s => {
                const id = String(s.id || s.size_id || '').trim();
                if (id) map[id] = s;
            });
            updateSizeCaches(map);
            return App.state.sizes.list;
        }

        function normalizeInventoryKeys() {
            if (!appState || !appState.inventory) return;

            // Ensure sizes cache is present
            if (!App.state.sizes || !App.state.sizes.byId) return;

            const normalizedInventory = {};

            Object.keys(appState.inventory).forEach(category => {
                const catItems = appState.inventory[category];
                if (!catItems) return;

                const normCat = {};
                Object.keys(catItems).forEach(rawKey => {
                    const item = catItems[rawKey];
                    const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                    if (qty <= 0) return;

                    const sizeId = resolveSizeIdFromAny({ sizeId: rawKey, ...((typeof item === 'object') ? item : {}) }, rawKey);
                    if (!sizeId) return;

                    // Preserve object structure if it exists, else create new
                    const existing = normCat[sizeId];
                    if (existing) {
                        // Merge
                        const existingQty = (typeof existing === 'object' ? existing.qty : parseFloat(existing)) || 0;
                        if (typeof existing === 'object') {
                            existing.qty = existingQty + qty;
                        } else {
                            normCat[sizeId] = existingQty + qty;
                        }
                    } else {
                        if (typeof item === 'object') {
                            normCat[sizeId] = { ...item, sizeId, qty };
                        } else {
                            normCat[sizeId] = qty;
                        }
                    }
                });

                normalizedInventory[category] = normCat;
            });

            appState.inventory = normalizedInventory;

            // Also normalize packing remarks if needed
            if (appState.packingRemarks && appState.packingRemarks['Finished Goods']) {
                const fgRemarks = appState.packingRemarks['Finished Goods'];
                const normRemarks = {};
                Object.keys(fgRemarks).forEach(key => {
                    const sizeId = resolveSizeIdFromAny({ sizeId: key }, key);
                    if (!sizeId) return;
                    if (!normRemarks[sizeId]) normRemarks[sizeId] = [];
                    normRemarks[sizeId] = normRemarks[sizeId].concat(fgRemarks[key]);
                });
                appState.packingRemarks['Finished Goods'] = normRemarks;
            }
        }

        function getCurrentUserName() {
            if (window.currentEmployee && window.currentEmployee.name) return window.currentEmployee.name;
            if (window.currentUser && (window.currentUser.displayName || window.currentUser.name)) {
                return window.currentUser.displayName || window.currentUser.name;
            }
            if (window.loggedInEmployee && window.loggedInEmployee.name) return window.loggedInEmployee.name;
            try {
                const stored = localStorage.getItem('factoryUserName');
                if (stored) return stored;
            } catch (err) { }
            return 'Admin';
        }

        function getCurrentUserRole() {
            if (window.currentEmployee && window.currentEmployee.role) return window.currentEmployee.role;
            if (window.currentUser && window.currentUser.role) return window.currentUser.role;
            if (window.loggedInEmployee && window.loggedInEmployee.role) return window.loggedInEmployee.role;
            try {
                const stored = localStorage.getItem('factoryUserRole');
                if (stored) return stored;
            } catch (err) { }
            return 'Admin';
        }

        function recordActionLog(actionType, description, details = {}) {
            const entityId = details.entityId || details.invoiceId || details.purchaseId || details.quoteId || '';
            const entityType = details.entityType || details.type || '';

            return App.db.log({
                action: actionType,
                entityType,
                entityId,
                description,
                details,        // put raw details in `details`
                extra: details, // keep `extra` as fallback
                userId: details.userId,
                role: details.role
            });
        }

        function parseAnyTimestamp(value) {
            if (!value) return null;
            if (value instanceof Date) return value;
            if (typeof value === 'object') {
                if (typeof value.toDate === 'function') return value.toDate();
                if (typeof value.seconds === 'number') return new Date(value.seconds * 1000);
                if (value.timestamp) return parseAnyTimestamp(value.timestamp);
            }
            const parsed = new Date(value);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function isDateWithinRange(value, fromDate, toDate) {
            if (!fromDate && !toDate) return true;
            const date = parseAnyTimestamp(value);
            if (!date) return true;
            if (fromDate) {
                const start = new Date(fromDate + 'T00:00:00');
                if (date < start) return false;
            }
            if (toDate) {
                const end = new Date(toDate + 'T23:59:59');
                if (date > end) return false;
            }
            return true;
        }

        function hasMeaningfulAppState() {
            if (!appState) return false;
            const inventory = appState.inventory || {};
            const hasInventory = Object.values(inventory).some(stage => {
                if (!stage) return false;
                return Object.values(stage).some(val => typeof val === 'number' ? val !== 0 : true);
            });
            const hasTotals = appState.machineDailyTotals && Object.values(appState.machineDailyTotals).some(val => parseFloat(val) > 0);
            const hasHistory = Array.isArray(appState.productionHistory) && appState.productionHistory.length > 0;
            const hasFinishedGoods = appState.finishedGoods && Object.keys(appState.finishedGoods).length > 0;
            return hasInventory || hasTotals || hasHistory || hasFinishedGoods;
        }

        function getCurrentShiftAnchorTimestamp() {
            const now = new Date();
            const anchor = new Date(now);
            anchor.setHours(8, 30, 0, 0);
            if (now < anchor) {
                anchor.setDate(anchor.getDate() - 1);
            }
            return anchor.getTime();
        }

        function ensureDailyTotalsReset() {
            if (!appState.machineDailyTotals) appState.machineDailyTotals = {};
            const currentAnchor = getCurrentShiftAnchorTimestamp();
            const lastReset = parseInt(appState.machineDailyResetAt || 0, 10);
            if (!lastReset) {
                appState.machineDailyResetAt = currentAnchor;
                if (isConnected && hasMeaningfulAppState()) {
                    try { fbPut('appState', 'appState', appState); } catch (e) {
                        console.warn('Unable to persist initial daily reset marker', e);
                    }
                }
                return;
            }
            if (lastReset < currentAnchor) {
                Object.keys(appState.machineDailyTotals).forEach(key => {
                    appState.machineDailyTotals[key] = 0;
                });
                appState.machineDailyResetAt = currentAnchor;
                if (isConnected && hasMeaningfulAppState()) {
                    try { fbPut('appState', 'appState', appState); } catch (e) {
                        console.warn('Unable to persist daily total reset', e);
                    }
                }
            }
        }

        // Ensure appState exists
        if (typeof window.appState === 'undefined') {
            window.appState = {
                machines: [],
                sizes: [],
                customers: [],
                suppliers: [],
                inventory: {},
                productionHistory: [],
                machineDailyTotals: {},
                machineDailyResetAt: null,
                finishedGoods: {},
                packingRemarks: {},
                sizeChangeRequests: [],
                activityLogs: []
            };
        } else {
            if (!window.appState.machines) window.appState.machines = [];
            if (!window.appState.inventory) window.appState.inventory = {};
            if (!window.appState.productionHistory) window.appState.productionHistory = [];
            if (!window.appState.machineDailyTotals) window.appState.machineDailyTotals = {};
            if (typeof window.appState.machineDailyResetAt === 'undefined') window.appState.machineDailyResetAt = null;
            if (!window.appState.finishedGoods) window.appState.finishedGoods = {};
            if (!window.appState.packingRemarks) window.appState.packingRemarks = {};
            if (!window.appState.sizeChangeRequests) window.appState.sizeChangeRequests = [];
            if (!window.appState.activityLogs) window.appState.activityLogs = [];
        }

        // Centralized helper to keep local cache in sync with current appState
        function persistFactoryAppState() {
            try {
                // Always store the latest full app state snapshot
                localStorage.setItem('factoryAppState', JSON.stringify(window.appState));
            } catch (err) {
                console.warn('Unable to cache app state locally', err);
            }
        }

        async function loadPersistedAppState(cachedState) {
            // 1) Start from whatever defaults window.appState already has
            let baseState = { ...window.appState };

            // 2) Merge cached local state on top (if present)
            if (cachedState && typeof cachedState === 'object') {
                baseState = {
                    ...baseState,
                    ...cachedState,
                    // Make sure these critical collections exist
                    inventory: cachedState.inventory || baseState.inventory || {},
                    machineDailyTotals: cachedState.machineDailyTotals || baseState.machineDailyTotals || {},
                    productionHistory: cachedState.productionHistory || baseState.productionHistory || []
                };
            }

            // 3) Try to pull remote state from Firebase
            let remoteState = null;
            let remoteHistory = [];
            if (isConnected) {
                try {
                    remoteState = await fbGet('appState', 'appState');
                    // Fetch recent production entries
                    const historySnap = await database.ref('productionEntries').limitToLast(500).once('value');
                    const historyVal = historySnap.val();
                    if (historyVal) {
                        remoteHistory = Object.values(historyVal).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    }
                } catch (err) {
                    App.ui.reportIssue('Failed to load persisted appState', err, 'error');
                }
            }

            // 4) If remote exists, merge it
            if (remoteState && typeof remoteState === 'object') {
                baseState = {
                    ...baseState,
                    ...remoteState,
                    inventory: remoteState.inventory || baseState.inventory || {},
                    machineDailyTotals: remoteState.machineDailyTotals || baseState.machineDailyTotals || {},
                    // Prefer fetched history over appState history if available
                    productionHistory: remoteHistory.length ? remoteHistory : (remoteState.productionHistory || baseState.productionHistory || [])
                };
            } else if (remoteHistory.length) {
                // If appState failed but history loaded
                baseState.productionHistory = remoteHistory;
            }

            // 5) Apply the merged result back to window.appState
            window.appState = baseState;

            // 6) Normalize secondary structures and defaults
            if (!Array.isArray(appState.sizeChangeRequests)) {
                appState.sizeChangeRequests = [];
            }
            if (typeof appState.machineDailyResetAt === 'undefined') {
                appState.machineDailyResetAt = null;
            }

            ensureDailyTotalsReset();
            normalizeInventoryKeys();
            ensureDefaultInventoryStages();

            // 7) Refresh Inventory UI if function exists
            if (typeof renderInventoryTab === 'function') {
                renderInventoryTab();
            }

            // 8) Cache the merged state locally
            persistFactoryAppState();
        }

        // Initialize Machines from Firebase
        async function initializeMachines() {
            let cachedState = null;
            try {
                const saved = localStorage.getItem('factoryAppState');
                if (saved) {
                    cachedState = JSON.parse(saved);
                }
            } catch (err) {
                console.warn('Unable to parse cached factory state:', err);
            }

            await loadPersistedAppState(cachedState);

            try {
                if (!isConnected) {
                    await waitForOnline(4000);
                }
            } catch (err) {
                console.warn('Firebase connection not ready, will attempt to use cached machines if available.', err);
            }

            if (isConnected) {
                try {
                    const sizes = await fbGetAll('sizes');
                    if (Array.isArray(sizes) && sizes.length) {
                        appState.sizes = normalizeSizes(sizes);
                        updateSizeOptionsDatalist();
                        console.log(` Loaded ${sizes.length} sizes into appState`);

                        // Sizes are now loaded, so we can safely normalize existing inventory keys
                        normalizeInventoryKeys();

                        // Refresh inventory view so it uses labels instead of raw ids
                        if (typeof renderInventoryTab === 'function') {
                            renderInventoryTab();
                        }

                        // If quotes use inventory, refresh their size options as well
                        if (typeof updateQuoteSizeOptions === 'function') {
                            updateQuoteSizeOptions();
                        }
                    }
                } catch (err) {
                    console.error('Error loading sizes for machine module:', err);
                    if (!appState.sizes.length && cachedState?.sizes) {
                        appState.sizes = normalizeSizes(cachedState.sizes);
                        updateSizeOptionsDatalist();

                        // After loading sizes from cache, normalize inventory and refresh views
                        normalizeInventoryKeys();
                        if (typeof renderInventoryTab === 'function') {
                            renderInventoryTab();
                        }
                        if (typeof updateQuoteSizeOptions === 'function') {
                            updateQuoteSizeOptions();
                        }
                    }
                }
            } else if (cachedState?.sizes) {
                appState.sizes = normalizeSizes(cachedState.sizes);
                updateSizeOptionsDatalist();

                // Normalize inventory based on cached sizes & refresh UI
                normalizeInventoryKeys();
                if (typeof renderInventoryTab === 'function') {
                    renderInventoryTab();
                }
                if (typeof updateQuoteSizeOptions === 'function') {
                    updateQuoteSizeOptions();
                }
            }

            if (isConnected) {
                try {
                    const machines = await fbGetAll('machines');
                    if (machines && machines.length > 0) {
                        appState.machines = machines;
                    } else {
                        const defaults = [
                            { name: 'Header Machines', type: 'Header', count: 20 },
                            { name: 'Rolling Machines', type: 'Rolling', count: 10 },
                            { name: 'Furnace', type: 'Furnace', count: 1 },
                            { name: 'Tampering', type: 'Tampering', count: 1 },
                            { name: 'Plating Machines', type: 'Plating', count: 4 }
                        ];

                        appState.machines = [];
                        for (const group of defaults) {
                            for (let i = 1; i <= group.count; i++) {
                                const machine = {
                                    id: `machine-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                    machine_type: group.type,
                                    display_name: `${group.type} ${i}`,
                                    status: 'Idle',
                                    current_size: ''
                                };
                                appState.machines.push(machine);
                                await fbPut('machines', machine.id, machine);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error loading machines:', err);
                    if (cachedState?.machines) {
                        appState.machines = cachedState.machines;
                    }
                }
            } else if (cachedState?.machines) {
                appState.machines = cachedState.machines;
            } else {
                console.warn('Offline: Cannot load machines from Firebase and no cached machine data was found.');
            }

            setMachineFilter(machineFilter);
            setProductionFilter(productionFilter);
            renderMachinesTable();
            updateQuoteSizeOptions();
        }

        const MACHINE_STAGE_MAP = {
            'Header': 'Header',
            'Rolling': 'Rolling',
            'Furnace': 'Furnace',
            'Tampering': 'Tampering',
            'Plating': 'Plating',
            'Other': 'Production'
        };

        // Production flow relationships, used for auto inventory deduction
        const STAGE_ORDER = {
            'Wire Input': { prev: null, next: 'Header' },
            'Header': { prev: 'Wire Input', next: 'Rolling' },
            'Rolling': { prev: 'Header', next: 'Furnace' },
            'Furnace': { prev: 'Rolling', next: 'Tampering' },
            'Tampering': { prev: 'Furnace', next: 'Plating' },
            'Plating': { prev: 'Tampering', next: 'Finished Goods' },
            'Packing': { prev: 'Plating', next: 'Finished Goods' },
            'Production': { prev: 'Rolling', next: 'Finished Goods' },
            'Finished Goods': { prev: 'Plating', next: null }
        };

        const INVENTORY_STAGE_LABELS = {
            'Wire Input': 'Wire Input',
            'Header': 'Header Output',
            'Rolling': 'Rolling Output',
            'Furnace': 'Hardening Output',
            'Tampering': 'Tampering Output',
            'Plating': 'Plating Output',
            'Packing': 'Packing Output',
            'Production': 'Production',
            'Finished Goods': 'Finished Goods',
            'Other': 'Other'
        };

        // Inventory cards should always show these stages, even at zero stock
        const INVENTORY_STAGES = [
            'Wire Input',
            'Header',
            'Rolling',
            'Furnace',
            'Tampering',
            'Plating',
            'Packing',
            'Production',
            'Finished Goods'
        ];

        function normalizeStageKey(stageValue) {
            if (!stageValue) return 'Rolling';
            const stageText = stageValue.toString().trim();
            if (appState && appState.inventory && appState.inventory[stageText]) {
                return stageText;
            }
            const match = Object.entries(INVENTORY_STAGE_LABELS).find(([, label]) => label === stageText);
            if (match) return match[0];
            return stageText;
        }



        function getSizeOptionLabel(size) {
            if (!size) return 'Size';
            return size.size_name || size.name || size.code || 'Size';
        }

        function findSizeByLabel(label) {
            const sizes = (App.state.sizes && App.state.sizes.list) ? App.state.sizes.list : [];
            return sizes.find(size => size.label === label || size.code === label || size.id === label);
        }

        function getMachineDisplayName(machine) {
            if (!machine) return 'Machine';
            return machine.display_name || machine.name || 'Machine';
        }

        function getMachineSizeId(machine) {
            if (!machine) return '';
            return machine.current_size || machine.currentSize || '';
        }

        function getMachineStage(machine) {
            if (!machine) return 'Production';
            return machine.stage || MACHINE_STAGE_MAP[machine.machine_type] || machine.machine_type || 'Production';
        }

        function renderMachinesTable() {
            // Render Grid in Size Control Tab
            const grid = document.getElementById('size-control-grid');
            if (grid) {
                grid.innerHTML = '';
                const ALL_MACHINE_TYPES = ['Header', 'Rolling', 'Furnace', 'Tampering', 'Plating', 'Other'];

                // Role-based allowed machine types
                const roleAllowedTypes = getCurrentRoleMachineTypes(); // null => no restriction

                // Apply existing UI filter AND role filter
                let visibleTypes = machineFilter === 'All' ? ALL_MACHINE_TYPES.slice() : [machineFilter];

                if (roleAllowedTypes) {
                    visibleTypes = visibleTypes.filter(t => roleAllowedTypes.includes(t));
                }

                let renderedAnything = false;

                visibleTypes.forEach(type => {
                    const machines = appState.machines.filter(m => (m.machine_type || 'Other') === type);
                    if (machines.length === 0) return;

                    renderedAnything = true;

                    const groupHeader = document.createElement('div');
                    groupHeader.style.gridColumn = '1 / -1';
                    groupHeader.innerHTML = `<h3 style="margin:0 0 10px;color:#f5f8ff;">${type} Machines (${machines.length})</h3>`;
                    grid.appendChild(groupHeader);

                    machines.forEach(machine => {
                        const sizeLabel = getSizeLabel(machine.current_size);
                        const displayValue = sizeLabel === 'Not set' ? '' : sizeLabel;

                        const card = document.createElement('div');
                        card.className = 'machine-card';
                        card.innerHTML = `
                            <div class="machine-header">
                                <div class="machine-name">${machine.display_name}</div>
                                <div class="machine-status-badge status-${(machine.status || 'Idle').toLowerCase()}">
                                    ${machine.status || 'Idle'}
                                </div>
                            </div>
                            <div class="size-selector">
                                <label>Current Size</label>
                                <input
                                    type="text"
                                    class="form-control machine-size-input"
                                    list="sizeOptionsList"
                                    placeholder="Start typing size..."
                                    value="${displayValue}"
                                    onchange="handleMachineSizeInput(this.value, '${machine.id}')"
                                >
                            </div>
                            <div class="machine-status">
                                <label class="status-radio running">
                                    <input
                                        type="radio"
                                        name="status-${machine.id}"
                                        ${(machine.status || 'Idle') === 'Running' ? 'checked' : ''}
                                        onchange="updateMachineStatus('${machine.id}', 'Running')"
                                    > Running
                                </label>
                                <label class="status-radio idle">
                                    <input
                                        type="radio"
                                        name="status-${machine.id}"
                                        ${(machine.status || 'Idle') === 'Idle' ? 'checked' : ''}
                                        onchange="updateMachineStatus('${machine.id}', 'Idle')"
                                    > Idle
                                </label>
                                <label class="status-radio maintenance">
                                    <input
                                        type="radio"
                                        name="status-${machine.id}"
                                        ${(machine.status || 'Idle') === 'Maintenance' ? 'checked' : ''}
                                        onchange="updateMachineStatus('${machine.id}', 'Maintenance')"
                                    > Maint.
                                </label>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                });

                if (!renderedAnything) {
                    const msg = document.createElement('p');
                    msg.textContent = 'No machines available for your role / filters.';
                    msg.style.color = '#ccc';
                    grid.appendChild(msg);
                }
            }

            // Render Table in Masters Tab
            const tbody = document.querySelector('#machinesTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
                appState.machines.forEach(machine => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="checkbox-column"><input type="checkbox" class="rowCheckbox" data-id="${machine.id}" onchange="toggleMachineSelected('${machine.id}')"></td>
                        <td>${machine.machine_type}</td>
                        <td>${machine.display_name}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn--sm" onclick="editMachine('${machine.id}')">Edit</button>
                                <button class="btn btn--sm btn--outline danger" onclick="deleteMachine('${machine.id}')">Delete</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            renderProductionEntryTab();
            renderDashboardTab();
        }

        async function updateMachineStatus(id, status) {
            const machine = appState.machines.find(m => m.id === id);
            if (machine) {
                const previousStatus = machine.status || 'Idle';
                machine.status = status;
                await fbPut('machines', id, machine);
                renderMachinesTable(); // Re-render to update UI
                renderMachinesTable(); // Re-render to update UI
                recordActionLog('Machine Status Changed', `Machine ${machine.name} status changed from ${previousStatus} to ${status}`, {
                    entityType: 'machine',
                    entityId: id,
                    machineId: id,
                    machineName: machine.name,
                    fromStatus: previousStatus,
                    toStatus: status
                });
            }
        }

        function getMachinesByStage(stage) {
            if (!Array.isArray(appState.machines)) return [];
            if (!stage || stage === 'All') return appState.machines.slice();
            return appState.machines.filter(m => (m.machine_type || 'Other') === stage);
        }

        function updateDashboardMachineOptions() {
            const select = document.getElementById('dashboardMachineSelect');
            if (!select) return;
            const machines = getMachinesByStage(dashboardStageFilter);
            const options = ['<option value="">Select Machine</option>'].concat(
                machines.map(machine => `<option value="${machine.id}">${getMachineDisplayName(machine)}</option>`)
            );
            select.innerHTML = options.join('');
        }

        function updateDashboardSizeOptions() {
            const select = document.getElementById('dashboardSizeSelect');
            if (!select) return;
            const sizes = Array.isArray(appState.sizes) ? appState.sizes : [];
            const options = ['<option value="">Select Size</option>'].concat(
                sizes.map(size => `<option value="${size.id}">${getSizeOptionLabel(size)}</option>`)
            );
            select.innerHTML = options.join('');
        }

        function setDashboardStageFilter(value) {
            dashboardStageFilter = value || 'All';
            try { localStorage.setItem('dashboardStageFilter', dashboardStageFilter); } catch (e) { }
            updateDashboardMachineOptions();
            renderDashboardTab();
        }

        function getMachineDailyTotal(machineId) {
            if (!appState.machineDailyTotals) return 0;
            return parseInt(appState.machineDailyTotals[machineId] || 0, 10);
        }

        function renderDashboardTab() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            ensureDailyTotalsReset();
            const stageSelect = document.getElementById('dashboardStageFilter');
            if (stageSelect) stageSelect.value = dashboardStageFilter;
            updateDashboardMachineOptions();
            updateDashboardSizeOptions();

            const machines = getMachinesByStage(dashboardStageFilter);
            if (!machines.length) {
                grid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:var(--text-secondary);">No machines found for this selection.</div>';
                renderSizeChangeRequests();
                return;
            }

            grid.innerHTML = machines.map(machine => {
                const sizeLabel = getSizeLabel(getMachineSizeId(machine));
                const status = (machine.status || 'Idle');
                const stage = getMachineStage(machine);
                const total = getMachineDailyTotal(machine.id);
                return `
                <div class="machine-card">
                    <div class="machine-header">
                        <div class="machine-name">${getMachineDisplayName(machine)}</div>
                        <div class="machine-status-badge ${status.toLowerCase()}">${status}</div>
                    </div>
                    <div style="margin-top:12px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Stage</div>
                        <div style="font-weight:600;">${stage}</div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Current Size</div>
                        <div style="font-weight:600;">${sizeLabel || 'Not set'}</div>
                    </div>
                    <div style="margin-top:10px;">
                        <div style="font-size:0.85em; color:var(--text-secondary);">Bags since 8:30 AM</div>
                        <div style="font-size:1.4em; font-weight:700; color:var(--color-primary);">${total}</div>
                    </div>
                </div>`;
            }).join('');
            renderSizeChangeRequests();
        }

        function renderSizeChangeRequests() {
            const containers = [
                document.getElementById('dashboard-change-requests'),
                document.getElementById('size-control-change-requests')
            ];
            const requests = Array.isArray(appState.sizeChangeRequests) ? appState.sizeChangeRequests : [];
            containers.forEach(container => {
                if (!container) return;
                if (!requests.length) {
                    container.innerHTML = '<div style="padding:12px; color:var(--text-secondary);">No pending size change requests.</div>';
                    return;
                }
                container.innerHTML = requests.map(req => {
                    const stageLabel = INVENTORY_STAGE_LABELS[req.stage] || req.stage || '';
                    const note = req.note ? `<div style="font-size:0.85em; color:var(--text-secondary); margin-top:4px;">Note: ${req.note}</div>` : '';
                    const time = req.requestedAt ? new Date(req.requestedAt).toLocaleString() : '';
                    return `
                        <div class="inventory-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.1);">
                            <div>
                                <div style="font-weight:600;">${req.machineName || 'Machine'}  ${getSizeLabel(req.sizeId)}</div>
                                <div style="font-size:0.85em; color:var(--text-secondary);">${stageLabel}${time ? '  ' + time : ''}</div>
                                ${note}
                            </div>
                            <button class="success" style="padding:6px 12px;" onclick="completeSizeChangeRequest('${req.id}')">Done</button>
                        </div>`;
                }).join('');
            });
        }

        async function submitSizeChangeRequest() {
            const machineSelect = document.getElementById('dashboardMachineSelect');
            const sizeSelect = document.getElementById('dashboardSizeSelect');
            if (!machineSelect || !sizeSelect) return;
            const machineId = machineSelect.value;
            const sizeId = sizeSelect.value;
            if (!machineId) {
                alert('Select a machine first.');
                return;
            }
            if (!sizeId) {
                alert('Select the target size.');
                return;
            }
            const machine = (appState.machines || []).find(m => m.id === machineId);
            if (!machine) {
                alert('Machine not found.');
                return;
            }
            const noteInput = document.getElementById('dashboardChangeNote');
            const note = noteInput ? noteInput.value.trim() : '';
            const request = {
                id: `SCR_${Date.now()}`,
                machineId,
                machineName: getMachineDisplayName(machine),
                stage: getMachineStage(machine) || 'Other',
                sizeId,
                note,
                requestedAt: new Date().toISOString()
            };
            if (!Array.isArray(appState.sizeChangeRequests)) appState.sizeChangeRequests = [];
            appState.sizeChangeRequests.push(request);
            try {
                await fbPut('appState', 'appState', appState);
            } catch (err) {
                console.error('Unable to save size change request', err);
            }
            if (noteInput) noteInput.value = '';
            renderSizeChangeRequests();
            const machineStage = getMachineStage(machine) || 'Production';
            recordActionLog('Size Change Request', `Requested ${getSizeLabel(sizeId)} on ${getMachineDisplayName(machine)} (${INVENTORY_STAGE_LABELS[machineStage] || machineStage})`, {
                machineId,
                sizeId,
                note,
                stage: INVENTORY_STAGE_LABELS[machineStage] || machineStage
            });
            alert('Size change request submitted.');
        }

        async function completeSizeChangeRequest(id) {
            if (!Array.isArray(appState.sizeChangeRequests)) return;
            const request = appState.sizeChangeRequests.find(req => req.id === id);
            appState.sizeChangeRequests = appState.sizeChangeRequests.filter(req => req.id !== id);
            try {
                await fbPut('appState', 'appState', appState);
            } catch (err) {
                console.error('Unable to update requests', err);
            }
            renderSizeChangeRequests();
            renderDashboardTab();
            if (request) {
                const stageLabel = request.stage ? (INVENTORY_STAGE_LABELS[request.stage] || request.stage) : '';
                recordActionLog('Size Change Request Completed', `Completed size change for ${request.machineName} in ${stageLabel}`, {
                    machineId: request.machineId,
                    sizeId: request.sizeId,
                    stage: stageLabel
                });
            }
        }

        async function updateMachineSize(id, sizeId) {
            const machine = appState.machines.find(m => m.id === id);
            if (machine) {
                const previousSizeLabel = getSizeLabel(machine.current_size);
                machine.current_size = sizeId;
                await fbPut('machines', id, machine);
                const newSizeLabel = getSizeLabel(sizeId);
                recordActionLog('Machine Size Changed', `${getMachineDisplayName(machine)} size changed from ${previousSizeLabel || 'Unset'} to ${newSizeLabel || 'Unset'}`, { machineId: id, previousSize: previousSizeLabel, newSize: newSizeLabel });
            }
        }

        function handleMachineSizeInput(value, machineId) {
            const cleaned = (value || '').trim();
            if (!cleaned) {
                updateMachineSize(machineId, '');
                renderMachinesTable();
                return;
            }
            const size = findSizeByLabel(cleaned);
            if (!size) {
                alert(' Please select a valid size from the list.');
                renderMachinesTable();
                return;
            }
            updateMachineSize(machineId, size.id);
            renderMachinesTable();
        }

        function openAddMachineModal() {
            // Create modal if not exists
            let modal = document.getElementById('addMachineModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'addMachineModal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeModal('addMachineModal')">&times;</span>
                        <h3>Add New Machine</h3>
                        <form onsubmit="saveMachine(event)">
                            <div class="form-group">
                                <label class="form-label">Machine Type *</label>
                                <select class="form-control" id="machineType" required>
                                    <option value="">Select Type</option>
                                    <option value="Header">Header</option>
                                    <option value="Rolling">Rolling</option>
                                    <option value="Furnace">Furnace</option>
                                    <option value="Tampering">Tampering</option>
                                    <option value="Plating">Plating</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Display Name *</label>
                                <input type="text" class="form-control" id="machineDisplayName" required>
                            </div>
                            <button type="submit" class="btn btn--primary">Save Machine</button>
                        </form>
                    </div>
                    `;
                document.body.appendChild(modal);
            }
            // Use standard display property or class
            modal.style.display = 'flex';
            // Also add active class just in case
            modal.classList.add('active');
        }

        async function saveMachine(event) {
            event.preventDefault();
            const type = document.getElementById('machineType').value;
            const name = document.getElementById('machineDisplayName').value.trim();
            if (!type || !name) return;

            const machine = {
                id: 'machine-' + Date.now(),
                machine_type: type,
                display_name: name,
                status: 'Idle',
                current_size: ''
            };

            try {
                appState.machines.push(machine);
                await fbPut('machines', machine.id, machine);

                closeModal('addMachineModal');
                renderMachinesTable();
                recordActionLog('Machine Created', `Created machine ${name} (${type})`, {
                    entityType: 'machine',
                    entityId: machine.id,
                    machineId: machine.id,
                    machineName: name,
                    type
                });
                App.ui.showToast(`Machine "${name}" added successfully!`, 'success');
            } catch (err) {
                App.ui.reportIssue('Error saving machine', err, 'error');
            }
        }

        function editMachine(machineId) {
            const machine = appState.machines.find(m => m.id === machineId);
            if (!machine) return;

            let modal = document.getElementById('editMachineModal');
            // Remove existing to refresh
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editMachineModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal('editMachineModal')">&times;</span>
                    <h3>Edit Machine</h3>
                    <form onsubmit="updateMachine(event, '${machineId}')">
                        <div class="form-group">
                            <label class="form-label">Machine Type *</label>
                            <select class="form-control" id="editMachineType" required>
                                <option value="Header" ${machine.machine_type === 'Header' ? 'selected' : ''}>Header</option>
                                <option value="Rolling" ${machine.machine_type === 'Rolling' ? 'selected' : ''}>Rolling</option>
                                <option value="Furnace" ${machine.machine_type === 'Furnace' ? 'selected' : ''}>Furnace</option>
                                <option value="Tampering" ${machine.machine_type === 'Tampering' ? 'selected' : ''}>Tampering</option>
                                <option value="Plating" ${machine.machine_type === 'Plating' ? 'selected' : ''}>Plating</option>
                                <option value="Other" ${machine.machine_type === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" id="editMachineDisplayName" value="${machine.display_name}" required>
                        </div>
                        <button type="submit" class="btn btn--primary">Update Machine</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            modal.classList.add('active');
        }

        async function updateMachine(event, machineId) {
            event.preventDefault();
            const type = document.getElementById('editMachineType').value;
            const name = document.getElementById('editMachineDisplayName').value.trim();
            if (!type || !name) return;

            const machine = appState.machines.find(m => m.id === machineId);
            if (machine) {
                const previousName = machine.display_name;
                const previousType = machine.machine_type;
                machine.machine_type = type;
                machine.display_name = name;
                await fbPut('machines', machineId, machine);

                closeModal('editMachineModal');
                renderMachinesTable();
                recordActionLog('Machine Updated', `Updated machine ${previousName} (${previousType})  ${name} (${type})`, { machineId, previousName, previousType, newName: name, newType: type });
                alert(` Machine updated successfully!`);
            }
        }

        async function deleteMachine(machineId) {
            if (!confirm('Are you sure you want to delete this machine? This may affect production tracking.')) return;

            try {
                const machine = appState.machines.find(m => m.id === machineId);
                appState.machines = appState.machines.filter(m => m.id !== machineId);
                await fbDelete('machines', machineId);
                renderMachinesTable();
                recordActionLog('Machine Deleted', `Deleted machine ${machine ? getMachineDisplayName(machine) : machineId}`, {
                    entityType: 'machine',
                    entityId: machineId,
                    machineId,
                    machineName: machine ? getMachineDisplayName(machine) : machineId
                });
                App.ui.showToast('Machine deleted successfully!', 'success');
            } catch (err) {
                App.ui.reportIssue('Error deleting machine', err, 'error');
            }
        }

        async function forceReinitializeMachines() {
            if (confirm('Are you sure you want to reset all machines to default? This cannot be undone.')) {
                appState.machines = [];
                // Delete all from firebase first
                const machines = await fbGetAll('machines');
                for (const m of machines) {
                    await fbDelete('machines', m.id);
                }
                initializeMachines();
                alert(' Machines reset to default!');
            }
        }

        function toggleMachineSelected(machineId) {
            // Placeholder for bulk selection logic
        }

        function setMachineFilter(type) {
            machineFilter = type;
            try { localStorage.setItem('machineFilter', type); } catch (e) { }
            const select = document.getElementById('machineFilterSelect');
            if (select) select.value = type;
            renderMachinesTable();
            updatePackingSizeOptions();
        }

        // Override switchMastersSubtab to handle machines
        window.switchMastersSubtab = function (id, btn) {
            document.querySelectorAll('#masters .subtab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#masters .subtab-btn').forEach(el => el.classList.remove('active'));

            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            if (btn) btn.classList.add('active');

            if (id === 'masters-machines') {
                renderMachinesTable();
            }
        };

        // Render Production Entry Tab with Grouped Machines
        function renderProductionEntryTab() {
            const container = document.getElementById('production-entry-grid');
            if (!container) return;
            container.innerHTML = '';
            container.className = ''; // Remove grid class

            const machineGroups = [
                { name: 'Header Machines', type: 'Header' },
                { name: 'Rolling Machines', type: 'Rolling' },
                { name: 'Hardening Furnace', type: 'Furnace' },
                { name: 'Tampering Machine', type: 'Tampering' },
                { name: 'Plating Machines', type: 'Plating' }
            ];

            const roleAllowedTypes = getCurrentRoleMachineTypes(); // null => no restriction
            let renderedAnyGroup = false;

            machineGroups.forEach(group => {
                // Existing UI filter
                if (productionFilter !== 'All' && group.type !== productionFilter) return;

                // New: role-based filter
                if (roleAllowedTypes && !roleAllowedTypes.includes(group.type)) return;

                const groupMachines = appState.machines.filter(m => {
                    return (m.machine_type || m.type) === group.type;
                });
                if (groupMachines.length === 0) return;

                renderedAnyGroup = true;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'machine-group-section';
                sectionDiv.style = 'margin-bottom: var(--space-24);';

                sectionDiv.innerHTML = `
                    <div class="machine-group-header" style="display: flex; align-items: center; gap: var(--space-12); margin-bottom: var(--space-16); cursor: pointer;" onclick="toggleProductionGroup('${group.type}')">
                        <span class="group-toggle-icon" id="prod-toggle-${group.type}" style="font-size: var(--font-size-lg); transition: transform var(--duration-normal);"></span>
                        <h3 style="margin: 0; color: var(--color-primary);">${group.name} (${groupMachines.length})</h3>
                    </div>
                    <div class="machine-group-content" id="prod-content-${group.type}" style="display: block;">
                        <div class="machine-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-16);">
                            ${groupMachines.map(machine => `
                                <div class="machine-card">
                                    <div class="machine-header">
                                        <span class="machine-name">${getMachineDisplayName(machine)}</span>
                                        <span class="status ${(machine.status || 'Idle').toLowerCase()}">${machine.status || 'Idle'}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: var(--space-12); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                        Current Size: <strong id="current-size-${machine.id}">${getSizeLabel(getMachineSizeId(machine))}</strong><br>
                                        Today's Total: <strong id="total-${machine.id}" style="color: var(--color-primary); font-size: var(--font-size-lg);">${appState.machineDailyTotals[machine.id] || 0} bags</strong>
                                    </div>
                                    
                                    <div class="production-input">
                                        <div style="flex: 1;">
                                            <label class="form-label">Bags Since Last Reading:</label>
                                            <input type="number" class="form-control" id="${machine.id}-bags" 
                                                   placeholder="Enter bag count" min="0">
                                        </div>
                                        <button class="prod-action-btn" onclick="recordProduction('${machine.id}')">Record</button>
                                        <button class="prod-action-btn secondary" onclick="resetClicker('${machine.id}')">Reset</button>
                                        <button class="prod-action-btn ghost" onclick="addOneBag('${machine.id}')">+1</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                container.appendChild(sectionDiv);
            });

            if (!renderedAnyGroup) {
                container.innerHTML = '<p style="color:#ccc;">No machines available for your role / filters.</p>';
            }
        }

        // Toggle production group visibility
        function toggleProductionGroup(groupType) {
            const content = document.getElementById(`prod-content-${groupType}`);
            const icon = document.getElementById(`prod-toggle-${groupType}`);
            if (!content || !icon) {
                console.warn('toggleProductionGroup: missing DOM nodes for', groupType);
                return;
            }

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.textContent = '';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        function setProductionFilter(type) {
            productionFilter = type;
            try { localStorage.setItem('productionFilter', type); } catch (e) { }
            const select = document.getElementById('productionFilterSelect');
            if (select) select.value = type;
            renderProductionEntryTab();
        }

        function recordProduction(machineId) {
            console.log(`Recording production for machine: ${machineId} `);

            const machine = appState.machines.find(m => m.id === machineId);
            if (!machine) {
                alert(` Machine ${machineId} not found`);
                return;
            }

            const bagsInput = document.getElementById(`${machineId}-bags`);
            if (!bagsInput) {
                alert(' Unable to find the bag input for this machine. Please reload the page.');
                return;
            }
            const bags = parseInt(bagsInput.value);

            // Validation
            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid positive number of bags');
                return;
            }

            const machineName = getMachineDisplayName(machine);
            const rawSizeId = getMachineSizeId(machine);
            const sizeId = resolveSizeIdFromAny({ sizeId: rawSizeId }, rawSizeId);

            if (!sizeId) {
                alert(` Please set a size for ${machineName} in the Size Control tab first`);
                return;
            }
            const sizeLabel = getSizeLabel(sizeId);

            try {
                console.log(`Before: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId] || 0} `);

                const stage = getMachineStage(machine);
                // Use clean sizeId directly
                const size = sizeId;
                // sizeKey is deprecated in favor of sizeId, but keeping variable name if needed for minimal diff, 
                // but actually we should use sizeId for keys now.
                const sizeKey = sizeId;

                // **NEW FEATURE 1**: Auto-deduct from previous stage
                const prevStage = STAGE_ORDER[stage]?.prev;
                // Only check and deduct from previous stage if it's NOT Wire Input
                // Wire Input is for recording raw material intake only, not for production tracking
                if (prevStage && prevStage !== 'Wire Input') {
                    // Check if previous stage has enough inventory
                    if (!appState.inventory[prevStage]) appState.inventory[prevStage] = {};
                    if (!appState.inventory[prevStage][sizeKey] || appState.inventory[prevStage][sizeKey] < bags) {
                        const available = appState.inventory[prevStage][sizeKey] || 0;
                        alert(` Insufficient inventory in ${prevStage} \nRequired: ${bags} bags of ${sizeLabel} \nAvailable: ${available} bags\n\nPlease ensure previous stage has enough inventory before recording production.`);
                        return;
                    }

                    // Deduct from previous stage
                    appState.inventory[prevStage][sizeKey] -= bags;
                    console.log(`Deducted ${bags} bags of ${sizeLabel} from ${prevStage} `);
                }

                // CRITICAL: Update THIS machine's specific daily total
                if (!appState.machineDailyTotals[machineId]) {
                    appState.machineDailyTotals[machineId] = 0;
                }
                appState.machineDailyTotals[machineId] += bags;

                // Update machine object totals
                machine.dailyProduction = (machine.dailyProduction || 0) + bags;
                machine.clickerCount = (machine.clickerCount || 0) + bags;

                // Add to inventory at appropriate stage
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }
                if (!appState.inventory[stage][sizeKey]) {
                    appState.inventory[stage][sizeKey] = 0;
                }
                appState.inventory[stage][sizeKey] += bags;

                // Record in production history (New Collection)
                const entry = {
                    id: `prod-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    machineId: machineId,
                    machineName: machineName,
                    size: size,
                    bags: bags,
                    timestamp: new Date().toISOString(),
                    stage: stage
                };

                // Optimistically update local history for UI
                if (!Array.isArray(appState.productionHistory)) appState.productionHistory = [];
                appState.productionHistory.push(entry);
                // Keep local history small
                if (appState.productionHistory.length > 500) appState.productionHistory = appState.productionHistory.slice(-500);

                // **REAL-TIME DB UPDATE**: Persist using granular updates
                const updates = {};

                // 1. Add to productionEntries collection
                safePush('productionEntries', entry);

                // 2. Update Machine Daily Total
                updates[`appState/machineDailyTotals/${machineId}`] = appState.machineDailyTotals[machineId];

                // 3. Update Inventory (Current Stage)
                updates[`appState/inventory/${stage}/${sizeKey}`] = appState.inventory[stage][sizeKey];

                // 4. Update Inventory (Previous Stage Deduction)
                if (prevStage && prevStage !== 'Wire Input') {
                    updates[`appState/inventory/${prevStage}/${sizeKey}`] = appState.inventory[prevStage][sizeKey];
                }

                // 5. Update Machine Stats
                updates[`machines/${machineId}/dailyProduction`] = machine.dailyProduction;
                updates[`machines/${machineId}/clickerCount`] = machine.clickerCount;

                // Execute partial updates
                safeUpdate('/', updates);

                // Persist the updated state locally so reloads see the latest production & inventory
                persistFactoryAppState();

                console.log(`After: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // CRITICAL: Update the display immediately for this specific machine
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = `${appState.machineDailyTotals[machineId]} bags`;
                    console.log(`Updated display for ${machineId}: ${appState.machineDailyTotals[machineId]} bags`);
                }

                // Clear input
                bagsInput.value = '';

                // Show success message
                const prevStageMsg = prevStage ? `\nDeducted ${bags} bags from ${prevStage} ` : '';
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                const prevStageLabel = prevStage ? (INVENTORY_STAGE_LABELS[prevStage] || prevStage) : null;
                recordActionLog('Production Entry', `${machineName} recorded ${bags} bags of ${sizeLabel} into ${stageLabel}${prevStageLabel ? ` (deducted from ${prevStageLabel})` : ''}`, { machineId, size: sizeLabel, bags, stage: stageLabel, prevStage: prevStageLabel });
                alert(` Recorded ${bags} bags of ${sizeLabel} from ${machineName}${prevStageMsg} \nNew total: ${appState.machineDailyTotals[machineId]} bags`);

                // Refresh inventory display if on that tab
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

                // If quotes use inventory-based sizes, refresh their options too
                if (typeof updateQuoteSizeOptions === 'function') {
                    updateQuoteSizeOptions();
                }

            } catch (error) {
                console.error('Error recording production:', error);
                alert(` Error recording production: ${error.message} `);
            }
        }

        // Add one bag to machine production (quick +1 button)
        function addOneBag(machineId) {
            console.log(`Adding one bag for machine: ${machineId} `);

            const machine = appState.machines.find(m => m.id === machineId);

            if (!machine) {
                alert(` Machine ${machineId} not found`);
                return;
            }

            const machineName = getMachineDisplayName(machine);
            const sizeId = getMachineSizeId(machine);
            if (!sizeId) {
                alert(` Please set a size for ${machineName} in the Size Control tab first`);
                return;
            }
            const sizeLabel = getSizeLabel(sizeId);

            try {
                const bags = 1; // Always exactly 1 bag
                console.log(`Before: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId] || 0} `);

                const stage = getMachineStage(machine);
                const size = sizeId;
                const sizeKey = getInventorySizeKey(size);

                // **NEW FEATURE 1**: Auto-deduct from previous stage
                const prevStage = STAGE_ORDER[stage]?.prev;
                // Only check and deduct from previous stage if it's NOT Wire Input
                // Wire Input is for recording raw material intake only, not for production tracking
                if (prevStage && prevStage !== 'Wire Input') {
                    // Check if previous stage has enough inventory
                    if (!appState.inventory[prevStage]) appState.inventory[prevStage] = {};
                    if (!appState.inventory[prevStage][sizeKey] || appState.inventory[prevStage][sizeKey] < bags) {
                        const available = appState.inventory[prevStage][sizeKey] || 0;
                        alert(` Insufficient inventory in ${prevStage} \nRequired: ${bags} bags of ${sizeLabel} \nAvailable: ${available} bags\n\nPlease ensure previous stage has enough inventory before recording production.`);
                        return;
                    }

                    // Deduct from previous stage
                    appState.inventory[prevStage][sizeKey] -= bags;
                    console.log(`Deducted ${bags} bags of ${sizeLabel} from ${prevStage} `);
                }

                // CRITICAL: Update THIS machine's specific daily total
                if (!appState.machineDailyTotals[machineId]) {
                    appState.machineDailyTotals[machineId] = 0;
                }
                appState.machineDailyTotals[machineId] += bags;

                // Update machine object totals
                machine.dailyProduction = (machine.dailyProduction || 0) + bags;
                machine.clickerCount = (machine.clickerCount || 0) + bags;

                // Add to inventory at appropriate stage
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }
                if (!appState.inventory[stage][sizeKey]) {
                    appState.inventory[stage][sizeKey] = 0;
                }
                appState.inventory[stage][sizeKey] += bags;

                // Record in production history (New Collection)
                const entry = {
                    id: `prod-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    machineId: machineId,
                    machineName: machineName,
                    size: size,
                    bags: bags,
                    timestamp: new Date().toISOString(),
                    stage: stage
                };

                // Optimistically update local history for UI
                if (!Array.isArray(appState.productionHistory)) appState.productionHistory = [];
                appState.productionHistory.push(entry);
                if (appState.productionHistory.length > 500) appState.productionHistory = appState.productionHistory.slice(-500);

                // **REAL-TIME DB UPDATE**: Persist using granular updates
                const updates = {};

                // 1. Add to productionEntries collection
                safePush('productionEntries', entry);

                // 2. Update Machine Daily Total
                updates[`appState/machineDailyTotals/${machineId}`] = appState.machineDailyTotals[machineId];

                // 3. Update Inventory (Current Stage)
                updates[`appState/inventory/${stage}/${sizeKey}`] = appState.inventory[stage][sizeKey];

                // 4. Update Inventory (Previous Stage Deduction)
                if (prevStage && prevStage !== 'Wire Input') {
                    updates[`appState/inventory/${prevStage}/${sizeKey}`] = appState.inventory[prevStage][sizeKey];
                }

                // 5. Update Machine Stats
                updates[`machines/${machineId}/dailyProduction`] = machine.dailyProduction;
                updates[`machines/${machineId}/clickerCount`] = machine.clickerCount;

                // Execute partial updates
                safeUpdate('/', updates);

                // Persist the updated state locally so reloads see the latest clicker totals & inventory
                persistFactoryAppState();

                console.log(`After: Machine ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // CRITICAL: Update the display immediately for this specific machine
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = `${appState.machineDailyTotals[machineId]} bags`;
                    console.log(`Updated display for ${machineId}: ${appState.machineDailyTotals[machineId]} bags`);
                }

                // Show success message
                const prevStageMsg = prevStage ? `\nDeducted ${bags} bags from ${prevStage} ` : '';
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                const prevStageLabel = prevStage ? (INVENTORY_STAGE_LABELS[prevStage] || prevStage) : null;
                recordActionLog('Production Entry', `${machineName} recorded ${bags} bag of ${sizeLabel} into ${stageLabel}${prevStageLabel ? ` (deducted from ${prevStageLabel})` : ''}`, { machineId, size: sizeLabel, bags, stage: stageLabel, prevStage: prevStageLabel });
                alert(` Recorded ${bags} bags of ${sizeLabel} from ${machineName}${prevStageMsg} \nNew total: ${appState.machineDailyTotals[machineId]} bags`);

                // Refresh inventory display if on that tab
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

                if (typeof updateQuoteSizeOptions === 'function') {
                    updateQuoteSizeOptions();
                }

            } catch (error) {
                console.error('Error adding one bag:', error);
                alert(` Error adding bag: ${error.message} `);
            }
        }

        function resetClicker(machineId) {
            if (!confirm('Are you sure you want to reset the daily total? This cannot be undone.')) {
                return;
            }

            const machine = appState.machines.find(m => m.id === machineId);
            if (machine) {
                console.log(`Resetting clicker for ${machineId}`);

                // Reset both the machine's daily production and the separate tracking
                machine.dailyProduction = 0;
                machine.clickerCount = 0;
                appState.machineDailyTotals[machineId] = 0;
                appState.machineDailyResetAt = getCurrentShiftAnchorTimestamp();
                ensureDailyTotalsReset();

                // Persist reset changes to Firebase
                fbPut('appState', 'appState', appState);

                console.log(`Reset complete: ${machineId} daily total = ${appState.machineDailyTotals[machineId]} `);

                // Update the display immediately
                const totalElement = document.getElementById(`total-${machineId}`);
                if (totalElement) {
                    totalElement.textContent = '0 bags';
                    console.log(`Updated display for ${machineId}: 0 bags`);
                }
                if (typeof renderDashboardTab === 'function') {
                    renderDashboardTab();
                }

                recordActionLog('Production Reset', `Reset daily total for ${getMachineDisplayName(machine)}`, { machineId });
                alert(` Daily total reset to 0 for ${getMachineDisplayName(machine)}`);
            } else {
                alert(` Machine ${machineId} not found`);
            }
        }

        // Render Packing Tab
        function renderPackingTab() {
            const container = document.getElementById('packing-grid');
            if (!container) return;

            // Initialize packing remarks if not exists
            if (!appState.packingRemarks) {
                appState.packingRemarks = {};
            }

            // Render Finished Goods List
            renderFinishedGoodsList();

            // Render pending orders from quotes
            renderPendingOrders();

            // Setup size dropdown for packing
            updatePackingSizeOptions();
        }

        function selectPackingSize() { }

        function updatePackingSizeOptions() {
            const stage = document.getElementById('packing-source-stage')?.value || 'Rolling';
            const sizeInput = document.getElementById('packing-size-search');
            const bagsInput = document.getElementById('packing-bags');
            if (!sizeInput) return;
            sizeInput.value = '';
            sizeInput.dataset.selectedSize = '';
            if (bagsInput) bagsInput.value = '';

            const stageInv = (appState.inventory && appState.inventory[stage]) || {};
            const options = Object.keys(stageInv).filter(key => (parseFloat(stageInv[key]) || 0) > 0)
                .map(key => {
                    const clean = unsanitizeKey(key);
                    let label = getSizeLabel(clean);
                    if (label === clean) {
                        const rawLabel = getSizeLabel(key);
                        if (rawLabel !== key) label = rawLabel;
                    }
                    return `<option value="${label}"></option>`;
                }).join('');
            const datalist = document.getElementById('packingSizeStageOptions');
            if (datalist) datalist.innerHTML = options;
        }

        function handlePackingSizeInput(value) {
            const stage = document.getElementById('packing-source-stage')?.value || 'Rolling';
            const sizeInput = document.getElementById('packing-size-search');
            const bagsInput = document.getElementById('packing-bags');
            const stageInv = (appState.inventory && appState.inventory[stage]) || {};
            const foundKey = Object.keys(stageInv).find(k => {
                const clean = unsanitizeKey(k);
                let label = getSizeLabel(clean);
                if (label === clean) {
                    const rawLabel = getSizeLabel(k);
                    if (rawLabel !== k) label = rawLabel;
                }
                return label.toLowerCase() === value.toLowerCase();
            });
            if (foundKey) {
                sizeInput.dataset.selectedSize = foundKey;
                if (bagsInput) {
                    const available = parseFloat(stageInv[foundKey]) || 0;
                    bagsInput.max = available || '';
                    if (available > 0) {
                        bagsInput.placeholder = `Max ${available}`;
                    }
                }
            } else {
                sizeInput.dataset.selectedSize = '';
                if (bagsInput) {
                    bagsInput.max = '';
                    bagsInput.placeholder = 'Qty';
                }
            }
        }

        function extractSizeFromInput(inputValue) {
            // Extract size name from "SizeName - Description" format
            if (inputValue && inputValue.includes(' - ')) {
                return inputValue.split(' - ')[0].trim();
            }
            return inputValue ? inputValue.trim() : '';
        }

        function clearPackingForm() {
            const searchInput = document.getElementById('packing-size-search');
            searchInput.value = '';
            searchInput.dataset.selectedSize = '';
            document.getElementById('packing-bags').value = '';
            document.getElementById('packing-remarks').value = '';
            document.getElementById('packing-source-stage').selectedIndex = 0;
        }

        function moveInventoryToFinished(sourceStage, sizeId, bags, remarks) {
            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory[sourceStage]) appState.inventory[sourceStage] = {};
            const available = parseFloat(appState.inventory[sourceStage][sizeId]) || 0;
            if (available < bags) {
                throw new Error(`Not enough ${getSizeLabel(sizeId)} in ${INVENTORY_STAGE_LABELS[sourceStage] || sourceStage}. Available ${available}, needed ${bags}`);
            }

            appState.inventory[sourceStage][sizeId] = available - bags;
            if (appState.inventory[sourceStage][sizeId] <= 0) {
                delete appState.inventory[sourceStage][sizeId];
            }

            if (!appState.inventory['Finished Goods']) {
                appState.inventory['Finished Goods'] = {};
            }
            if (!appState.inventory['Finished Goods'][sizeId]) {
                appState.inventory['Finished Goods'][sizeId] = 0;
            }
            appState.inventory['Finished Goods'][sizeId] += bags;

            if (!appState.packingRemarks) appState.packingRemarks = {};
            if (!appState.packingRemarks['Finished Goods']) appState.packingRemarks['Finished Goods'] = {};
            if (!appState.packingRemarks['Finished Goods'][sizeId]) appState.packingRemarks['Finished Goods'][sizeId] = [];
            appState.packingRemarks['Finished Goods'][sizeId].push({
                bags,
                remarks: remarks || 'N/A',
                timestamp: new Date().toLocaleString()
            });
        }

        function appendPurchasedInventory(stageKey, sizeKey, bags) {
            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory[stageKey]) appState.inventory[stageKey] = {};
            const current = parseFloat(appState.inventory[stageKey][sizeKey]) || 0;
            appState.inventory[stageKey][sizeKey] = current + bags;
        }

        function packItems() {
            console.log('Packing items...');

            const searchInput = document.getElementById('packing-size-search');
            const datasetSizeId = searchInput.dataset.selectedSize || '';
            const fallbackLabel = extractSizeFromInput(searchInput.value);
            let sizeRecord = null;

            if (datasetSizeId) {
                sizeRecord = (appState.sizes && appState.sizes.list ? appState.sizes.list : []).find(s => s.id === datasetSizeId) || findSizeByLabel(datasetSizeId);
            }
            if (!sizeRecord && fallbackLabel) {
                sizeRecord = findSizeByLabel(fallbackLabel);
            }

            const sourceStage = document.getElementById('packing-source-stage').value;
            const bags = parseInt(document.getElementById('packing-bags').value);
            const remarks = document.getElementById('packing-remarks').value.trim();

            if (!sizeRecord) {
                alert(' Please select a valid size from the list.');
                return;
            }

            const selectedSizeId = sizeRecord.id || resolveSizeIdFromAny({ sizeId: fallbackLabel }, fallbackLabel);
            const selectedSizeLabel = sizeRecord.label || getSizeLabel(selectedSizeId) || fallbackLabel;
            // Use sizeId directly, no more sizeKey
            searchInput.dataset.selectedSize = selectedSizeId;

            console.log('Packing data:', { selectedSizeId, sourceStage, bags });

            // Validate inputs
            if (!sourceStage) {
                alert(' Please select a source stage.');
                return;
            }

            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid number of bags (positive integer).');
                return;
            }

            // Check if source stage has sufficient inventory
            if (!appState.inventory[sourceStage]) {
                appState.inventory[sourceStage] = {};
            }
            const availableBags = (appState.inventory[sourceStage][selectedSizeId]) || 0;
            console.log(`Available in ${sourceStage}: ${availableBags} bags of ${selectedSizeLabel} `);

            if (availableBags < bags) {
                alert(` Not enough ${selectedSizeLabel} in ${sourceStage}.Available: ${availableBags} bags, Requested: ${bags} bags`);
                return;
            }

            try {
                moveInventoryToFinished(sourceStage, selectedSizeId, bags, remarks);

                // Persist inventory transfer to Firebase
                fbPut('appState', 'appState', appState);

                console.log('Inventory updated successfully');

                // Clear form
                clearPackingForm();

                // Refresh displays immediately
                renderFinishedGoodsList();
                if (document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }

                // Show success message
                const stageLabel = INVENTORY_STAGE_LABELS[sourceStage] || sourceStage;
                recordActionLog('Packing Entry Saved', `Recorded packing for size ${selectedSizeLabel}`, {
                    entityType: 'packing',
                    sizeId: selectedSizeId,
                    sizeName: selectedSizeLabel,
                    qty: bags,
                    bags,
                    fromStage: sourceStage,
                    toStage: 'Finished Goods',
                    remarks
                });
                alert(` Successfully packed ${bags} bags of ${selectedSizeLabel} to Finished Goods`);

            } catch (error) {
                console.error('Packing error:', error);
                alert(` Error during packing: ${error.message} `);
            }
        }

        function renderFinishedGoodsList() {
            const container = document.getElementById('finished-goods-list');
            if (!container) return;

            if (!appState.inventory) appState.inventory = {};
            if (!appState.inventory['Finished Goods']) appState.inventory['Finished Goods'] = {};

            // Legacy migration logic removed. We rely on runInventoryCleanup now.

            const finishedGoods = appState.inventory['Finished Goods'] || {};
            const totalSpan = document.getElementById('total-finished-goods');

            const items = Object.entries(finishedGoods)
                .filter(([_, item]) => {
                    const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                    return qty > 0;
                })
                .sort(([a], [b]) => {
                    const getL = (k) => {
                        const clean = unsanitizeKey(k);
                        let l = getSizeLabel(clean);
                        if (l === clean) {
                            const rl = getSizeLabel(k);
                            if (rl !== k) l = rl;
                        }
                        return l;
                    };
                    return getL(a).localeCompare(getL(b));
                });

            if (items.length === 0) {
                container.innerHTML = '<div style="color: var(--color-text-secondary); font-style: italic; text-align: center; padding: var(--space-16);">No finished goods inventory</div>';
            } else {
                container.innerHTML = items.map(([sizeId, item]) => {
                    const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                    const clean = unsanitizeKey(sizeId);
                    let label = getSizeLabel(clean);
                    if (label === clean) {
                        const rawLabel = getSizeLabel(sizeId);
                        if (rawLabel !== sizeId) label = rawLabel;
                    }
                    const remarks = (appState.packingRemarks && appState.packingRemarks['Finished Goods'] && appState.packingRemarks['Finished Goods'][sizeId]) || [];
                    const latestRemark = remarks.length > 0 ? remarks[remarks.length - 1].remarks : 'No remarks recorded'; // Default if no remarks
                    return `
            <div class="inventory-item" style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-12); padding: 8px 0; border-bottom: 1px dashed var(--color-border-light);">
                <div style="flex: 1;">
                    <span class="inventory-size" style="font-weight: 600; color: var(--text-primary);">${label}</span><br>
                    <span style="font-size: 0.85em; color: var(--text-secondary);">Remarks: ${latestRemark}</span>
                </div>
                <span class="inventory-bags" style="font-weight: 700; color: var(--color-primary);">${qty} bags</span>
            </div>
            `;
                }).join('');
            }

            if (totalSpan) {
                const totalBags = Object.values(finishedGoods).reduce((sum, item) => {
                    const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                    return sum + qty;
                }, 0);
                totalSpan.textContent = totalBags;
            }
        }
        function renderPendingOrders() {
            const container = document.getElementById('pending-orders-list');
            if (!container) return;
            container.innerHTML = '<div style="color: #999;">Loading pending orders...</div>';

            const buildTable = (quotes, customers) => {
                const customerMap = {};
                (customers || []).forEach(c => customerMap[c.id] = c.display_name || c.name || c.id);
                const rows = [];

                quotes.forEach(q => {
                    const pendingLines = (q.lines || []).map((line, idx) => ({ line, idx })).filter(item => item.line && item.line.status !== 'done');
                    if (!pendingLines.length) return;
                    const span = pendingLines.length;
                    pendingLines.forEach(({ line, idx: originalIdx }, idx) => {
                        const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                        const stageLabel = INVENTORY_STAGE_LABELS[line.stage] || line.stage || '';
                        const sizeId = resolveSizeIdFromAny(line);
                        const priorityVal = line.priority || '';
                        const remarkVal = line.remarks || '';
                        const priorityDisplay = priorityVal
                            ? `<span style="display:inline-flex; min-width:32px; justify-content:center; padding:2px 6px; border-radius:999px; background:rgba(212,175,55,0.15); color:var(--text-primary); font-weight:600;">${priorityVal}</span>`
                            : `<span style="color:#888; font-size:0.85em;">-</span>`;
                        const actionCell = idx === 0 ? `<td rowspan="${span}" style="vertical-align: middle;"><button class="success" style="padding:6px 12px;" onclick="markQuoteDone('${q.id}')">Done</button></td>` : '';
                        rows.push(`
                            <tr>
                                <td>${customerMap[q.customer_id] || q.customer_id || 'Customer'}</td>
                                <td>${stageLabel}</td>
                                <td>${(() => {
                                const clean = unsanitizeKey(sizeId);
                                let l = getSizeLabel(clean);
                                if (l === clean) {
                                    const rl = getSizeLabel(sizeId);
                                    if (rl !== sizeId) l = rl;
                                }
                                // Fallback to line.size if lookup failed and it looks like a label
                                if (l === clean && line.size && line.size !== sizeId) return line.size;
                                return l;
                            })()}</td>
                                <td>${qtyDisplay || ''}</td>
                                <td>${qtyDisplay || ''}</td>
                                <td>${bagsDisplay || ''}</td>
                                <td>
                                    <input type="text" id="pending-remark-${q.id}-${originalIdx}" value="${remarkVal}" placeholder="Remarks" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                                </td>
                                <td style="width:60px; text-align:center;">${priorityDisplay}</td>
                                ${actionCell}
                            </tr>
                        `);
                    });
                });

                if (!rows.length) {
                    container.innerHTML = '<div style="color: #555; font-style: italic;">No pending orders</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="line-items-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Stage</th>
                                <th>Item</th>
                                <th>Total Qty</th>
                                <th>Bags Used</th>
                                <th>Remarks</th>
                                <th style="width:60px;">Priority</th>
                                <th>Done</th>
                            </tr>
                        </thead>
                        <tbody>${rows.join('')}</tbody>
                    </table>
                `;
            };

            // render immediately from cache if present
            if (cachedQuotes.length) {
                buildTable(cachedQuotes, cachedCustomers);
            }

            Promise.all([fbGetAll('quotes'), fbGetAll('customers')]).then(([quotes, customers]) => {
                cachedQuotes = quotes;
                cachedCustomers = customers;
                buildTable(quotes, customers);
            }).catch(() => {
                if (cachedQuotes.length) {
                    buildTable(cachedQuotes, cachedCustomers);
                } else {
                    container.innerHTML = '<div style="color: #f99;">Error loading pending orders</div>';
                }
            });
        }

        // ===== QUOTES =====
        function getQuoteLineDisplays(line) {
            const unit = line.unit || '';
            const factor = parseFloat(line.factor) || 0;
            const peti = parseFloat(line.qty) || 0;
            const bagsUsed = parseFloat(line.totalUsedBags) || 0;

            const totalQty = (peti && factor) ? peti * factor : 0;

            let qtyDisplay = '';
            if (totalQty && unit) {
                qtyDisplay = `${totalQty} ${unit}`;
                if (factor && peti) {
                    qtyDisplay += ` (${factor} per PETI  ${peti} PETI)`;
                }
            } else if (peti) {
                qtyDisplay = `${peti} PETI`;
            } else {
                qtyDisplay = line.totalQtyDisplay || '';
            }

            let bagsDisplay = '';
            if (bagsUsed) {
                bagsDisplay = `${bagsUsed} bag(s)`;
            }

            return { qtyDisplay, bagsDisplay };
        }

        function getStageInventory(stage) {
            return (appState.inventory && appState.inventory[stage]) || {};
        }

        function updateQuoteSizeOptions() {
            const stage = document.getElementById('quoteStage')?.value || 'Rolling';
            const stageInv = getStageInventory(stage);
            const datalist = document.getElementById('quoteSizeOptions');
            if (!datalist) return;
            const options = Object.keys(stageInv)
                .filter(key => (parseFloat(stageInv[key]) || 0) > 0)
                .map(key => `<option value="${getSizeLabel(unsanitizeKey(key))}"></option>`)
                .join('');
            datalist.innerHTML = options;

            // reset selected size/qty hints
            const sizeInput = document.getElementById('quoteSize');
            const qtyInput = document.getElementById('quoteQty');
            if (sizeInput) {
                sizeInput.value = '';
                sizeInput.dataset.selectedSize = '';
            }
            if (qtyInput) {
                qtyInput.value = '';
                qtyInput.max = '';
                qtyInput.placeholder = 'Bags from inventory';
            }
        }

        function handleQuoteSizeInput(val) {
            const stage = document.getElementById('quoteStage')?.value || 'Rolling';
            const sizeInput = document.getElementById('quoteSize');
            const qtyInput = document.getElementById('quoteQty');
            const factorInput = document.getElementById('quoteBagFactor');
            const stageInv = getStageInventory(stage);
            const foundKey = Object.keys(stageInv).find(k => getSizeLabel(unsanitizeKey(k)).toLowerCase() === (val || '').toLowerCase());
            if (foundKey) {
                sizeInput.dataset.selectedSize = foundKey;
                const available = parseFloat(stageInv[foundKey]) || 0;
                if (qtyInput) {
                    qtyInput.max = available || '';
                    qtyInput.placeholder = available ? `Bags from inventory (Max ${available})` : 'Bags from inventory';
                }
                if (factorInput) {
                    factorInput.value = '';
                }
            } else {
                sizeInput.dataset.selectedSize = '';
                if (qtyInput) {
                    qtyInput.max = '';
                    qtyInput.placeholder = 'Bags from inventory';
                }
                if (factorInput) factorInput.value = '';
            }
        }

        function renderQuoteLines() {
            const tbody = document.getElementById('quoteLineItems');
            if (!tbody) return;
            tbody.innerHTML = '';
            quoteLines.forEach((line, idx) => {
                const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${getSizeLabel(unsanitizeKey(line.sizeId))}</td>
                    <td>${line.unit}${line.factor ? ` (${line.factor} per bag)` : ''}</td>
                    <td>${line.qty}</td>
                    <td>${INVENTORY_STAGE_LABELS[line.stage] || line.stage}</td>
                    <td>${bagsDisplay || ''}</td>
                    <td>${qtyDisplay || ''}</td>
                    <td><button type="button" class="danger" onclick="removeQuoteLine(${idx})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeQuoteLine(idx) {
            quoteLines.splice(idx, 1);
            renderQuoteLines();
        }

        function addQuoteLine() {
            const stage = document.getElementById('quoteStage')?.value || '';
            const sizeInput = document.getElementById('quoteSize');
            const unit = document.getElementById('quoteUnit')?.value || 'KG';
            const peti = parseFloat(document.getElementById('quotePeti')?.value || '0');
            const bagsFromInventory = parseFloat(document.getElementById('quoteQty')?.value || '0');
            const factor = parseFloat(document.getElementById('quoteBagFactor')?.value || '0');

            if (!stage) {
                alert('Select a stage.');
                return;
            }
            const sizeLabel = (sizeInput?.value || '').trim();
            if (!sizeLabel) {
                alert('Select a size from the list.');
                return;
            }
            const stageInv = getStageInventory(stage);
            const sizeKey = sizeInput.dataset.selectedSize || Object.keys(stageInv).find(k => getSizeLabel(k).toLowerCase() === sizeLabel.toLowerCase());
            if (!sizeKey) {
                alert('Please choose a size that exists in this stage inventory.');
                return;
            }
            const availableBags = parseFloat(stageInv[sizeKey]) || 0;

            if (!factor || factor <= 0) {
                alert('Enter valid bag factor / count (per PETI).');
                return;
            }
            if (!peti || peti <= 0) {
                alert('Enter valid number of PETI.');
                return;
            }
            if (!bagsFromInventory || bagsFromInventory <= 0) {
                alert('Enter valid bags from inventory.');
                return;
            }

            if (bagsFromInventory > availableBags) {
                alert(`Only ${availableBags} bags available in ${INVENTORY_STAGE_LABELS[stage] || stage}.`);
                return;
            }

            const totalQty = peti * factor;
            const totalQtyDisplay = `${totalQty} ${unit} (${factor} per PETI  ${peti} PETI)`;

            quoteLines.push({
                stage,
                sizeId: sizeKey,
                unit,
                qty: peti,
                factor: factor || null,
                availableBags,
                totalUsedBags: bagsFromInventory,
                totalQtyDisplay
            });
            renderQuoteLines();

            // Clear only PETI and Qty
            const petiInput = document.getElementById('quotePeti');
            if (petiInput) petiInput.value = '';
            const qtyInput = document.getElementById('quoteQty');
            if (qtyInput) qtyInput.value = '';
        }

        async function saveQuote() {
            const date = document.getElementById('quoteDate')?.value || getToday();
            const custId = document.getElementById('quoteCustomerId')?.value;
            if (!custId) { alert('Select a customer.'); return; }
            if (!quoteLines.length) { alert('Add at least one line.'); return; }
            const id = editingQuoteId || ('Q_' + Date.now());
            const record = {
                id,
                date,
                customer_id: custId,
                lines: quoteLines.map(l => ({ ...l }))
            };

            // Inventory Deduction for NEW quotes only
            if (!editingQuoteId) {
                if (!appState.inventory) appState.inventory = {};
                const requirements = {};

                // 1. Aggregate requirements
                record.lines.forEach(line => {
                    if (!line) return;
                    const stageKey = normalizeStageKey(line.stage || 'Rolling');
                    const sizeKey = getInventorySizeKey(line.sizeId || '');

                    let bagsUsed = parseFloat(line.totalUsedBags) || 0;

                    // Fallback for very old quotes (shouldn't happen for new ones, but safe)
                    if (!bagsUsed) {
                        const peti = parseFloat(line.qty) || 0;
                        const factor = parseFloat(line.factor) || 0;
                        if (line.unit === 'Bags' || !line.unit) {
                            bagsUsed = peti;
                        } else {
                            bagsUsed = Math.ceil(peti / (factor || 1));
                        }
                    }

                    if (!bagsUsed || bagsUsed <= 0) return;

                    if (!requirements[stageKey]) requirements[stageKey] = {};
                    requirements[stageKey][sizeKey] = (requirements[stageKey][sizeKey] || 0) + bagsUsed;
                });

                // 2. Validate availability
                Object.entries(requirements).forEach(([stageKey, sizes]) => {
                    const stageInventory = (appState.inventory && appState.inventory[stageKey]) || {};
                    Object.entries(sizes).forEach(([sizeKey, needed]) => {
                        const available = parseFloat(stageInventory[sizeKey]) || 0;
                        if (available < needed) {
                            const stageLabel = INVENTORY_STAGE_LABELS[stageKey] || stageKey;
                            throw new Error(`Not enough ${getSizeLabel(sizeKey)} in ${stageLabel}. Available ${available}, needed ${needed}`);
                        }
                    });
                });

                // 3. Deduct from inventory
                Object.entries(requirements).forEach(([stageKey, sizes]) => {
                    if (!appState.inventory[stageKey]) appState.inventory[stageKey] = {};
                    Object.entries(sizes).forEach(([sizeKey, needed]) => {
                        const available = parseFloat(appState.inventory[stageKey][sizeKey]) || 0;
                        const updated = available - needed;
                        if (updated > 0) {
                            appState.inventory[stageKey][sizeKey] = updated;
                        } else {
                            delete appState.inventory[stageKey][sizeKey];
                        }
                    });
                });

                // 4. Persist inventory update
                await fbPut('appState', 'appState', appState);
            }
            await fbPut('quotes', id, record);
            alert(editingQuoteId ? ' Quote updated' : ' Quote saved');
            // update local cache instantly
            cachedQuotes = cachedQuotes.filter(q => q.id !== id).concat([record]);
            localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));
            renderQuotesTable(cachedQuotes, cachedCustomers.length ? cachedCustomers : (appState.customers || []));
            renderPendingOrders();
            recordActionLog('Quote Saved', `${editingQuoteId ? 'Updated' : 'Created'} quote ${id}`, {
                quoteId: id,
                customerId: custId,
                lines: quoteLines.length
            });
            clearQuoteForm();
            refreshQuotesList(); // async refresh to pull latest
        }

        function clearQuoteForm() {
            const dateEl = document.getElementById('quoteDate');
            if (dateEl) dateEl.value = getToday();
            const custEl = document.getElementById('quoteCustomer');
            if (custEl) custEl.value = '';
            const custIdEl = document.getElementById('quoteCustomerId');
            if (custIdEl) custIdEl.value = '';
            const sizeEl = document.getElementById('quoteSize');
            if (sizeEl) { sizeEl.value = ''; sizeEl.dataset.selectedSize = ''; }
            const qtyEl = document.getElementById('quoteQty');
            if (qtyEl) { qtyEl.value = ''; qtyEl.max = ''; qtyEl.placeholder = 'Bags from inventory'; }
            const petiEl = document.getElementById('quotePeti');
            if (petiEl) petiEl.value = '';
            const factorEl = document.getElementById('quoteBagFactor');
            if (factorEl) factorEl.value = '';
            const unitEl = document.getElementById('quoteUnit');
            if (unitEl) unitEl.value = 'KG';

            quoteLines = [];
            editingQuoteId = null;
            renderQuoteLines();
        }

        function renderQuotesTable(quotes = [], customers = []) {
            const tbody = document.querySelector('#quotesTable tbody');
            if (!tbody) return;
            const customerMap = {};
            customers.forEach(c => customerMap[c.id] = c.display_name || c.name || c.id);
            tbody.innerHTML = '';

            quotes.forEach(q => {
                const lines = (q.lines && q.lines.length) ? q.lines : [{}];
                const rowSpan = lines.length || 1;

                lines.forEach((line, idx) => {
                    const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                    const stageLabel = INVENTORY_STAGE_LABELS[line.stage] || line.stage || '';
                    const priorityVal = line.priority || '';
                    const actionCell = idx === 0 ? `
                        <td rowspan="${rowSpan}" style="vertical-align: middle;">
                            <button type="button" onclick="viewQuote('${q.id}')">View</button>
                            <button type="button" onclick="editQuote('${q.id}')">Edit</button>
                            <button type="button" class="danger" onclick="deleteQuote('${q.id}')">Delete</button>
                        </td>` : '';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${q.date || ''}</td>
                        <td>${customerMap[q.customer_id] || q.customer_id || ''}</td>
                        <td>${stageLabel}</td>
                        <td>${getSizeLabel(unsanitizeKey(line.sizeId))}</td>
                        <td>${line.qty || ''}</td>
                        <td>${qtyDisplay || ''}</td>
                        <td>${bagsDisplay || ''}</td>
                        <td><input type="number" min="1" style="width:60px;" value="${priorityVal}" onchange="updateQuotePriority('${q.id}', ${idx}, this.value)"></td>
                        <td>${line.status === 'done' ? ' Done' : 'Pending'}</td>
                        <td>${line.remarks || ''}</td>
                        ${actionCell}
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function refreshQuotesList() {
            // First render quickly from cache if present
            if (cachedQuotes.length) {
                renderQuotesTable(cachedQuotes, cachedCustomers.length ? cachedCustomers : (appState.customers || []));
            }

            let quotes = [];
            let customers = [];
            if (!isConnected) {
                try {
                    const qCache = localStorage.getItem('quotesCache');
                    const cCache = localStorage.getItem('customersCache');
                    if (qCache) quotes = JSON.parse(qCache);
                    if (cCache) customers = JSON.parse(cCache);
                } catch (err) {
                    console.warn('Offline and no cached quotes/customers available', err);
                }
            } else {
                try {
                    quotes = await fbGetAll('quotes');
                    customers = await fbGetAll('customers');
                    cachedQuotes = quotes;
                    cachedCustomers = customers;
                    localStorage.setItem('quotesCache', JSON.stringify(quotes));
                    localStorage.setItem('customersCache', JSON.stringify(customers));
                } catch (e) {
                    console.error('Error loading quotes', e);
                    try {
                        const qCache = localStorage.getItem('quotesCache');
                        const cCache = localStorage.getItem('customersCache');
                        if (qCache) quotes = JSON.parse(qCache);
                        if (cCache) customers = JSON.parse(cCache);
                    } catch (err) {
                        console.warn('No cached quotes/customers available', err);
                    }
                }
            }

            renderQuotesTable(quotes, customers);
            renderPendingOrders();
        }

        async function viewQuote(id) {
            const modal = document.getElementById('viewQuoteModal');
            const content = document.getElementById('quoteContent');
            if (!modal || !content) return;
            const record = await fbGet('quotes', id);
            if (!record) return;
            let customers = cachedCustomers;
            try { customers = await fbGetAll('customers'); } catch (e) { /* fallback to cached */ }
            const cust = (customers || []).find(c => c.id === record.customer_id);
            const linesHtml = (record.lines || []).map((line, idx) => {
                const { qtyDisplay, bagsDisplay } = getQuoteLineDisplays(line);
                const getL = (k) => {
                    const clean = unsanitizeKey(k);
                    let l = getSizeLabel(clean);
                    if (l === clean) {
                        const rl = getSizeLabel(k);
                        if (rl !== k) l = rl;
                    }
                    if (l === clean && line.size && line.size !== k) return line.size;
                    return l;
                };
                return `<li>#${idx + 1} ${getL(line.sizeId)}  ${qtyDisplay || ''}  ${INVENTORY_STAGE_LABELS[line.stage] || line.stage}  ${bagsDisplay || ''} ${line.status === 'done' ? '' : ''} ${line.remarks ? '  ' + line.remarks : ''}</li>`;
            }).join('');
            content.innerHTML = `
                <p><strong>Date:</strong> ${record.date || ''}</p>
                <p><strong>Customer:</strong> ${cust ? cust.display_name : record.customer_id}</p>
                <ul>${linesHtml}</ul>
            `;
            openModal('viewQuoteModal');
        }

        async function editQuote(id) {
            try {
                const record = await fbGet('quotes', id);
                if (!record) return;
                editingQuoteId = id;
                quoteLines = (record.lines || []).map(l => ({ ...l }));
                const dateEl = document.getElementById('quoteDate');
                if (dateEl) dateEl.value = record.date || getToday();

                // populate customer
                const customers = cachedCustomers.length ? cachedCustomers : appState.customers || [];
                const cust = customers.find(c => c.id === record.customer_id);
                const custInput = document.getElementById('quoteCustomer');
                const custIdInput = document.getElementById('quoteCustomerId');
                if (custInput) custInput.value = cust ? (cust.display_name || cust.name || '') : record.customer_id;
                if (custIdInput) custIdInput.value = record.customer_id || '';

                // set stage dropdown to first line for convenience
                const stageSelect = document.getElementById('quoteStage');
                if (stageSelect && record.lines && record.lines[0] && record.lines[0].stage) {
                    stageSelect.value = record.lines[0].stage;
                }

                renderQuoteLines();

                const createTabBtn = document.querySelector('button.subtab-btn[onclick*=\"sales-quote-create\"]');
                if (createTabBtn && typeof switchSalesSubtab === 'function') {
                    switchSalesSubtab('sales-quote-create', createTabBtn);
                }
            } catch (err) {
                console.error('Error editing quote', err);
            }
        }

        async function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;
            try {
                await fbDelete('quotes', id);
                cachedQuotes = cachedQuotes.filter(q => q.id !== id);
                localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));
                renderQuotesTable(cachedQuotes, cachedCustomers);
                renderPendingOrders();
                refreshQuotesList();
                recordActionLog('Quote Deleted', `Deleted quote ${id}`, { quoteId: id });
            } catch (err) {
                console.error('Error deleting quote', err);
                alert('Unable to delete quote right now.');
            }
        }

        async function updateQuotePriority(id, idx, value) {
            const record = await fbGet('quotes', id);
            if (!record || !record.lines || !record.lines[idx]) return;
            const cleanVal = value === '' ? '' : (parseInt(value, 10) || value);
            record.lines[idx].priority = cleanVal;
            await fbPut('quotes', id, record);
            refreshQuotesList();
            renderPendingOrders();
        }

        async function markQuoteDone(id) {
            const record = await fbGet('quotes', id);
            if (!record || !Array.isArray(record.lines)) return;

            try {
                const pendingLineRefs = record.lines
                    .map((line, idx) => ({ line, idx }))
                    .filter(item => item.line && item.line.status !== 'done');

                if (!pendingLineRefs.length) {
                    alert('This quote is already completed.');
                    renderPendingOrders();
                    return;
                }

                if (!appState.inventory) appState.inventory = {};
                if (!appState.inventory['Finished Goods']) {
                    appState.inventory['Finished Goods'] = {};
                }
                if (!appState.packingRemarks) appState.packingRemarks = {};
                if (!appState.packingRemarks['Finished Goods']) {
                    appState.packingRemarks['Finished Goods'] = {};
                }

                pendingLineRefs.forEach(({ line, idx }) => {
                    const remarkInput = document.getElementById(`pending-remark-${id}-${idx}`);
                    const remarkVal = remarkInput ? remarkInput.value.trim() : (line.remarks || '');

                    const sizeKey = getInventorySizeKey(line.sizeId || '');
                    const peti = parseFloat(line.qty) || 0;

                    if (!peti || peti <= 0) {
                        throw new Error(`Invalid PETI quantity for ${getSizeLabel(sizeKey)}`);
                    }

                    // 1 Add PETI to Finished Goods
                    const currentFG = parseFloat(appState.inventory['Finished Goods'][sizeKey]) || 0;
                    appState.inventory['Finished Goods'][sizeKey] = currentFG + peti;

                    // 2 Add packing remark entry
                    if (!appState.packingRemarks['Finished Goods'][sizeKey]) {
                        appState.packingRemarks['Finished Goods'][sizeKey] = [];
                    }
                    appState.packingRemarks['Finished Goods'][sizeKey].push({
                        bags: peti, // "bags" label, but quantity = PETI count
                        remarks: remarkVal || 'N/A',
                        timestamp: new Date().toLocaleString()
                    });

                    // 3 Update line status in quote
                    record.lines[idx] = {
                        ...line,
                        status: 'done',
                        remarks: remarkVal
                        // keep line.totalUsedBags as recorded when quote was saved
                    };
                });

                // Save updated quote and appState
                await fbPut('quotes', id, record);
                await fbPut('appState', 'appState', appState);

                // Update caches
                cachedQuotes = cachedQuotes.map(q => q.id === id ? record : q);
                localStorage.setItem('quotesCache', JSON.stringify(cachedQuotes));

                // Refresh UI
                renderQuotesTable(cachedQuotes, cachedCustomers.length ? cachedCustomers : (appState.customers || []));
                renderPendingOrders();
                renderFinishedGoodsList();
                if (document.getElementById('inventory') && document.getElementById('inventory').classList.contains('active')) {
                    renderInventoryTab();
                }
                refreshQuotesList();

                recordActionLog('Quote Fulfilled', `Completed quote ${id}`, {
                    quoteId: id,
                    lines: pendingLineRefs.map(({ line }) => ({
                        size: getSizeLabel(line.sizeId),
                        stage: INVENTORY_STAGE_LABELS[line.stage] || line.stage,
                        qty: line.qty,
                        unit: line.unit
                    }))
                });
                alert(' Quote packed and moved to Finished Goods.');
            } catch (err) {
                console.error('Error completing quote', err);
                alert(` ${err.message}`);
            }
        }

        function filterQuotes(term) {
            const searchValue = (term || '').toLowerCase().trim();
            const rows = document.querySelectorAll('#quotesTable tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = searchValue && !text.includes(searchValue) ? 'none' : '';
            });
        }

        function filterQuotes(term) {
            const searchValue = (term || '').toLowerCase().trim();
            const rows = document.querySelectorAll('#quotesTable tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = searchValue && !text.includes(searchValue) ? 'none' : '';
            });
        }

        // Render Inventory Tab
        function renderInventoryTab() {
            const container = document.getElementById('inventory-grid');
            if (!container) return;
            container.innerHTML = '';

            if (!appState.inventory) appState.inventory = {};
            ensureDefaultInventoryStages();

            INVENTORY_STAGES.forEach(stage => {
                if (!appState.inventory[stage]) {
                    appState.inventory[stage] = {};
                }

                const stageInventory = appState.inventory[stage];
                const totalBags = Object.values(stageInventory).reduce((sum, item) => {
                    const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                    return sum + qty;
                }, 0);

                const safeStage = stage; // No need to replace quotes if we use clean IDs/labels
                const entriesHtml = Object.entries(stageInventory)
                    .filter(([sizeId, item]) => {
                        const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
                        return qty > 0;
                    })
                    .map(([sizeKey, item]) => {
                        const qty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;

                        // Convert sanitized inventory key back to clean sizeId for label lookup
                        const cleanSizeId = unsanitizeKey(sizeKey);
                        const label = getSizeLabel(cleanSizeId);

                        return `
            <div class="inventory-size-row">
                <div>
                    <p class="inventory-size-name">${label}</p>
                    <span class="inventory-size-count">${qty} bags</span>
                </div>
                <div class="inventory-qty-actions">
                    <button class="inventory-qty-btn inventory-qty-btn--add" onclick="editInventory('${safeStage}', '${sizeKey}', 'add')">+</button>
                    <button class="inventory-qty-btn inventory-qty-btn--remove" onclick="editInventory('${safeStage}', '${sizeKey}', 'remove')"></button>
                </div>
            </div>
        `;
                    }).join('') || '<div class="inventory-size-row inventory-size-row--empty">No inventory</div>';

                const stageId = stage.replace(/\s+/g, '-');

                const stageCard = document.createElement('div');
                stageCard.className = 'inventory-stage-card';
                const safeStageName = safeStage;
                const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                stageCard.innerHTML = `
                    <div class="inventory-stage-header">
                        <div>
                            <p class="inventory-stage-title">${stageLabel}</p>
                            <span class="inventory-stage-meta">${totalBags} bags</span>
                        </div>
                    </div>
                    <div class="inventory-size-list">
                        ${entriesHtml}
                    </div>
                    <div class="inventory-stage-add">
                        <h4>Add New Inventory to ${stageLabel}</h4>
                        <div class="inventory-stage-add-form">
                            <input type="text" list="sizeOptionsList" id="add-size-${stageId}" placeholder="Start typing size">
                            <input type="number" id="add-bags-${stageId}" placeholder="Bags" min="1">
                            <button onclick="addToInventory('${safeStageName}')">Add</button>
                        </div>
                    </div>
                `;
                container.appendChild(stageCard);
            });
        }

        // Filter inventory by size search
        function filterInventoryBySize(searchTerm) {
            const searchValue = searchTerm.toLowerCase().trim();
            const container = document.getElementById('inventory-grid');
            const searchInfo = document.getElementById('inventory-search-info');

            if (!searchValue) {
                // Clear search - show all
                renderInventoryTab();
                if (searchInfo) searchInfo.style.display = 'none';
                return;
            }

            container.innerHTML = '';
            let totalFoundBags = 0;

            // Search across all stages
            Object.keys(appState.inventory).forEach(stage => {
                let inventoryHTML = '';
                let stageTotalBags = 0;
                let stageHasItems = false;

                // For each size in this stage
                Object.entries(appState.inventory[stage]).forEach(([size, totalBags]) => {
                    const label = getSizeLabel(size);
                    // Check if size matches search term
                    if (label.toLowerCase().includes(searchValue) && totalBags > 0) {
                        stageHasItems = true;

                        // Special handling for Finished Goods - show individual bags
                        if (stage === 'Finished Goods') {
                            const remarks = appState.packingRemarks && appState.packingRemarks['Finished Goods'] || {};
                            const sizeRemarks = remarks[size] || [];

                            // Show bags with remarks
                            sizeRemarks.forEach((bagData, index) => {
                                const remark = bagData.remarks || 'No remarks';
                                const timestamp = bagData.timestamp || 'N/A';
                                inventoryHTML += `
                    <div class="inventory-item" style = "display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border-bottom: 1px solid #eee; background: #f0f9ff; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #2da3b8;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: var(--color-primary); margin-bottom: 4px;">Bag #${totalFoundBags + 1} - ${label}</div>
                                            <div style="font-size: 13px; color: #666; margin-bottom: 3px;">Packets: ${remark}</div>
                                            <div style="font-size: 11px; color: #999;">${timestamp}</div>
                                        </div>
                                        <span class="inventory-bags" style="padding: 6px 12px; background: #e3f2fd; border-radius: 4px; font-weight: bold; white-space: nowrap; margin-left: 10px;">1 bag</span>
                                    </div>
                    `;
                                totalFoundBags++;
                                stageTotalBags++;
                            });

                            // Show bags without remarks
                            const bagsWithoutRemarks = totalBags - sizeRemarks.length;
                            if (bagsWithoutRemarks > 0) {
                                for (let i = 0; i < bagsWithoutRemarks; i++) {
                                    inventoryHTML += `
                    <div class="inventory-item" style = "display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border-bottom: 1px solid #eee; border-radius: 4px; margin-bottom: 8px;">
                                            <div style="flex: 1;">
                                            <div>Bag #${totalFoundBags + 1} - ${label}</div>
                                                <div style="font-size: 13px; color: #999; font-style: italic;">No remarks added</div>
                                                <div style="font-size: 11px; color: #bbb;">Pending remarks entry</div>
                                            </div>
                                            <span class="inventory-bags" style="padding: 6px 12px; background: #ffe0b2; border-radius: 4px; white-space: nowrap; margin-left: 10px;">1 bag</span>
                                        </div>
                    `;
                                    totalFoundBags++;
                                    stageTotalBags++;
                                }
                            }
                        } else {
                            // For other stages - show summary by size
                            inventoryHTML += `
                                <div class="inventory-size-row">
                                    <div>
                                        <p class="inventory-size-name">${label}</p>
                                        <span class="inventory-size-count">${totalBags} bags</span>
                                    </div>
                                </div>
                            `;
                            totalFoundBags += totalBags;
                            stageTotalBags += totalBags;
                        }
                    }
                });

                // Only add stage card if it has matching items
                if (stageHasItems) {
                    const stageCard = document.createElement('div');
                    stageCard.className = 'inventory-stage-card';
                    const stageLabel = INVENTORY_STAGE_LABELS[stage] || stage;
                    stageCard.innerHTML = `
                        <div class="inventory-stage-header">
                            <div>
                                <p class="inventory-stage-title">${stageLabel}</p>
                                <span class="inventory-stage-meta">${stageTotalBags} bags</span>
                            </div>
                        </div>
                        <div class="inventory-size-list">${inventoryHTML}</div>
                    `;
                    container.appendChild(stageCard);
                }
            });

            // Show search info
            if (searchInfo) {
                if (totalFoundBags > 0) {
                    searchInfo.innerHTML = `<strong> Found ${totalFoundBags} bags of "${searchTerm}" across all stages</strong> `;
                    searchInfo.style.display = 'block';
                } else {
                    searchInfo.innerHTML = `<strong style = "color: #f44336;"> No bags found for "${searchTerm}"</strong> `;
                    searchInfo.style.display = 'block';
                    container.innerHTML = '<div style="color: var(--color-text-secondary); font-style: italic; padding: var(--space-24); text-align: center;">No results found for this size</div>';
                }
            }
        }

        // Clear inventory search
        function clearInventorySearch() {
            const searchInput = document.getElementById('inventory-search');
            if (searchInput) {
                searchInput.value = '';
                filterInventoryBySize('');
            }
            const tableInput = document.getElementById('inventorySearchInput');
            if (tableInput) {
                tableInput.value = '';
            }
        }

        function editInventory(stage, sizeId, action) {
            if (!appState.inventory[stage]) appState.inventory[stage] = {};

            const sizeKey = sizeId;                    // keep original key for inventory access
            const cleanSizeId = unsanitizeKey(sizeKey);

            const item = appState.inventory[stage][sizeKey];
            const currentQty = (typeof item === 'object' ? item.qty : parseFloat(item)) || 0;
            const sizeLabel = getSizeLabel(cleanSizeId);

            let bags;
            if (action === 'add') {
                bags = parseInt(prompt(`How many bags of ${sizeLabel} to ADD to ${stage}?\nCurrent: ${currentQty} bags`, '1'));
                if (!bags || isNaN(bags) || bags <= 0) {
                    alert(' Please enter a valid positive number');
                    return;
                }

                const newQty = currentQty + bags;
                if (typeof item === 'object') {
                    appState.inventory[stage][sizeKey] = { ...item, qty: newQty, lastUpdatedAt: Date.now() };
                } else {
                    // Upgrade to object if it was a number, or just keep number if we want to be lazy?
                    // Let's upgrade to canonical object structure
                    appState.inventory[stage][sizeKey] = {
                        sizeId,
                        qty: newQty,
                        category: stage,
                        lastUpdatedAt: Date.now(),
                        source: 'manual_edit'
                    };
                }

                alert(` Added ${bags} bags of ${sizeLabel} to ${stage} \nNew total: ${newQty} bags`);
            } else if (action === 'remove') {
                bags = parseInt(prompt(`How many bags of ${sizeLabel} to REMOVE from ${stage}?\nCurrent: ${currentQty} bags`, '1'));
                if (!bags || isNaN(bags) || bags <= 0) {
                    alert(' Please enter a valid positive number');
                    return;
                }
                if (bags > currentQty) {
                    alert(` Cannot remove ${bags} bags.Only ${currentQty} bags available.`);
                    return;
                }

                const newQty = currentQty - bags;
                if (typeof item === 'object') {
                    appState.inventory[stage][sizeId] = { ...item, qty: newQty, lastUpdatedAt: Date.now() };
                } else {
                    appState.inventory[stage][sizeId] = {
                        sizeId,
                        qty: newQty,
                        category: stage,
                        lastUpdatedAt: Date.now(),
                        source: 'manual_edit'
                    };
                }

                alert(` Removed ${bags} bags of ${sizeLabel} from ${stage} \nRemaining: ${newQty} bags`);
            }

            // **REAL-TIME DB UPDATE**: Save changes to Firebase
            fbPut('appState', 'appState', appState);
            const actionLabel = action === 'add' ? 'Added' : 'Removed';
            recordActionLog('Inventory Update', `${actionLabel} ${bags} bags of ${sizeLabel} in ${stage}`, { stage, size: sizeLabel, bags, action });

            // Refresh display
            renderInventoryTab();
        }

        function addToInventory(stage) {
            const stageId = stage.replace(/\s+/g, '-');
            const sizeSelect = document.getElementById(`add-size-${stageId}`);
            const bagsInput = document.getElementById(`add-bags-${stageId}`);

            if (!sizeSelect || !bagsInput) {
                console.error('Add inventory inputs missing for stage', stage, stageId);
                alert('Unable to find the inputs for this stage. Please reload and try again.');
                return;
            }

            const sizeEntry = sizeSelect.value.trim();
            if (!sizeEntry) {
                alert(' Please select a size.');
                return;
            }
            const sizeMatch = findSizeByLabel(sizeEntry);
            const sizeId = sizeMatch ? sizeMatch.id : resolveSizeIdFromAny({ sizeId: sizeEntry }, sizeEntry);
            const sizeLabel = sizeMatch ? sizeMatch.label : sizeEntry;
            const bags = parseInt(bagsInput.value);

            if (!bags || isNaN(bags) || bags <= 0) {
                alert(' Please enter a valid positive number of bags');
                return;
            }

            if (!appState.inventory[stage]) {
                appState.inventory[stage] = {};
            }
            if (!appState.inventory[stage][sizeId]) {
                appState.inventory[stage][sizeId] = 0;
            }

            appState.inventory[stage][sizeId] += bags;

            // **REAL-TIME DB UPDATE**: Save changes to Firebase
            fbPut('appState', 'appState', appState);

            alert(` Added ${bags} bags of ${sizeLabel} to ${stage} \nNew total: ${appState.inventory[stage][sizeId]} bags`);
            recordActionLog('Inventory Adjusted', `Adjusted inventory for size ${sizeLabel} in ${stage}`, {
                entityType: 'inventory',
                sizeId,
                sizeName: sizeLabel,
                stage,
                deltaQty: bags,
                newQty: appState.inventory[stage][sizeId],
                reason: 'manual-adjustment'
            });

            // Clear input
            bagsInput.value = '';

            // Refresh display
            renderInventoryTab();
        }

    </script>


    <script>
        // Placeholder for new script content, e.g., initAdminInventoryTools function
        // The existing script content remains in the previous script block.
    </script>
</body>

</html>